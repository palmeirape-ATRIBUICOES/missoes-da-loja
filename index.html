<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missoes</title>

  <meta name="theme-color" content="#2563eb" />

  <link id="appIcon" rel="icon" type="image/svg+xml" href="" />
  <link id="appAppleIcon" rel="apple-touch-icon" href="" />
  <link id="appManifest" rel="manifest" href="" />

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-4xl mx-auto mb-4">
  <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between gap-3">
    <div class="min-w-0 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-blue-50 border border-blue-100 flex items-center justify-center shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-700" viewBox="0 0 24 24" fill="currentColor" aria-label="Logo">
          <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 .001-16.001A8 8 0 0 1 12 20zm0-14a6 6 0 1 0 .001 12.001A6 6 0 0 0 12 6zm0 10a4 4 0 1 1 .001-8.001A4 4 0 0 1 12 16zm0-6a2 2 0 1 0 .001 4.001A2 2 0 0 0 12 10z"/>
        </svg>
      </div>

      <div class="min-w-0">
        <div id="topTitle" class="text-xl font-bold truncate">Entrar</div>
        <div id="topSubtitle" class="text-sm text-gray-600 truncate">Login por PIN</div>
      </div>
    </div>

    <div id="topPointsBox" class="hidden items-center gap-2 bg-yellow-50 border border-yellow-200 rounded-lg px-3 py-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 17.27l5.18 3.04-1.39-5.99 4.64-4.02-6.12-.53L12 4l-2.31 5.77-6.12.53 4.64 4.02-1.39 5.99L12 17.27z"/>
      </svg>
      <div class="text-sm">
        <div class="font-semibold leading-4">Pontos do mês</div>
        <div class="text-lg font-bold leading-5"><span id="monthPointsTop">0</span></div>
      </div>
    </div>
  </div>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-4 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Loja</label>
      <select id="storeSelect" class="w-full border p-2 rounded">
        <option value="loja_principal">Loja Principal</option>
        <option value="loja_bogados">Bogados</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">Cada loja é um sistema separado.</p>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usuário</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Carregando...</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">Primeiro acesso: digite um PIN e clique em <b>Entrar</b> para criar.</p>
      <p class="text-xs text-gray-500 mt-1">Usuários bloqueados não aparecem aqui.</p>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 dígitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234" class="w-full border p-2 rounded" />
      <p class="text-xs text-gray-500 mt-1">O PIN é salvo com hash no Firestore.</p>
    </div>

    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">Entrar</button>
    </div>
  </div>
</section>

<!-- FUNCIONÁRIO -->
<section id="funcionario" class="hidden max-w-3xl mx-auto">

  <!-- PESQUISA DE PREÇOS (TOPO) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold">Consulta de Preços</h2>
        <p class="text-xs text-gray-500">Digite o nome do produto para ver o valor.</p>
      </div>
      <button id="btnToggleCatalogEmp" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="catalogEmpContent" class="mt-3">
      <div class="flex gap-2">
        <input id="catalogSearchEmp" class="flex-1 border rounded p-2" placeholder="Ex: Coca 2L, Heineken..." />
        <button id="btnClearSearchEmp" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">Limpar</button>
      </div>

      <div class="flex items-center justify-between mt-3">
        <div class="text-xs text-gray-500">Itens cadastrados</div>
        <div class="text-xs text-gray-500">Total: <span id="catalogCountEmp">0</span></div>
      </div>

      <div id="catalogResultsEmp" class="mt-2 text-sm space-y-2 max-h-[45vh] overflow-auto border rounded p-2 bg-gray-50">
        <div class="text-gray-500">Carregando catálogo...</div>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Usuário: <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontos do mês: <span id="monthPointsInline">0</span></p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">Sair</button>
      </div>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto">

  <!-- PESQUISA DE PREÇOS (GERENTE) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold">Consulta de Preços</h2>
        <p class="text-xs text-gray-500">Pesquisar / cadastrar / atualizar / excluir itens.</p>
      </div>
      <button id="btnToggleCatalogGer" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="catalogGerContent" class="mt-3">
      <div class="flex gap-2">
        <input id="catalogSearchGer" class="flex-1 border rounded p-2" placeholder="Ex: Coca 2L, Heineken..." />
        <button id="btnClearSearchGer" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">Limpar</button>
      </div>

      <div class="flex items-center justify-between mt-3">
        <div class="text-xs text-gray-500">Itens cadastrados</div>
        <div class="text-xs text-gray-500">Total: <span id="catalogCountGer">0</span></div>
      </div>

      <div id="catalogResultsGer" class="mt-2 text-sm space-y-2 max-h-[45vh] overflow-auto border rounded p-2 bg-gray-50">
        <div class="text-gray-500">Carregando catálogo...</div>
      </div>

      <div id="catalogManageWrap" class="hidden mt-4 border-t pt-4">
        <div class="font-semibold text-sm mb-2">Cadastrar / Atualizar preço</div>
        <div class="grid md:grid-cols-3 gap-2">
          <input id="catalogItemName" class="border p-2 rounded md:col-span-2" placeholder="Nome do produto (ex: Coca-Cola 2L)" />
          <input id="catalogItemPrice" class="border p-2 rounded" inputmode="decimal" placeholder="Preço (ex: 9.99)" />
        </div>
        <div class="flex gap-2 mt-2">
          <button id="btnCatalogSave" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">Salvar</button>
          <button id="btnCatalogDeleteByName" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">Excluir pelo nome</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">“Salvar” atualiza automaticamente se o nome já existir (sem duplicar).</p>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Painel do Gerente</h2>
        <p class="text-xs text-gray-500">Loja: <span id="storeLabelGer">-</span></p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">Sair</button>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Funcionários (Ativar / Bloquear)</h3>
    <p class="text-xs text-gray-500 mb-3">Bloqueado não aparece no login.</p>

    <div class="grid md:grid-cols-3 gap-2">
      <input id="newEmployeeName" class="border p-2 rounded" placeholder="Nome do funcionário (ex: Ingrid)" />
      <button id="btnAddEmployee" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">Adicionar (Ativo)</button>
      <button id="btnRefreshEmployees" class="bg-gray-900 hover:bg-black text-white p-2 rounded">Recarregar lista</button>
    </div>

    <div id="employeeTable" class="mt-3 space-y-2"></div>
  </div>
</section>

<script type="module">
  // ====== PWA: Manifest + Icon ======
  const TARGET_SVG = `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <defs>
      <radialGradient id="g" cx="50%" cy="50%" r="55%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="65%" stop-color="#dbeafe"/>
        <stop offset="100%" stop-color="#93c5fd"/>
      </radialGradient>
    </defs>
    <rect width="512" height="512" rx="96" fill="url(#g)"/>
    <circle cx="256" cy="256" r="170" fill="none" stroke="#1d4ed8" stroke-width="28"/>
    <circle cx="256" cy="256" r="110" fill="none" stroke="#1d4ed8" stroke-width="28"/>
    <circle cx="256" cy="256" r="52" fill="#1d4ed8"/>
  </svg>`.trim();
  const svgDataUrl = (svg) => "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  const iconUrl = svgDataUrl(TARGET_SVG);
  document.getElementById("appIcon").href = iconUrl;
  document.getElementById("appAppleIcon").href = iconUrl;
  const manifestBlob = new Blob([JSON.stringify({
    name: "Missoes",
    short_name: "Missoes",
    start_url: ".",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#2563eb",
    icons: [
      { src: iconUrl, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
      { src: iconUrl, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ]
  })], { type: "application/manifest+json" });
  document.getElementById("appManifest").href = URL.createObjectURL(manifestBlob);

  // ====== Firebase ======
  const firebaseConfig = {
    apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
    authDomain: "missoes-drive.firebaseapp.com",
    projectId: "missoes-drive",
    storageBucket: "missoes-drive.firebasestorage.app",
    messagingSenderId: "198254465545",
    appId: "1:198254465545:web:dce028792e2c2c57161ed8"
  };

  const STORES = {
    loja_principal: {
      label: "Loja Principal",
      managerUser: "GERENTE",
      defaultEmployees: ["Sandra","Thauane","Ingrid","Claudia","DADA"].map(n => ({ name:n, active:true })),
    },
    loja_bogados: {
      label: "Bogados",
      managerUser: "BOGADOS - GERENTE",
      defaultEmployees: [{ name:"bogados", active:true }],
    }
  };

  const SESSION_KEY = "mdl_session_v2";
  const MASTER_MANAGER_PIN = "1234";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    onSnapshot, query, orderBy, limit, serverTimestamp,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  const toast = (msg) => alert(msg);
  const normalizeName = (name)=> String(name||"").trim().replace(/\s+/g," ");
  const normalizeCat  = (name)=> String(name||"").trim().replace(/\s+/g," ");
  const nowHuman = ()=> new Date().toLocaleString();
  const isValidPin = (p)=> /^[0-9]{4}$/.test(String(p||""));

  let currentStoreId = "loja_principal";
  let currentUser = "";
  let employees = [];

  // ===== CATALOGO (FIX: LOADING + ERROR + COUNT) =====
  let catalogItems = [];
  let catalogLoaded = false;
  let catalogErrorMsg = "";

  function storeCfg(){ return STORES[currentStoreId] || STORES.loja_principal; }
  function managerName(){ return storeCfg().managerUser; }

  function canManageCatalog(){
    if (currentUser === managerName()) return true;
    if (currentStoreId === "loja_principal" && currentUser === "Claudia") return true;
    return false;
  }

  function toBRL(val){
    const n = Number(val);
    if (!Number.isFinite(n)) return "-";
    return n.toLocaleString("pt-BR",{ style:"currency", currency:"BRL" });
  }

  function parsePrice(raw){
    const s = String(raw||"").trim().replace(/\./g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function catalogDocRef(id){ return doc(db,"stores",currentStoreId,"catalog",id); }
  function catalogColRef(){ return collection(db,"stores",currentStoreId,"catalog"); }

  function setCatalogCount(){
    const n = catalogItems.length;
    if ($("catalogCountEmp")) $("catalogCountEmp").innerText = String(n);
    if ($("catalogCountGer")) $("catalogCountGer").innerText = String(n);
  }

  function renderCatalogPlaceholder(targetId){
    const wrap = $(targetId);
    if (!wrap) return;
    if (catalogErrorMsg){
      wrap.innerHTML = `<div class="text-red-600 text-sm">
        Erro ao carregar catálogo: ${catalogErrorMsg}<br>
        <span class="text-xs text-gray-600">Se isso aparecer, normalmente é regra/permissão do Firestore bloqueando leitura.</span>
      </div>`;
      return;
    }
    if (!catalogLoaded){
      wrap.innerHTML = `<div class="text-gray-500">Carregando catálogo...</div>`;
      return;
    }
    if (!catalogItems.length){
      wrap.innerHTML = `<div class="text-gray-500">Nenhum item cadastrado ainda.</div>`;
      return;
    }
  }

  function renderCatalogResults(targetId, q){
    const wrap = $(targetId);
    if (!wrap) return;

    // FIX: sempre mostra algo (carregando/erro/sem itens)
    if (!catalogLoaded || catalogErrorMsg || !catalogItems.length){
      renderCatalogPlaceholder(targetId);
      return;
    }

    const term = String(q||"").trim().toLowerCase();

    const rows = !term
      ? catalogItems.slice(0, 120)
      : catalogItems.filter(x =>
          String(x.nameLower||"").includes(term) || String(x.name||"").toLowerCase().includes(term)
        ).slice(0, 120);

    wrap.innerHTML = "";

    if (!rows.length){
      wrap.innerHTML = `<div class="text-gray-500">Nenhum item encontrado.</div>`;
      return;
    }

    const manage = canManageCatalog() && targetId === "catalogResultsGer";

    rows.forEach(it=>{
      const div = document.createElement("div");
      div.className = "border rounded p-2 bg-white flex items-center justify-between gap-2";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="font-semibold">${it.name}</div>
        <div class="text-xs text-gray-600">${toBRL(it.price)} ${it.updatedAtHuman ? "• " + it.updatedAtHuman : ""}</div>
      `;

      const right = document.createElement("div");
      right.className = "flex items-center gap-2";

      if (manage){
        const btnUse = document.createElement("button");
        btnUse.className = "bg-gray-900 hover:bg-black text-white px-3 py-2 rounded text-xs";
        btnUse.innerText = "Editar";
        btnUse.onclick = ()=>{
          $("catalogItemName").value = it.name;
          $("catalogItemPrice").value = String(it.price).replace(".",",");
          $("catalogItemName").focus();
        };

        const btnDel = document.createElement("button");
        btnDel.className = "bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-xs";
        btnDel.innerText = "Excluir";
        btnDel.onclick = async ()=>{
          if (!confirm(`Excluir "${it.name}"?`)) return;
          try{
            await deleteDoc(catalogDocRef(it.id));
            toast("Item excluído.");
          } catch(e){
            console.error(e);
            toast("Erro ao excluir item.");
          }
        };

        right.appendChild(btnUse);
        right.appendChild(btnDel);
      }

      div.appendChild(left);
      div.appendChild(right);
      wrap.appendChild(div);
    });
  }

  function wireCatalogSearch(){
    const empInput = $("catalogSearchEmp");
    const gerInput = $("catalogSearchGer");

    if (empInput){
      empInput.oninput = ()=> renderCatalogResults("catalogResultsEmp", empInput.value);
      $("btnClearSearchEmp").onclick = ()=> { empInput.value=""; renderCatalogResults("catalogResultsEmp",""); empInput.focus(); };
    }
    if (gerInput){
      gerInput.oninput = ()=> renderCatalogResults("catalogResultsGer", gerInput.value);
      $("btnClearSearchGer").onclick = ()=> { gerInput.value=""; renderCatalogResults("catalogResultsGer",""); gerInput.focus(); };
    }

    const wrap = $("catalogManageWrap");
    if (wrap){
      if (canManageCatalog()) wrap.classList.remove("hidden");
      else wrap.classList.add("hidden");
    }

    // FIX: render inicial sempre
    renderCatalogResults("catalogResultsEmp", $("catalogSearchEmp")?.value || "");
    renderCatalogResults("catalogResultsGer", $("catalogSearchGer")?.value || "");
  }

  function setupCollapse(btnId, contentId){
    const btn = $(btnId);
    const content = $(contentId);
    if (!btn || !content) return;
    btn.addEventListener("click", ()=>{
      const hidden = content.classList.toggle("hidden");
      btn.innerText = hidden ? "Expandir" : "Minimizar";
    });
  }
  setupCollapse("btnToggleCatalogEmp","catalogEmpContent");
  setupCollapse("btnToggleCatalogGer","catalogGerContent");

  // ===== PIN (simplificado) =====
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function userRef(user){ return doc(db,"stores",currentStoreId,"users",user); }
  async function ensureUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (snap.exists()) return;
    await setDoc(userRef(user), { user, pinHash: await sha256(pin), createdAt: serverTimestamp() }, { merge:true });
  }
  async function verifyUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (!snap.exists()){
      if (user === managerName() && pin === MASTER_MANAGER_PIN){
        await ensureUserPin(user, pin);
        return true;
      }
      return false;
    }
    return (await sha256(pin)) === (snap.data().pinHash || "");
  }

  // ===== Employees =====
  function cfgAppRef(){ return doc(db,"stores",currentStoreId,"config","app"); }

  async function ensureEmployeesConfig(){
    const snap = await getDoc(cfgAppRef());
    const defaults = storeCfg().defaultEmployees;

    if (!snap.exists()){
      await setDoc(cfgAppRef(), { employees: defaults, updatedAt: serverTimestamp() }, { merge:true });
      employees = defaults.slice();
      return;
    }

    const raw = snap.data().employees;
    employees = (Array.isArray(raw) ? raw : defaults).map(x=>({ name: normalizeName(x?.name), active: !!x?.active }))
      .filter(x=>x.name && x.name !== managerName());
  }

  function activeNames(){
    return employees.filter(e=>e.active).map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }

  function renderEmployeesUI(){
    const loginSel = $("userSelect");
    loginSel.innerHTML = "";
    loginSel.appendChild(new Option("Selecione", ""));
    loginSel.appendChild(new Option("Gerente", managerName()));
    activeNames().forEach(n => loginSel.appendChild(new Option(n, n)));

    // tabela bloqueio no gerente
    const wrap = $("employeeTable");
    if (!wrap) return;
    wrap.innerHTML = "";

    employees.sort((a,b)=>a.name.localeCompare(b.name)).forEach(e=>{
      const div = document.createElement("div");
      div.className = "border rounded p-2 bg-gray-50 flex items-center justify-between";

      div.innerHTML = `
        <div>
          <div class="font-semibold">${e.name}</div>
          <div class="text-xs text-gray-500">${e.active ? "Ativo" : "Bloqueado"}</div>
        </div>
      `;

      const btn = document.createElement("button");
      btn.className = e.active ? "bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm"
                               : "bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm";
      btn.innerText = e.active ? "Bloquear" : "Ativar";
      btn.onclick = async ()=>{
        if (currentUser !== managerName()) return toast("Apenas o gerente.");
        const next = employees.map(x => x.name === e.name ? ({...x, active: !x.active}) : x);
        await setDoc(cfgAppRef(), { employees: next, updatedAt: serverTimestamp() }, { merge:true });
      };

      div.appendChild(btn);
      wrap.appendChild(div);
    });
  }

  function show(section){
    ["login","funcionario","gerente"].forEach(s => $(s).classList.add("hidden"));
    $(section).classList.remove("hidden");
  }

  // ===== Catalog Snapshot (FIX: onError) =====
  let unsubCatalog = null;
  function startCatalogListener(){
    if (unsubCatalog) { try{unsubCatalog();}catch(e){} unsubCatalog = null; }

    catalogLoaded = false;
    catalogErrorMsg = "";
    catalogItems = [];
    setCatalogCount();
    renderCatalogPlaceholder("catalogResultsEmp");
    renderCatalogPlaceholder("catalogResultsGer");

    const q = query(catalogColRef(), orderBy("nameLower"), limit(1500));

    unsubCatalog = onSnapshot(q,
      (qs)=>{
        catalogLoaded = true;
        catalogErrorMsg = "";
        catalogItems = qs.docs.map(d => ({ id:d.id, ...d.data() }))
          .filter(x => x && x.name)
          .map(x => ({
            ...x,
            name: String(x.name||""),
            nameLower: String(x.nameLower || String(x.name||"").toLowerCase()),
            price: Number(x.price||0)
          }))
          .sort((a,b)=> String(a.nameLower).localeCompare(String(b.nameLower)));

        setCatalogCount();
        // Render para os dois perfis SEMPRE
        renderCatalogResults("catalogResultsEmp", $("catalogSearchEmp")?.value || "");
        renderCatalogResults("catalogResultsGer", $("catalogSearchGer")?.value || "");
      },
      (err)=>{
        console.error("Catalog snapshot error:", err);
        catalogLoaded = true;
        catalogErrorMsg = String(err?.message || err);
        setCatalogCount();
        renderCatalogPlaceholder("catalogResultsEmp");
        renderCatalogPlaceholder("catalogResultsGer");
      }
    );
  }

  // ===== Catalog Manage =====
  $("btnCatalogSave").addEventListener("click", async ()=>{
    if (!canManageCatalog()) return toast("Sem permissão.");
    const name = normalizeCat($("catalogItemName").value);
    const price = parsePrice($("catalogItemPrice").value);
    if (!name) return toast("Digite o nome.");
    if (!Number.isFinite(price)) return toast("Preço inválido.");

    // upsert por nomeLower (sem duplicar)
    const nameLower = name.toLowerCase();
    const existing = catalogItems.find(x=>x.nameLower === nameLower);
    if (existing){
      await updateDoc(catalogDocRef(existing.id), {
        name, nameLower, price,
        updatedAt: serverTimestamp(),
        updatedAtHuman: nowHuman(),
        updatedBy: currentUser
      });
      toast("Atualizado!");
    } else {
      await addDoc(catalogColRef(), {
        name, nameLower, price,
        createdAt: serverTimestamp(),
        createdAtHuman: nowHuman(),
        updatedAt: serverTimestamp(),
        updatedAtHuman: nowHuman(),
        updatedBy: currentUser
      });
      toast("Criado!");
    }

    $("catalogItemName").value = "";
    $("catalogItemPrice").value = "";
    $("catalogItemName").focus();
  });

  $("btnCatalogDeleteByName").addEventListener("click", async ()=>{
    if (!canManageCatalog()) return toast("Sem permissão.");
    const name = normalizeCat($("catalogItemName").value);
    if (!name) return toast("Digite o nome do item.");
    const nameLower = name.toLowerCase();
    const existing = catalogItems.find(x=>x.nameLower === nameLower);
    if (!existing) return toast("Item não encontrado pelo nome.");
    if (!confirm(`Excluir "${existing.name}"?`)) return;

    await deleteDoc(catalogDocRef(existing.id));
    toast("Excluído!");
    $("catalogItemName").value = "";
    $("catalogItemPrice").value = "";
  });

  // ===== Login flow =====
  function saveSession(storeId, user){
    localStorage.setItem(SESSION_KEY, JSON.stringify({ storeId, user, at: Date.now() }));
  }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj && obj.user && obj.storeId ? obj : null;
    } catch(e){ return null; }
  }

  async function cloudInit(){
    await ensureEmployeesConfig();
    renderEmployeesUI();
    startCatalogListener();
    wireCatalogSearch();
  }

  $("storeSelect").addEventListener("change", async ()=>{
    if (currentUser) return;
    currentStoreId = $("storeSelect").value;
    await cloudInit();
  });

  $("btnLogin").addEventListener("click", async ()=>{
    const u = $("userSelect").value;
    const p = $("pin").value;
    if (!u) return toast("Selecione o usuário.");
    if (!isValidPin(p)) return toast("PIN precisa ter 4 dígitos.");

    const ok = await verifyUserPin(u, p);
    if (!ok){
      // criar usuário se não existe (primeiro acesso)
      const snap = await getDoc(userRef(u));
      if (!snap.exists()){
        await ensureUserPin(u, p);
      } else {
        return toast("PIN incorreto.");
      }
    }

    currentUser = u;
    saveSession(currentStoreId, u);
    $("pin").value = "";

    if (u === managerName()){
      $("storeLabelGer").innerText = storeCfg().label;
      show("gerente");
    } else {
      $("userName").innerText = u;
      show("funcionario");
    }

    wireCatalogSearch(); // atualiza permissões
  });

  $("btnLogout1").addEventListener("click", ()=>{ currentUser=""; clearSession(); show("login"); wireCatalogSearch(); });
  $("btnLogout2").addEventListener("click", ()=>{ currentUser=""; clearSession(); show("login"); wireCatalogSearch(); });

  // ===== Start =====
  const ses = getSession();
  if (ses){
    currentStoreId = ses.storeId;
    $("storeSelect").value = currentStoreId;
  }
  await cloudInit();

  if (ses && ses.user){
    currentUser = ses.user;
    // tenta abrir direto na tela certa
    if (currentUser === managerName()){
      $("storeLabelGer").innerText = storeCfg().label;
      show("gerente");
    } else {
      $("userName").innerText = currentUser;
      show("funcionario");
    }
    wireCatalogSearch();
  } else {
    show("login");
  }

  console.log("BUILD OK");
</script>

</body>
</html>
