<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missoes</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-4xl mx-auto mb-4">
  <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between gap-3">
    <div class="min-w-0">
      <div id="topTitle" class="text-xl font-bold truncate">Entrar</div>
      <div id="topSubtitle" class="text-sm text-gray-600 truncate">Login por PIN</div>
    </div>

    <div id="topPointsBox" class="hidden items-center gap-2 bg-yellow-50 border border-yellow-200 rounded-lg px-3 py-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 17.27l5.18 3.04-1.39-5.99 4.64-4.02-6.12-.53L12 4l-2.31 5.77-6.12.53 4.64 4.02-1.39 5.99L12 17.27z"/>
      </svg>
      <div class="text-sm">
        <div class="font-semibold leading-4">Pontos do mês</div>
        <div class="text-lg font-bold leading-5"><span id="monthPointsTop">0</span></div>
      </div>
    </div>
  </div>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usuário</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Carregando...</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">
        Primeiro acesso: digite um PIN e clique em <b>Entrar</b> para criar.
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Usuários bloqueados não aparecem aqui.
      </p>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 dígitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234"
             class="w-full border p-2 rounded" />
      <p class="text-xs text-gray-500 mt-1">
        O PIN é salvo com hash no Firestore.
      </p>
    </div>

    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Entrar
      </button>
    </div>
  </div>

  <div class="mt-4 border-t pt-4">
    <h3 class="font-semibold mb-2">Fotos (Armários)</h3>
    <p class="text-sm text-gray-700">
      Armários envia fotos para o <b>Firebase Storage</b>.
    </p>
  </div>
</section>

<!-- FUNCIONÁRIO -->
<section id="funcionario" class="hidden max-w-3xl mx-auto">

  <!-- Escala (viewer + editor pra Claudia/Gerente) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold">Escala da Semana</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelEscala">-</span></p>
      </div>

      <div class="flex items-center gap-2">
        <div class="text-xs text-gray-500">
          <span id="escalaPermLabel">Somente leitura</span>
        </div>
        <button id="btnToggleEscalaEmp" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Minimizar
        </button>
      </div>
    </div>

    <div id="escalaEmpContent" class="mt-3">
      <div id="escalaViewer" class="text-sm space-y-2"></div>

      <div id="escalaEditorWrap" class="hidden mt-4 border-t pt-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold text-sm">Editar escala</div>
          <button id="btnSaveEscala" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
            Salvar escala
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Regras: Manhã e Tarde sempre 2 funcionários • Ninguém dobra (mesmo dia) • Folga 1 funcionário.
        </p>
        <div id="escalaEditor" class="mt-3 space-y-3"></div>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Usuário: <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontos do mês: <span id="monthPointsInline">0</span></p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnMissing" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Cliente pediu e não tem
        </button>
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>

    <div id="missingBox" class="hidden mt-4 border-t pt-4">
      <label class="text-sm text-gray-700">O que o cliente pediu e não temos?</label>
      <div class="flex gap-2 mt-2">
        <input id="missingInput" class="flex-1 border rounded p-2" placeholder="Digite o item em falta" />
        <button id="missingSave" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Painel do Gerente</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelGer">-</span></p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="btnResetWeek" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Zerar semana (tudo)
        </button>
        <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">
          Exportar CSV
        </button>
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h3 class="font-semibold">Ranking do mês</h3>
        <p class="text-xs text-gray-500">Mês: <span id="monthKeyLabelGer">-</span></p>
      </div>
      <button id="btnToggleRanking" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="rankingContent" class="mt-3">
      <div id="rankingList" class="space-y-2 text-sm"></div>
    </div>
  </div>

  <!-- TEMPLATES GLOBAIS + PUBLICAR -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <h3 class="font-semibold mb-2">Tarefas GLOBAIS salvas (Templates)</h3>
    <p class="text-xs text-gray-500 mb-3">
      Crie templates e depois publique a GLOBAL da semana escolhendo no dropdown.
      Quem concluir primeiro “trava” e some dos demais.
    </p>

    <div class="grid md:grid-cols-4 gap-2">
      <select id="globalTplSelect" class="border p-2 rounded md:col-span-2">
        <option value="">Carregando templates...</option>
      </select>
      <button id="btnPublishGlobalFromTpl" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Publicar GLOBAL (semana)
      </button>
      <button id="btnDeleteTpl" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded">
        Excluir template
      </button>
    </div>

    <div class="mt-3 border-t pt-3">
      <div class="text-sm font-semibold mb-2">Status GLOBAL desta semana</div>
      <div id="globalStatus" class="text-sm text-gray-700">Carregando...</div>
    </div>

    <div class="mt-4 border-t pt-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-sm">Criar novo template GLOBAL</div>
        <button id="btnSaveTpl" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
          Salvar template
        </button>
      </div>

      <div class="grid md:grid-cols-4 gap-2 mt-2">
        <input id="tplName" class="border p-2 rounded md:col-span-2" placeholder="Nome do template (ex: Conferir geladeira)" />
        <input id="tplItems" class="border p-2 rounded md:col-span-2" placeholder="Itens separados por vírgula (ex: Coca, Guaraná...)" />
      </div>
      <p class="text-xs text-gray-500 mt-2">
        Para concluir, nenhum campo pode ficar vazio (se for zero, digite 0).
      </p>
    </div>
  </div>

  <!-- APAGAR TAREFAS POR FUNCIONÁRIO (SEMANA) -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Apagar tarefas por funcionário (semana)</h3>
    <div class="grid md:grid-cols-3 gap-2">
      <select id="delTasksUser" class="border p-2 rounded"></select>
      <button id="btnLoadUserTasks" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Carregar tarefas
      </button>
      <button id="btnDeleteSelectedTasks" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded">
        Apagar selecionadas
      </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Marque as tarefas e apague. (Pontos do mês não são ajustados automaticamente.)
    </p>
    <div id="userTasksList" class="mt-3 space-y-2"></div>
  </div>
</section>

<script type="module">
  // ======= SEU FIREBASE CONFIG =======
  const firebaseConfig = {
    apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
    authDomain: "missoes-drive.firebaseapp.com",
    projectId: "missoes-drive",
    storageBucket: "missoes-drive.firebasestorage.app",
    messagingSenderId: "198254465545",
    appId: "1:198254465545:web:dce028792e2c2c57161ed8"
  };

  const STORE_ID = "loja_principal";
  const SESSION_KEY = "mdl_session_v1";
  const MASTER_MANAGER_PIN = "1234";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    onSnapshot, query, orderBy, limit, serverTimestamp, increment,
    deleteDoc, getDocs, writeBatch, where, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  function toast(msg){ alert(msg); }
  function show(section){
    ["login","funcionario","gerente"].forEach(s => $(s)?.classList.add("hidden"));
    $(section)?.classList.remove("hidden");
    updateTopBar();
  }
  function isValidPin(p){ return /^[0-9]{4}$/.test(String(p || "")); }
  function nowHuman(){ return new Date().toLocaleString(); }
  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
  function normalizeName(name){ return String(name||"").trim().replace(/\s+/g," "); }
  function normalizeCat(name){ return String(name||"").trim().replace(/\s+/g," "); }

  // ====== State ======
  let scoresDoc = {};
  let tasksDone = [];
  let currentUser = "";
  let currentWeekKey = "";
  let employees = [];
  let globalTask = null;

  // Templates globais
  let globalTemplates = [];

  // ===== Refs =====
  const cfgAppRef  = () => doc(db,"stores",STORE_ID,"config","app");
  const cfgGlobalTplRef = () => doc(db,"stores",STORE_ID,"config","global_templates");
  const scoresRef  = () => doc(db,"stores",STORE_ID,"state","scores");
  const metaRef    = () => doc(db,"stores",STORE_ID,"meta","app");
  const userRef    = (user) => doc(db,"stores",STORE_ID,"users",user);
  const globalRef  = (wk) => doc(db,"stores",STORE_ID,"state","global_"+wk);

  // ===== Top bar =====
  function monthKey(date){
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }
  function getMonthPoints(user){
    const mk = monthKey(new Date());
    const ms = scoresDoc?.monthScores?.[mk] || {};
    return Number(ms?.[user] || 0);
  }
  function updateTopBar(){
    const topTitle = $("topTitle");
    const topSubtitle = $("topSubtitle");
    const pointsBox = $("topPointsBox");

    if (!currentUser){
      topTitle.innerText = "Entrar";
      topSubtitle.innerText = "Login por PIN";
      pointsBox.classList.add("hidden");
      pointsBox.classList.remove("flex");
      return;
    }

    if (currentUser === "GERENTE"){
      topTitle.innerText = "Gerente";
      topSubtitle.innerText = "Painel administrativo";
      pointsBox.classList.add("hidden");
      pointsBox.classList.remove("flex");
      return;
    }

    topTitle.innerText = currentUser;
    topSubtitle.innerText = "Acompanhe suas tarefas";
    const pts = getMonthPoints(currentUser);
    $("monthPointsTop").innerText = pts;
    pointsBox.classList.remove("hidden");
    pointsBox.classList.add("flex");
  }

  // ===== SHA-256 =====
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // ===== Semana ISO =====
  function weekKey(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return d.getUTCFullYear() + "-W" + String(weekNo).padStart(2,"0");
  }

  async function ensureWeekKey(){
    const snap = await getDoc(metaRef());
    const today = new Date();
    const wk = weekKey(today);

    if (!snap.exists()){
      await setDoc(metaRef(),{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    const saved = snap.data().currentWeekKey || wk;
    if (today.getDay() === 1 && saved !== wk){
      await setDoc(metaRef(),{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }
    currentWeekKey = saved;
  }

  // ===== Sessão =====
  function saveSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify({ user, at: Date.now() })); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj && obj.user ? obj : null;
    } catch(e){ return null; }
  }

  // ===== Funcionários (config/app.employees) =====
  const defaultEmployeesLegacy = ["Sandra","Thauane","Ingrid","Claudia","DADA"];
  const defaultEmployees = defaultEmployeesLegacy.map(n => ({ name: n, active: true }));

  function isEmployeeActive(name){
    const n = normalizeName(name);
    const e = employees.find(x => x.name === n);
    return !!(e && e.active);
  }
  function activeNames(){
    return employees.filter(e=>e.active).map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }
  function allNames(){
    return employees.map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }

  async function ensureEmployeesConfig(){
    const snap = await getDoc(cfgAppRef());

    if (!snap.exists()){
      await setDoc(cfgAppRef(), { employees: defaultEmployees, updatedAt: serverTimestamp() }, { merge:true });
      employees = clone(defaultEmployees);
      return;
    }

    const raw = snap.data().employees;

    if (Array.isArray(raw) && raw.length > 0 && typeof raw[0] === "string"){
      const migrated = raw.map(n => ({ name: normalizeName(n), active: true })).filter(x=>x.name);
      await setDoc(cfgAppRef(), { employees: migrated, updatedAt: serverTimestamp() }, { merge:true });
      employees = migrated;
      return;
    }

    if (!Array.isArray(raw) || raw.length === 0){
      await setDoc(cfgAppRef(), { employees: defaultEmployees, updatedAt: serverTimestamp() }, { merge:true });
      employees = clone(defaultEmployees);
      return;
    }

    employees = raw
      .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
      .filter(x => x.name);

    const seen = new Set();
    employees = employees.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
  }

  function renderEmployeesUI(){
    const loginSel = $("userSelect");
    loginSel.innerHTML = "";
    loginSel.appendChild(new Option("Selecione", ""));
    loginSel.appendChild(new Option("Gerente", "GERENTE"));
    activeNames().forEach(n => loginSel.appendChild(new Option(n, n)));

    const namesAll = allNames();
    const delSel = $("delTasksUser");
    delSel.innerHTML = "";
    delSel.appendChild(new Option("Selecione um funcionário...", ""));
    namesAll.forEach(n => delSel.appendChild(new Option(n, n)));
  }

  // ===== PIN =====
  async function ensureUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (snap.exists()) return { created:false };
    await setDoc(userRef(user), {
      user,
      role: (user === "GERENTE") ? "manager" : "employee",
      pinHash: await sha256(pin),
      createdAt: serverTimestamp()
    }, { merge:true });
    return { created:true };
  }

  async function verifyUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (!snap.exists()){
      if (user === "GERENTE" && pin === MASTER_MANAGER_PIN){
        await ensureUserPin(user, pin);
        return { ok:true, usedMaster:true };
      }
      return { ok:false, noUser:true };
    }
    const pinHash = snap.data().pinHash || "";
    return { ok: (await sha256(pin)) === pinHash, noUser:false };
  }

  // ===== Scores (MENSAL) =====
  async function ensureScoresDoc(){
    const sSnap = await getDoc(scoresRef());
    if (!sSnap.exists()){
      await setDoc(scoresRef(), { monthScores: {}, updatedAt: serverTimestamp() }, { merge:true });
      scoresDoc = { monthScores: {} };
      return;
    }
    scoresDoc = sSnap.data() || {};
    if (!scoresDoc.monthScores) scoresDoc.monthScores = {};
  }

  async function bumpMonthlyScore(user, delta){
    const mk = monthKey(new Date());
    await updateDoc(scoresRef(), {
      ["monthScores."+mk+"."+user]: increment(delta),
      updatedAt: serverTimestamp()
    });
  }

  // ===== GLOBAL (semana) =====
  function getGlobalStatusText(){
    if (!globalTask || !globalTask.exists) return "Nenhuma GLOBAL publicada nesta semana.";
    if (globalTask.status === "completed") return `GLOBAL concluída por ${globalTask.completedBy} em ${globalTask.completedAtHuman || ""}`;
    if (globalTask.status === "open") return `GLOBAL pendente: ${globalTask.name || "(sem nome)"} (aguardando conclusão)`;
    return "GLOBAL: estado desconhecido.";
  }

  async function publishGlobalTaskFromTemplate(tpl){
    const ref = globalRef(currentWeekKey);
    const snap = await getDoc(ref);
    if (snap.exists()){
      const g = snap.data();
      if (g?.exists) throw new Error("Já existe GLOBAL nesta semana.");
    }

    await setDoc(ref, {
      exists: true,
      weekKey: currentWeekKey,
      status: "open",
      name: tpl.name,
      items: tpl.items || [],
      templateId: tpl.id || "",
      createdAt: serverTimestamp(),
      createdAtHuman: nowHuman()
    }, { merge:false });
  }

  async function completeGlobalTaskAsFirst(user, itensQtd){
    const ref = globalRef(currentWeekKey);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if (!snap.exists()) throw new Error("GLOBAL não existe.");
      const g = snap.data();
      if (!g.exists || g.status !== "open") throw new Error("GLOBAL já foi concluída.");
      tx.update(ref, {
        status: "completed",
        completedBy: user,
        completedAt: serverTimestamp(),
        completedAtHuman: nowHuman()
      });
    });

    await addDoc(collection(db,"stores",STORE_ID,"tasks"), {
      user,
      categoria: "[GLOBAL] " + (globalTask?.name || "GLOBAL"),
      itens: itensQtd || {},
      when: nowHuman(),
      weekKey: currentWeekKey,
      createdAt: serverTimestamp()
    });

    await bumpMonthlyScore(user, 10);
  }

  // ===== GLOBAL TEMPLATES =====
  function sanitizeItemsFromInput(raw){
    return raw ? raw.split(",").map(s=>s.trim()).filter(Boolean) : [];
  }

  function renderGlobalTplDropdown(){
    const sel = $("globalTplSelect");
    const prev = sel.value;

    sel.innerHTML = "";
    sel.appendChild(new Option("Selecione um template...", ""));
    const ordered = (globalTemplates || []).slice().sort((a,b)=>a.name.localeCompare(b.name));
    ordered.forEach(t => sel.appendChild(new Option(t.name, t.id)));

    if (prev && ordered.some(t=>t.id===prev)) sel.value = prev;
  }

  async function ensureGlobalTemplatesDoc(){
    const snap = await getDoc(cfgGlobalTplRef());
    if (!snap.exists()){
      await setDoc(cfgGlobalTplRef(), { templates: [], updatedAt: serverTimestamp() }, { merge:true });
      globalTemplates = [];
      return;
    }
    const raw = snap.data().templates;
    globalTemplates = Array.isArray(raw) ? raw : [];
  }

  async function saveGlobalTemplate(name, items){
    name = normalizeCat(name);
    if (!name) throw new Error("Nome do template vazio.");
    if (!Array.isArray(items) || items.length === 0) throw new Error("Template precisa ter itens.");

    const id = "tpl_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
    const next = (globalTemplates || []).concat([{
      id,
      name,
      items,
      createdAtHuman: nowHuman()
    }]);

    await setDoc(cfgGlobalTplRef(), { templates: next, updatedAt: serverTimestamp() }, { merge:false });
  }

  async function deleteGlobalTemplateById(id){
    const next = (globalTemplates || []).filter(t=>t.id !== id);
    await setDoc(cfgGlobalTplRef(), { templates: next, updatedAt: serverTimestamp() }, { merge:false });
  }

  function findTemplateById(id){
    return (globalTemplates || []).find(t=>t.id === id);
  }

  // ===== Ranking mensal (gerente) =====
  function renderRanking(){
    const mk = monthKey(new Date());
    $("monthKeyLabelGer").innerText = mk;

    const list = $("rankingList");
    list.innerHTML = "";

    const active = activeNames();
    const ms = scoresDoc?.monthScores?.[mk] || {};

    const rows = active.map(name => ({
      name,
      pts: Number(ms?.[name] || 0)
    })).sort((a,b)=>{
      if (b.pts !== a.pts) return b.pts - a.pts;
      return a.name.localeCompare(b.name);
    });

    if (!rows.length){
      list.innerHTML = `<div class="text-gray-500">Sem funcionários ativos.</div>`;
      return;
    }

    rows.forEach((r, idx)=>{
      const div = document.createElement("div");
      div.className = "border rounded p-2 bg-gray-50 flex items-center justify-between";
      div.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-full bg-white border flex items-center justify-center text-xs font-bold">${idx+1}</div>
          <div class="font-semibold">${r.name}</div>
        </div>
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 17.27l5.18 3.04-1.39-5.99 4.64-4.02-6.12-.53L12 4l-2.31 5.77-6.12.53 4.64 4.02-1.39 5.99L12 17.27z"/>
          </svg>
          <div class="font-bold text-lg">${r.pts}</div>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // ===== Render funcionário (GLOBAL) =====
  function renderEmployee(){
    if (!isEmployeeActive(currentUser)){
      clearSession();
      currentUser = "";
      show("login");
      return;
    }

    $("userName").innerText = currentUser;
    $("weekKeyLabel").innerText = currentWeekKey;

    const mp = getMonthPoints(currentUser);
    $("monthPointsInline").innerText = mp;
    $("monthPointsTop").innerText = mp;
    updateTopBar();

    const container = $("tasks");
    container.innerHTML = "";

    if (globalTask && globalTask.exists && globalTask.status === "open"){
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-xl shadow border-2 border-blue-200";

      const title = document.createElement("div");
      title.className = "flex items-center justify-between gap-2";
      title.innerHTML = `<h3 class="font-semibold">[GLOBAL] ${globalTask.name || "Tarefa Global"}</h3><span class="text-xs text-gray-500">+10 (primeiro que concluir)</span>`;
      card.appendChild(title);

      const body = document.createElement("div");
      body.className = "mt-3 space-y-2";

      const itens = Array.isArray(globalTask.items) ? globalTask.items : [];
      itens.forEach((item)=>{
        const row = document.createElement("div");
        row.className = "flex items-center justify-between gap-2";
        row.innerHTML =
          "<span class='text-sm text-gray-800'>" + item + "</span>" +
          "<input data-item='" + encodeURIComponent(item) + "' type='number' min='0' class='w-24 border rounded px-2 py-1 text-right' placeholder='Qtd'>";
        body.appendChild(row);
      });

      const warn = document.createElement("p");
      warn.className = "text-xs text-gray-500 mt-2";
      warn.innerText = "Para concluir, nenhum campo pode ficar vazio (se for zero, digite 0).";
      body.appendChild(warn);

      const btn = document.createElement("button");
      btn.className = "mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded";
      btn.innerText = "Concluir GLOBAL";

      btn.addEventListener("click", async ()=>{
        const itensQtd = {};
        const inputs = Array.from(body.querySelectorAll("input[type=number]"));
        for (const inp of inputs){
          const name = decodeURIComponent(inp.getAttribute("data-item"));
          if (inp.value === ""){
            toast("Preencha todos os itens. Se for zero, digite 0.");
            inp.focus();
            return;
          }
          const val = Number(inp.value);
          itensQtd[name] = Number.isFinite(val) ? val : 0;
        }

        btn.disabled = true;
        btn.classList.add("opacity-50");
        btn.innerText = "Tentando concluir...";

        try{
          await completeGlobalTaskAsFirst(currentUser, itensQtd);
          toast("Você concluiu a GLOBAL primeiro!");
        } catch(e){
          console.error(e);
          toast("GLOBAL já foi concluída por outra pessoa.");
        } finally {
          btn.disabled = true;
          btn.innerText = "Encerrada";
        }
      });

      card.appendChild(body);
      card.appendChild(btn);
      container.appendChild(card);
    } else {
      container.innerHTML = `<div class="bg-white p-4 rounded-xl shadow text-gray-600">Sem GLOBAL pendente no momento.</div>`;
    }
  }

  // ===== Render gerente =====
  function renderManager(){
    $("weekKeyLabelGer").innerText = currentWeekKey;
    $("globalStatus").innerText = getGlobalStatusText();
    renderRanking();
  }

  // ===== Collapses =====
  function setupCollapse(btnId, contentId){
    const btn = $(btnId);
    const content = $(contentId);
    if (!btn || !content) return;

    btn.addEventListener("click", ()=>{
      const hidden = content.classList.toggle("hidden");
      btn.innerText = hidden ? "Expandir" : "Minimizar";
    });
  }
  setupCollapse("btnToggleRanking", "rankingContent");

  // ===== Missing =====
  $("btnMissing").addEventListener("click", ()=> $("missingBox").classList.toggle("hidden"));
  $("missingSave").addEventListener("click", async ()=>{
    const raw = $("missingInput").value.trim();
    if (!raw) return toast("Digite o item em falta.");
    await addDoc(collection(db,"stores",STORE_ID,"missing"), {
      user: currentUser,
      item: raw,
      when: nowHuman(),
      weekKey: currentWeekKey,
      createdAt: serverTimestamp()
    });
    $("missingInput").value = "";
    $("missingBox").classList.add("hidden");
    toast("Registrado!");
  });

  // ===== GLOBAL TEMPLATES UI =====
  $("btnSaveTpl").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const name = normalizeCat($("tplName").value);
    const items = sanitizeItemsFromInput($("tplItems").value.trim());
    if (!name) return toast("Digite o nome do template.");
    if (!items.length) return toast("Digite pelo menos 1 item.");
    try{
      await saveGlobalTemplate(name, items);
      $("tplName").value = "";
      $("tplItems").value = "";
      toast("Template salvo.");
    } catch(e){
      console.error(e);
      toast(String(e?.message || "Erro ao salvar template."));
    }
  });

  $("btnDeleteTpl").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const id = $("globalTplSelect").value;
    if (!id) return toast("Selecione um template.");
    const tpl = findTemplateById(id);
    if (!tpl) return toast("Template não encontrado.");
    if (!confirm(`Excluir template "${tpl.name}"?`)) return;
    try{
      await deleteGlobalTemplateById(id);
      toast("Template excluído.");
    } catch(e){
      console.error(e);
      toast("Erro ao excluir template.");
    }
  });

  $("btnPublishGlobalFromTpl").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const id = $("globalTplSelect").value;
    if (!id) return toast("Selecione um template.");
    const tpl = findTemplateById(id);
    if (!tpl) return toast("Template não encontrado.");
    if (!confirm(`Publicar GLOBAL desta semana usando "${tpl.name}"?`)) return;

    try{
      await publishGlobalTaskFromTemplate(tpl);
      toast("GLOBAL publicada para esta semana.");
    } catch(e){
      console.error(e);
      toast(String(e?.message || "Erro ao publicar GLOBAL."));
    }
  });

  // ===== Apagar tarefas por funcionário (semana) =====
  $("btnLoadUserTasks").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("delTasksUser").value;
    if (!u) return toast("Selecione um funcionário.");
    renderUserTasksForDelete(u);
  });

  function renderUserTasksForDelete(user){
    const box = $("userTasksList");
    box.innerHTML = "";

    const list = tasksDone
      .filter(t=>t.user === user)
      .slice()
      .sort((a,b)=>(String(b.when||"").localeCompare(String(a.when||""))));

    if (!list.length){
      box.innerHTML = `<div class="text-sm text-gray-500">Nenhuma tarefa na semana para ${user}.</div>`;
      return;
    }

    list.forEach((t)=>{
      const row = document.createElement("div");
      row.className = "border rounded p-2 bg-gray-50 flex items-start gap-2";

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "mt-1";
      chk.dataset.id = t.id;

      const info = document.createElement("div");
      info.className = "flex-1";
      info.innerHTML = `
        <div class="font-semibold">${t.categoria}</div>
        <div class="text-xs text-gray-600">${t.when || ""}</div>
      `;

      row.appendChild(chk);
      row.appendChild(info);
      box.appendChild(row);
    });
  }

  $("btnDeleteSelectedTasks").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("delTasksUser").value;
    if (!u) return toast("Selecione um funcionário.");

    const checks = Array.from($("userTasksList").querySelectorAll("input[type=checkbox]:checked"));
    if (!checks.length) return toast("Marque pelo menos 1 tarefa.");
    if (!confirm(`Apagar ${checks.length} tarefa(s) de ${u}?`)) return;

    try{
      let batch = writeBatch(db);
      let count = 0;
      for (const c of checks){
        const id = c.dataset.id;
        if (!id) continue;
        const ref = doc(db,"stores",STORE_ID,"tasks",id);
        batch.delete(ref);
        count++;
        if (count % 450 === 0){
          await batch.commit();
          batch = writeBatch(db);
        }
      }
      await batch.commit();
      toast("Tarefas apagadas.");
      renderUserTasksForDelete(u);
    } catch(e){
      console.error(e);
      toast("Erro ao apagar tarefas.");
    }
  });

  // ===== Export CSV =====
  $("btnExport").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente exporta.");

    const header = ["tipo","usuario","categoria","quando","detalhes"];
    let csv = header.join(",") + "\n";

    tasksDone.forEach((r)=>{
      csv += ["tarefa", r.user, r.categoria, r.when, JSON.stringify(r.itens || {})].map(csvCell).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "relatorio_" + currentWeekKey + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  function csvCell(v){
    const s = String(v == null ? "" : v);
    if (/[\n\r,"]/g.test(s)) return '"' + s.replaceAll('"', '""') + '"';
    return s;
  }

  // ===== Login / Logout =====
  $("btnLogout1").addEventListener("click", doLogout);
  $("btnLogout2").addEventListener("click", doLogout);

  $("btnLogin").addEventListener("click", async ()=>{
    const u = $("userSelect").value;
    const p = $("pin").value;
    if (!u) return toast("Selecione o usuário.");
    if (!isValidPin(p)) return toast("PIN precisa ter 4 dígitos.");

    if (u !== "GERENTE" && !isEmployeeActive(u)){
      return toast("Usuário bloqueado. Fale com o gerente.");
    }

    const check = await verifyUserPin(u, p);
    if (check.noUser){
      await ensureUserPin(u, p);
      toast("PIN criado! Você já está logado.");
      doLogin(u);
      return;
    }
    if (!check.ok) return toast("PIN incorreto.");
    doLogin(u);
  });

  function doLogin(u){
    currentUser = u;
    $("pin").value = "";
    saveSession(u);

    if (u === "GERENTE"){
      renderManager();
      show("gerente");
    } else {
      renderEmployee();
      show("funcionario");
    }

    updateTopBar();
  }

  function doLogout(){
    currentUser = "";
    clearSession();
    show("login");
  }

  // ===== Cloud init =====
  async function cloudInit(){
    await ensureWeekKey();
    await ensureEmployeesConfig();
    renderEmployeesUI();

    await ensureScoresDoc();

    await ensureGlobalTemplatesDoc();
    renderGlobalTplDropdown();

    onSnapshot(cfgGlobalTplRef(), (snap)=>{
      const raw = snap.exists() ? snap.data().templates : [];
      globalTemplates = Array.isArray(raw) ? raw : [];
      renderGlobalTplDropdown();
    });

    onSnapshot(cfgAppRef(), (snap)=>{
      if (!snap.exists()) return;
      const raw = snap.data().employees;
      employees = (Array.isArray(raw) ? raw : [])
        .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
        .filter(x => x.name);

      renderEmployeesUI();

      if (currentUser && currentUser !== "GERENTE" && !isEmployeeActive(currentUser)){
        clearSession();
        currentUser = "";
        toast("Usuário bloqueado. Faça login novamente.");
        show("login");
      }

      renderRanking();
      updateTopBar();
    });

    onSnapshot(scoresRef(), (snap)=>{
      scoresDoc = snap.data() || {};
      if (!scoresDoc.monthScores) scoresDoc.monthScores = {};
      if (currentUser && currentUser !== "GERENTE"){
        const pts = getMonthPoints(currentUser);
        $("monthPointsInline").innerText = pts;
        $("monthPointsTop").innerText = pts;
      }
      renderRanking();
      updateTopBar();
    });

    const tasksQ = query(collection(db,"stores",STORE_ID,"tasks"), orderBy("createdAt","desc"), limit(900));
    onSnapshot(tasksQ, (qs)=>{
      const all = qs.docs.map(d => ({ id:d.id, ...d.data() }));
      tasksDone = all.filter(x=>x.weekKey === currentWeekKey);
    });

    onSnapshot(globalRef(currentWeekKey), (snap)=>{
      globalTask = snap.exists() ? { id: snap.id, ...snap.data() } : null;
      if ($("globalStatus")) $("globalStatus").innerText = getGlobalStatusText();
      if (currentUser && currentUser !== "GERENTE") renderEmployee();
      if (currentUser === "GERENTE") renderManager();
    });

    renderRanking();
    updateTopBar();
  }

  await cloudInit();

  const ses = getSession();
  if (ses && ses.user){
    currentUser = ses.user;
    if (currentUser === "GERENTE"){
      renderManager();
      show("gerente");
    } else {
      if (!isEmployeeActive(currentUser)){
        clearSession();
        currentUser = "";
        show("login");
      } else {
        renderEmployee();
        show("funcionario");
      }
    }
  } else {
    show("login");
  }

  updateTopBar();

  console.log("BUILD OK");
  window.__BUILD_OK__ = true;
</script>

</body>
</html>
