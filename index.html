<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Missoes da Loja</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-3xl mx-auto mb-4">
  <h1 class="text-2xl font-bold text-center">Missoes da Loja</h1>
  <p class="text-center text-sm text-gray-600 mt-1">
    Login por PIN • Checklist • Falta de produto • Gerente em tempo real
  </p>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-3 gap-3">
    <div>
      <label class="text-sm">Usuario</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Selecione</option>
        <option value="GERENTE">Gerente</option>
        <option value="Sandra">Sandra</option>
        <option value="Thauane">Thauane</option>
        <option value="Ingrid">Ingrid</option>
        <option value="Claudia">Claudia</option>
        <option value="DADA">DADA</option>
      </select>
    </div>

    <div>
      <label class="text-sm">PIN (4 digitos)</label>
      <input id="pin" maxlength="4" inputmode="numeric"
             class="w-full border p-2 rounded">
    </div>

    <div class="flex items-end">
      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Entrar
      </button>
    </div>
  </div>
</section>

<!-- FUNCIONARIO -->
<section id="funcionario" class="hidden max-w-3xl mx-auto mt-4">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <h2 class="text-xl font-semibold">Usuario: <span id="userName"></span></h2>
    <p>Pontuacao: <span id="score">0</span></p>
    <button id="btnMissing"
            class="mt-2 bg-red-600 text-white px-3 py-2 rounded">
      Cliente pediu e nao tem
    </button>
    <button id="btnLogout1"
            class="mt-2 bg-gray-300 px-3 py-2 rounded">
      Sair
    </button>

    <div id="missingBox" class="hidden mt-3">
      <input id="missingInput" class="border p-2 w-full"
             placeholder="Digite o item em falta">
      <button id="missingSave"
              class="mt-2 bg-red-600 text-white px-3 py-2 rounded">
        Salvar
      </button>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto mt-4">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <h2 class="text-xl font-semibold">Painel do Gerente</h2>
    <button id="btnExport"
            class="bg-green-600 text-white px-3 py-2 rounded">
      Exportar CSV
    </button>
    <button id="btnLogout2"
            class="bg-gray-300 px-3 py-2 rounded">
      Sair
    </button>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold">Tarefas</h3>
      <div id="gerTasks"></div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold">Itens em falta</h3>
      <div id="gerMissing"></div>
    </div>
  </div>
</section>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
  authDomain: "missoes-drive.firebaseapp.com",
  projectId: "missoes-drive",
  storageBucket: "missoes-drive.firebasestorage.app",
  messagingSenderId: "198254465545",
  appId: "1:198254465545:web:dce028792e2c2c57161ed8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= DADOS ================= */
const pins = {
  GERENTE: "1234",
  Sandra: "1111",
  Thauane: "2222",
  Ingrid: "3333",
  Claudia: "4444",
  DADA: "5555"
};

const missions = {
  Ingrid: ["Jardim America", "Fotos", "Armarios"],
  Sandra: ["Pedido Itaipava"],
  Thauane: ["Ambev"],
  Claudia: ["Sadia", "Queijos"],
  DADA: ["Mineirinho"]
};

let currentUser = "";

/* ================= UI ================= */
const $ = id => document.getElementById(id);
function show(id){
  ["login","funcionario","gerente"].forEach(x => $(x).classList.add("hidden"));
  $(id).classList.remove("hidden");
}

/* ================= LOGIN ================= */
$("btnLogin").onclick = () => {
  const u = $("userSelect").value;
  const p = $("pin").value;

  if (!u || p !== pins[u]) {
    alert("Usuario ou PIN incorreto");
    return;
  }

  currentUser = u;
  $("pin").value = "";

  if (u === "GERENTE") {
    show("gerente");
  } else {
    $("userName").innerText = u;
    renderTasks();
    show("funcionario");
  }
};

$("btnLogout1").onclick = $("btnLogout2").onclick = () => {
  currentUser = "";
  show("login");
};

/* ================= FUNCIONARIO ================= */
function renderTasks(){
  const box = $("tasks");
  box.innerHTML = "";
  (missions[currentUser] || []).forEach(m => {
    const btn = document.createElement("button");
    btn.className = "w-full bg-green-600 text-white p-2 rounded";
    btn.innerText = "Concluir: " + m;
    btn.onclick = async () => {
      await addDoc(collection(db,"tasks"),{
        user: currentUser,
        task: m,
        when: new Date().toLocaleString(),
        createdAt: serverTimestamp()
      });
      btn.disabled = true;
      btn.innerText = "Concluido";
    };
    box.appendChild(btn);
  });
}

/* ================= FALTA ================= */
$("btnMissing").onclick = () => $("missingBox").classList.toggle("hidden");

$("missingSave").onclick = async () => {
  const txt = $("missingInput").value.trim();
  if (!txt) return;
  await addDoc(collection(db,"missing"),{
    user: currentUser,
    item: txt,
    when: new Date().toLocaleString(),
    createdAt: serverTimestamp()
  });
  $("missingInput").value = "";
  $("missingBox").classList.add("hidden");
};

/* ================= GERENTE ================= */
onSnapshot(collection(db,"tasks"), snap => {
  const box = $("gerTasks");
  box.innerHTML = "";
  snap.forEach(d => {
    const x = d.data();
    box.innerHTML += `<div>${x.user} - ${x.task} (${x.when})</div>`;
  });
});

onSnapshot(collection(db,"missing"), snap => {
  const box = $("gerMissing");
  box.innerHTML = "";
  snap.forEach(d => {
    const x = d.data();
    box.innerHTML += `<div>${x.user}: ${x.item}</div>`;
  });
});

$("btnExport").onclick = () => alert("Exportacao CSV pode ser adicionada depois");

show("login");
console.log("BUILD OK");
</script>

</body>
</html>
