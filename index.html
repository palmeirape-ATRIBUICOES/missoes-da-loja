<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missoes</title>

  <meta name="theme-color" content="#2563eb" />

  <link id="appIcon" rel="icon" type="image/svg+xml" href="" />
  <link id="appAppleIcon" rel="apple-touch-icon" href="" />
  <link id="appManifest" rel="manifest" href="" />

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-4xl mx-auto mb-4">
  <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between gap-3">
    <div class="min-w-0 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-blue-50 border border-blue-100 flex items-center justify-center shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-700" viewBox="0 0 24 24" fill="currentColor" aria-label="Logo">
          <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 .001-16.001A8 8 0 0 1 12 20zm0-14a6 6 0 1 0 .001 12.001A6 6 0 0 0 12 6zm0 10a4 4 0 1 1 .001-8.001A4 4 0 0 1 12 16zm0-6a2 2 0 1 0 .001 4.001A2 2 0 0 0 12 10z"/>
        </svg>
      </div>

      <div class="min-w-0">
        <div id="topTitle" class="text-xl font-bold truncate">Entrar</div>
        <div id="topSubtitle" class="text-sm text-gray-600 truncate">Login por PIN</div>
      </div>
    </div>

    <div id="topPointsBox" class="hidden items-center gap-2 bg-yellow-50 border border-yellow-200 rounded-lg px-3 py-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 17.27l5.18 3.04-1.39-5.99 4.64-4.02-6.12-.53L12 4l-2.31 5.77-6.12.53 4.64 4.02-1.39 5.99L12 17.27z"/>
      </svg>
      <div class="text-sm">
        <div class="font-semibold leading-4">Pontos do mês</div>
        <div class="text-lg font-bold leading-5"><span id="monthPointsTop">0</span></div>
      </div>
    </div>
  </div>
</header>

<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usuário</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Carregando...</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">
        Primeiro acesso: digite um PIN e clique em <b>Entrar</b> para criar.
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Usuários bloqueados não aparecem aqui.
      </p>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 dígitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234"
             class="w-full border p-2 rounded" />
      <p class="text-xs text-gray-500 mt-1">
        O PIN é salvo com hash no Firestore.
      </p>
    </div>

    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Entrar
      </button>
    </div>
  </div>
</section>

<section id="funcionario" class="hidden max-w-3xl mx-auto">

  <!-- ✅✅✅ PESQUISA DE PREÇOS (FUNCIONÁRIO) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold">Consulta de preços</h2>
        <p class="text-xs text-gray-500">Pesquise um item cadastrado (nome ou parte do nome).</p>
      </div>
      <button id="btnTogglePriceEmp" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="priceEmpContent" class="mt-3">
      <div class="flex gap-2">
        <input id="priceSearchEmp" class="flex-1 border rounded p-2" placeholder="Ex: coca, heineken, pão..." />
        <button id="btnClearPriceEmp" class="bg-gray-900 hover:bg-black text-white px-3 py-2 rounded">
          Limpar
        </button>
      </div>
      <div id="priceResultsEmp" class="mt-3 space-y-2 text-sm"></div>
    </div>
  </div>
  <!-- ✅✅✅ /PESQUISA DE PREÇOS (FUNCIONÁRIO) -->

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold">Escala da Semana</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelEscala">-</span></p>
      </div>

      <div class="flex items-center gap-2">
        <div class="text-xs text-gray-500">
          <span id="escalaPermLabel">Somente leitura</span>
        </div>
        <button id="btnToggleEscalaEmp" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Minimizar
        </button>
      </div>
    </div>

    <div id="escalaEmpContent" class="mt-3">
      <div id="escalaViewer" class="text-sm space-y-2"></div>

      <div id="escalaEditorWrap" class="hidden mt-4 border-t pt-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold text-sm">Editar escala</div>
          <div class="flex gap-2">
            <button id="btnClearEscala" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
              Limpar escala
            </button>
            <button id="btnSaveEscala" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
              Salvar escala
            </button>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Regras: Manhã e Tarde sempre 2 funcionários • Ninguém dobra (mesmo dia) • Folga 1 funcionário.
        </p>
        <div id="escalaEditor" class="mt-3 space-y-3"></div>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Usuário: <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontos do mês: <span id="monthPointsInline">0</span></p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnMissing" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Cliente pediu e não tem
        </button>
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>

    <div id="missingBox" class="hidden mt-4 border-t pt-4">
      <label class="text-sm text-gray-700">O que o cliente pediu e não temos?</label>
      <div class="flex gap-2 mt-2">
        <input id="missingInput" class="flex-1 border rounded p-2" placeholder="Digite o item em falta" />
        <button id="missingSave" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<section id="gerente" class="hidden max-w-4xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Painel do Gerente</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelGer">-</span></p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="btnResetWeek" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Zerar semana (tudo)
        </button>
        <button id="btnResetStars" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Zerar estrelas do mês
        </button>
        <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">
          Exportar CSV
        </button>
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>
    <div id="managerWarn" class="hidden mt-3 text-xs bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-2"></div>
  </div>

  <!-- ✅✅✅ PESQUISA DE PREÇOS (GERENTE) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h3 class="font-semibold">Consulta de preços</h3>
        <p class="text-xs text-gray-500">Pesquise um item cadastrado (nome ou parte do nome).</p>
      </div>
      <button id="btnTogglePriceGer" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="priceGerContent" class="mt-3">
      <div class="flex gap-2">
        <input id="priceSearchGer" class="flex-1 border rounded p-2" placeholder="Ex: coca, heineken, pão..." />
        <button id="btnClearPriceGer" class="bg-gray-900 hover:bg-black text-white px-3 py-2 rounded">
          Limpar
        </button>
      </div>
      <div id="priceResultsGer" class="mt-3 space-y-2 text-sm"></div>
    </div>
  </div>
  <!-- ✅✅✅ /PESQUISA DE PREÇOS (GERENTE) -->

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h3 class="font-semibold">Ranking do mês</h3>
        <p class="text-xs text-gray-500">Mês: <span id="monthKeyLabelGer">-</span></p>
      </div>
      <button id="btnToggleRanking" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="rankingContent" class="mt-3">
      <div id="rankingList" class="space-y-2 text-sm"></div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <h3 class="font-semibold mb-2">Tarefas GLOBAIS salvas (Templates)</h3>
    <p class="text-xs text-gray-500 mb-3">
      Crie templates de GLOBAL e depois publique.
      Quem concluir primeiro “trava” e some dos demais.
    </p>

    <div class="grid md:grid-cols-4 gap-2">
      <select id="globalTplSelect" class="border p-2 rounded md:col-span-2">
        <option value="">Carregando templates...</option>
      </select>
      <button id="btnPublishGlobalFromTpl" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Publicar GLOBAL (semana)
      </button>
      <button id="btnDeleteTpl" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded">
        Excluir template
      </button>
    </div>

    <div class="mt-3 border-t pt-3">
      <div class="text-sm font-semibold mb-2">Status GLOBAL desta semana</div>
      <div id="globalStatus" class="text-sm text-gray-700">Carregando...</div>
    </div>

    <div class="mt-4 border-t pt-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-sm">Criar novo template GLOBAL</div>
        <button id="btnSaveTpl" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
          Salvar template
        </button>
      </div>

      <div class="grid md:grid-cols-4 gap-2 mt-2">
        <input id="tplName" class="border p-2 rounded md:col-span-2" placeholder="Nome do template (ex: Conferir geladeira)" />
        <input id="tplItems" class="border p-2 rounded md:col-span-2" placeholder="Itens separados por vírgula (ex: Coca, Guaraná...)" />
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="font-semibold">Escala da Semana</h3>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelEscalaGer">-</span></p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnToggleEscalaGer" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Minimizar
        </button>
        <button id="btnClearEscalaGer" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
          Limpar escala
        </button>
        <button id="btnSaveEscalaGer" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
          Salvar escala
        </button>
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Regras: Manhã e Tarde sempre 2 funcionários • Ninguém dobra (mesmo dia) • Folga 1 funcionário.
    </p>

    <div id="escalaGerContent" class="mt-3">
      <div id="escalaEditorGer" class="space-y-3"></div>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Tarefas concluídas (semana)</h3>
      <div class="flex gap-2 mb-3">
        <button id="btnDeleteAllTasksWeek" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
          Excluir TODAS tarefas (semana)
        </button>
      </div>
      <div id="gerTasks" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Itens em falta</h3>
      <div class="flex gap-2 mb-3">
        <button id="btnDeleteAllMissingWeek" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
          Excluir TODAS faltas (semana)
        </button>
      </div>
      <div id="gerMissing" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Funcionários (Ativar / Bloquear)</h3>
    <p class="text-xs text-gray-500 mb-3">
      Bloqueado não aparece no login.
    </p>

    <div class="grid md:grid-cols-3 gap-2">
      <input id="newEmployeeName" class="border p-2 rounded" placeholder="Nome do funcionário (ex: Ingrid)" />
      <button id="btnAddEmployee" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Adicionar (Ativo)
      </button>
      <button id="btnRefreshEmployees" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Recarregar lista
      </button>
    </div>

    <div id="employeeTable" class="mt-3 space-y-2"></div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Adicionar / Atualizar categoria (individual)</h3>
    <div class="grid md:grid-cols-4 gap-2">
      <select id="addUser" class="border p-2 rounded"></select>
      <input id="categoriaNome" placeholder="Nome da categoria" class="border p-2 rounded" />
      <input id="itensCategoria" placeholder="Itens separados por vírgula" class="border p-2 rounded md:col-span-2" />
    </div>
    <button id="btnAddCategory" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full">
      Adicionar / Atualizar categoria
    </button>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">PINs</h3>
    <div class="grid md:grid-cols-3 gap-2 mt-2">
      <select id="pinUser" class="border p-2 rounded"></select>
      <input id="pinNew" class="border p-2 rounded" inputmode="numeric" maxlength="4" placeholder="Novo PIN (4 dígitos)" />
      <button id="btnSetPin" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Definir / Resetar PIN
      </button>
    </div>

    <p class="text-xs text-gray-500 mt-2">
      PIN mestre inicial do gerente: <b>1234</b> só se o gerente ainda não tiver PIN criado.
    </p>
  </div>

  <!-- ✅✅✅ CADASTRO DE PREÇOS (Somente GERENTE e CLAUDIA) -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h3 class="font-semibold">Cadastro de mercadorias e preços</h3>
        <p class="text-xs text-gray-500">Apenas <b>GERENTE</b> e <b>Claudia</b> podem cadastrar/editar.</p>
      </div>
      <button id="btnTogglePriceAdmin" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
        Minimizar
      </button>
    </div>

    <div id="priceAdminContent" class="mt-3">
      <div id="priceAdminLock" class="hidden text-sm bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-2">
        Sem permissão para cadastrar preços.
      </div>

      <div id="priceAdminForm" class="space-y-3">
        <div class="grid md:grid-cols-3 gap-2">
          <input id="priceItemName" class="border p-2 rounded md:col-span-2" placeholder="Nome do item (ex: Coca 2L)" />
          <input id="priceItemValue" class="border p-2 rounded" placeholder="Preço (ex: 9,99)" inputmode="decimal" />
        </div>
        <div class="flex gap-2">
          <button id="btnSavePriceItem" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">
            Salvar / Atualizar
          </button>
          <button id="btnClearPriceForm" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
            Limpar
          </button>
        </div>

        <div class="border-t pt-3">
          <div class="flex items-center justify-between gap-2">
            <div class="font-semibold text-sm">Itens cadastrados</div>
            <button id="btnDeleteAllPrices" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
              Excluir TODOS os preços
            </button>
          </div>
          <div id="priceListAdmin" class="mt-3 space-y-2 text-sm max-h-[45vh] overflow-auto"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- ✅✅✅ /CADASTRO DE PREÇOS -->
</section>

<script type="module">
  // =========================
  // ✅ ANTI-CACHE (PWA / SW)
  // =========================
  const BUILD_ID = "2026-02-04-price-search-1";
  console.log("BUILD_ID", BUILD_ID);

  try {
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if ("caches" in window) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
  } catch (e) {
    console.warn("Anti-cache falhou (não é crítico):", e);
  }

  // ====== PWA: Manifest + Icon ======
  const TARGET_SVG = `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <defs>
      <radialGradient id="g" cx="50%" cy="50%" r="55%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="65%" stop-color="#dbeafe"/>
        <stop offset="100%" stop-color="#93c5fd"/>
      </radialGradient>
    </defs>
    <rect width="512" height="512" rx="96" fill="url(#g)"/>
    <circle cx="256" cy="256" r="170" fill="none" stroke="#1d4ed8" stroke-width="28"/>
    <circle cx="256" cy="256" r="110" fill="none" stroke="#1d4ed8" stroke-width="28"/>
    <circle cx="256" cy="256" r="52" fill="#1d4ed8"/>
  </svg>`.trim();

  function svgDataUrl(svg){
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  const iconUrl = svgDataUrl(TARGET_SVG);
  const $icon = document.getElementById("appIcon");
  const $apple = document.getElementById("appAppleIcon");
  if ($icon) $icon.href = iconUrl;
  if ($apple) $apple.href = iconUrl;

  const manifest = {
    name: "Missoes",
    short_name: "Missoes",
    start_url: ".",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#2563eb",
    icons: [
      { src: iconUrl, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
      { src: iconUrl, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: "application/manifest+json" });
  const manifestUrl = URL.createObjectURL(manifestBlob);
  const $m = document.getElementById("appManifest");
  if ($m) $m.href = manifestUrl;

  // ====== Firebase ======
  const firebaseConfig = {
    apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
    authDomain: "missoes-drive.firebaseapp.com",
    projectId: "missoes-drive",
    storageBucket: "missoes-drive.firebasestorage.app",
    messagingSenderId: "198254465545",
    appId: "1:198254465545:web:dce028792e2c2c57161ed8"
  };

  const STORE_ID = "loja_principal";
  const SESSION_KEY = "mdl_session_v1";
  const MASTER_MANAGER_PIN = "1234";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    onSnapshot, query, orderBy, limit, serverTimestamp, increment,
    deleteDoc, getDocs, writeBatch, where, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  function toast(msg){ alert(msg); }
  function warnManager(msg){
    const box = $("managerWarn");
    if (!box) return;
    if (!msg){
      box.classList.add("hidden");
      box.innerText = "";
      return;
    }
    box.classList.remove("hidden");
    box.innerText = msg;
  }

  function show(section){
    ["login","funcionario","gerente"].forEach(s => $(s).classList.add("hidden"));
    $(section).classList.remove("hidden");
    updateTopBar();
  }
  function isValidPin(p){ return /^[0-9]{4}$/.test(String(p || "")); }
  function nowHuman(){ return new Date().toLocaleString(); }
  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
  function normalizeName(name){ return String(name||"").trim().replace(/\s+/g," "); }
  function normalizeCat(name){ return String(name||"").trim().replace(/\s+/g," "); }

  function normalizeWeekKeyLoose(wk){
    const s = String(wk || "").trim();
    const m = s.match(/^(\d{4})-W(\d{1,2})$/i);
    if (!m) return s;
    const y = m[1];
    const w = String(Number(m[2])).padStart(2,"0");
    return `${y}-W${w}`;
  }

  // ====== State ======
  let data = {};
  let scoresDoc = {};
  let tasksAll = [];
  let missingAll = [];
  let tasksDone = [];
  let missingReports = [];
  let currentUser = "";
  let currentWeekKey = "";
  let employees = [];
  let globalTask = null;
  let escala = null;

  let globalTemplates = [];
  let escalaLocalEmployee = null;
  let escalaLocalGer = null;

  // ✅✅✅ PREÇOS (NOVO)
  let priceItems = []; // [{id,name,price,updatedAtHuman,updatedBy}]
  const pricesCol = () => collection(db,"stores",STORE_ID,"prices");

  // ===== Refs =====
  const cfgCatsRef = () => doc(db,"stores",STORE_ID,"config","categories");
  const cfgAppRef  = () => doc(db,"stores",STORE_ID,"config","app");
  const cfgGlobalTplRef = () => doc(db,"stores",STORE_ID,"config","global_templates");
  const scoresRef  = () => doc(db,"stores",STORE_ID,"state","scores");
  const metaRef    = () => doc(db,"stores",STORE_ID,"meta","app");
  const userRef    = (user) => doc(db,"stores",STORE_ID,"users",user);
  const escalaRef  = (wk) => doc(db,"stores",STORE_ID,"state","escala_"+wk);
  const globalRef  = (wk) => doc(db,"stores",STORE_ID,"state","global_"+wk);

  // ===== Top bar =====
  function monthKey(date){
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }
  function getMonthPoints(user){
    const mk = monthKey(new Date());
    const ms = scoresDoc?.monthScores?.[mk] || {};
    return Number(ms?.[user] || 0);
  }
  function updateTopBar(){
    const topTitle = $("topTitle");
    const topSubtitle = $("topSubtitle");
    const pointsBox = $("topPointsBox");

    if (!currentUser){
      topTitle.innerText = "Entrar";
      topSubtitle.innerText = "Login por PIN";
      pointsBox.classList.add("hidden");
      pointsBox.classList.remove("flex");
      return;
    }

    if (currentUser === "GERENTE"){
      topTitle.innerText = "Gerente";
      topSubtitle.innerText = "Painel administrativo";
      pointsBox.classList.add("hidden");
      pointsBox.classList.remove("flex");
      return;
    }

    topTitle.innerText = currentUser;
    topSubtitle.innerText = "Acompanhe suas tarefas";
    const pts = getMonthPoints(currentUser);
    $("monthPointsTop").innerText = pts;
    pointsBox.classList.remove("hidden");
    pointsBox.classList.add("flex");
  }

  // ===== SHA-256 =====
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // ===== Semana ISO =====
  function weekKey(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return d.getUTCFullYear() + "-W" + String(weekNo).padStart(2,"0");
  }

  async function ensureWeekKey(){
    const snap = await getDoc(metaRef());
    const today = new Date();
    const wk = weekKey(today);

    if (!snap.exists()){
      await setDoc(metaRef(),{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    const saved = snap.data().currentWeekKey || wk;
    if (today.getDay() === 1 && saved !== wk){
      await setDoc(metaRef(),{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }
    currentWeekKey = saved;
  }

  // ===== Sessão =====
  function saveSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify({ user, at: Date.now() })); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj && obj.user ? obj : null;
    } catch(e){ return null; }
  }

  // ===== Funcionários =====
  const defaultEmployeesLegacy = ["Sandra","Thauane","Ingrid","Claudia","DADA"];
  const defaultEmployees = defaultEmployeesLegacy.map(n => ({ name: n, active: true }));

  function isEmployeeActive(name){
    const n = normalizeName(name);
    const e = employees.find(x => x.name === n);
    return !!(e && e.active);
  }
  function activeNames(){
    return employees.filter(e=>e.active).map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }
  function allNames(){
    return employees.map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }

  async function ensureEmployeesConfig(){
    const snap = await getDoc(cfgAppRef());

    if (!snap.exists()){
      await setDoc(cfgAppRef(), { employees: defaultEmployees, updatedAt: serverTimestamp() }, { merge:true });
      employees = clone(defaultEmployees);
      return;
    }

    const raw = snap.data().employees;

    if (Array.isArray(raw) && raw.length > 0 && typeof raw[0] === "string"){
      const migrated = raw.map(n => ({ name: normalizeName(n), active: true })).filter(x=>x.name);
      await setDoc(cfgAppRef(), { employees: migrated, updatedAt: serverTimestamp() }, { merge:true });
      employees = migrated;
      return;
    }

    if (!Array.isArray(raw) || raw.length === 0){
      await setDoc(cfgAppRef(), { employees: defaultEmployees, updatedAt: serverTimestamp() }, { merge:true });
      employees = clone(defaultEmployees);
      return;
    }

    employees = raw
      .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
      .filter(x => x.name);

    const seen = new Set();
    employees = employees.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
  }

  async function setEmployees(next){
    const cleaned = next
      .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
      .filter(x => x.name && x.name.toUpperCase() !== "GERENTE");

    const seen = new Set();
    const unique = cleaned.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
    unique.sort((a,b)=>a.name.localeCompare(b.name));
    await setDoc(cfgAppRef(), { employees: unique, updatedAt: serverTimestamp() }, { merge:true });
  }

  async function addEmployee(name){
    name = normalizeName(name);
    if (!name) return toast("Digite um nome.");
    if (name.toUpperCase() === "GERENTE") return toast("Nome inválido.");
    if (employees.some(e => e.name === name)) return toast("Esse funcionário já existe.");

    const next = employees.concat([{ name, active: true }]);
    await setEmployees(next);

    const newCats = clone(data || {});
    if (!newCats[name]) newCats[name] = {};
    await setDoc(cfgCatsRef(), { data: newCats, updatedAt: serverTimestamp() }, { merge:false });
    toast("Funcionário adicionado (ativo).");
  }

  function renderEmployeesUI(){
    const loginSel = $("userSelect");
    loginSel.innerHTML = "";
    loginSel.appendChild(new Option("Selecione", ""));
    loginSel.appendChild(new Option("Gerente", "GERENTE"));
    activeNames().forEach(n => loginSel.appendChild(new Option(n, n)));

    const namesAll = allNames();
    const addUser = $("addUser");
    const pinUser = $("pinUser");

    addUser.innerHTML = "";
    namesAll.forEach(n => addUser.appendChild(new Option(n,n)));

    pinUser.innerHTML = "";
    pinUser.appendChild(new Option("GERENTE", "GERENTE"));
    namesAll.forEach(n => pinUser.appendChild(new Option(n,n));

    renderEmployeeTable();
  }

  function renderEmployeeTable(){
    const wrap = $("employeeTable");
    if (!wrap) return;
    wrap.innerHTML = "";

    const ordered = employees.slice().sort((a,b)=>a.name.localeCompare(b.name));
    if (!ordered.length){
      wrap.innerHTML = `<div class="text-sm text-gray-500">Sem funcionários.</div>`;
      return;
    }

    ordered.forEach((e)=>{
      const row = document.createElement("div");
      row.className = "border rounded p-2 bg-gray-50 flex items-center justify-between gap-2";

      const left = document.createElement("div");
      left.innerHTML = `<div class="font-semibold">${e.name}</div><div class="text-xs text-gray-600">${e.active ? "Ativo" : "Bloqueado"}</div>`;

      const btn = document.createElement("button");
      btn.className = e.active
        ? "bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm"
        : "bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm";
      btn.innerText = e.active ? "Bloquear" : "Ativar";
      btn.onclick = async ()=>{
        if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
        const next = employees.map(x => x.name===e.name ? ({...x, active: !x.active}) : x);
        await setEmployees(next);
      };

      row.appendChild(left);
      row.appendChild(btn);
      wrap.appendChild(row);
    });
  }

  // ===== Categorias base =====
  const defaultData = {
    Sandra: { "Pedido Itaipava (Segunda)": ["IT Guarana","Ita Laranja","IT Limao","IT Lemon Ice","IT Cola","Latao Lokal"] },
    Thauane: {
      "Ambev (Segunda)": [
        "Cracudinha (cascos vazios completos)","Guarana Antarctica fora da geladeira","Sukita fora da geladeira",
        "Guaraviton","Gatorade","Suco Tang - Laranja","Suco Tang - Morango","Suco Tang - Guarana","Suco Tang - Uva",
        "Suco Tang - Limao","Suco Tang - Maracuja","Guaravita","Agua com gas 500ml","Agua com gas 1,5L",
        "Agua sem gas 500ml","Agua sem gas 1,5L","Corona long","Stella long"
      ],
      "Coca-Cola (Retornaveis e Packs)": [
        "Retornavel vazia completa","KS vazia completa","Packs completos de Coca-Cola 2L","Pack completo de Fanta Uva",
        "Pack completo de Fanta Laranja","Guarana latinha (Coca)","Garrafinha de Coca 200ml","Garrafinha de Fanta 200ml"
      ]
    },
    Ingrid: {
      "Jardim America": ["Antarctica latao","Brahma latao","Imperio latao","Heineken latao","Heineken long"],
      "Fotos (Check)": [
        "Foto de todas as estantes arrumadas e abastecidas","Foto dos biscoitos","Foto das reservas",
        "Foto dos doces","Foto do freezer com barras de chocolate"
      ]
    },
    Claudia: {
      "Sadia (Segunda)": ["Mortadela comum","Mortadela defumada","Presunto","Calabresa","Salsicha","Hamburguer"],
      "Queijos": ["Queijo prato","Queijo mussarela","Queijo minas","Minas padrao"]
    },
    DADA: { "Mineirinho (Terca)": ["Mineirinho 2L","Mineirinho 350ml"] }
  };

  // ===== PIN =====
  async function ensureUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (snap.exists()) return { created:false };
    await setDoc(userRef(user), {
      user,
      role: (user === "GERENTE") ? "manager" : "employee",
      pinHash: await sha256(pin),
      createdAt: serverTimestamp()
    }, { merge:true });
    return { created:true };
  }

  async function verifyUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (!snap.exists()){
      if (user === "GERENTE" && pin === MASTER_MANAGER_PIN){
        await ensureUserPin(user, pin);
        return { ok:true, usedMaster:true };
      }
      return { ok:false, noUser:true };
    }
    const pinHash = snap.data().pinHash || "";
    return { ok: (await sha256(pin)) === pinHash, noUser:false };
  }

  // ===== Scores (MENSAL) =====
  async function ensureScoresDoc(){
    const sSnap = await getDoc(scoresRef());
    if (!sSnap.exists()){
      await setDoc(scoresRef(), { monthScores: {}, updatedAt: serverTimestamp() }, { merge:true });
      scoresDoc = { monthScores: {} };
      return;
    }
    scoresDoc = sSnap.data() || {};
    if (!scoresDoc.monthScores) scoresDoc.monthScores = {};
  }

  async function bumpMonthlyScore(user, delta){
    const mk = monthKey(new Date());
    await updateDoc(scoresRef(), {
      ["monthScores."+mk+"."+user]: increment(delta),
      updatedAt: serverTimestamp()
    });
  }

  async function resetStarsThisMonth(){
    const mk = monthKey(new Date());
    const active = activeNames();
    const updates = { updatedAt: serverTimestamp() };
    active.forEach(u => updates["monthScores."+mk+"."+u] = 0);
    await updateDoc(scoresRef(), updates);
  }

  // ============================
  // ✅✅✅ PREÇOS: FUNÇÕES
  // ============================
  function canManagePrices(){
    return currentUser === "GERENTE" || currentUser === "Claudia";
  }

  function parseBRL(str){
    const s = String(str||"").trim();
    if (!s) return null;
    const cleaned = s.replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"");
    const n = Number(cleaned);
    if (!Number.isFinite(n)) return null;
    return Math.round(n * 100) / 100;
  }

  function fmtBRL(n){
    const v = Number(n);
    if (!Number.isFinite(v)) return "-";
    return v.toLocaleString("pt-BR",{ style:"currency", currency:"BRL" });
  }

  function normalizeItemKey(name){
    return normalizeName(name).toLowerCase();
  }

  function renderPriceResults(targetId, queryText){
    const wrap = $(targetId);
    if (!wrap) return;

    const q = String(queryText||"").trim().toLowerCase();
    if (!q){
      wrap.innerHTML = `<div class="text-gray-500">Digite para pesquisar.</div>`;
      return;
    }

    const hits = (priceItems||[])
      .filter(x => normalizeItemKey(x.name).includes(q))
      .sort((a,b)=>a.name.localeCompare(b.name))
      .slice(0, 50);

    if (!hits.length){
      wrap.innerHTML = `<div class="text-gray-500">Nenhum item encontrado.</div>`;
      return;
    }

    wrap.innerHTML = "";
    hits.forEach((it)=>{
      const row = document.createElement("div");
      row.className = "border rounded p-2 bg-gray-50 flex items-center justify-between gap-2";
      row.innerHTML = `
        <div class="min-w-0">
          <div class="font-semibold truncate">${it.name}</div>
          <div class="text-xs text-gray-500">Atualizado por ${it.updatedBy || "-"} • ${it.updatedAtHuman || "-"}</div>
        </div>
        <div class="font-bold">${fmtBRL(it.price)}</div>
      `;
      wrap.appendChild(row);
    });
  }

  function renderPriceAdminList(){
    const wrap = $("priceListAdmin");
    if (!wrap) return;

    wrap.innerHTML = "";
    const ordered = (priceItems||[]).slice().sort((a,b)=>a.name.localeCompare(b.name));

    if (!ordered.length){
      wrap.innerHTML = `<div class="text-gray-500">Nenhum preço cadastrado.</div>`;
      return;
    }

    ordered.forEach((it)=>{
      const row = document.createElement("div");
      row.className = "border rounded p-2 bg-gray-50 flex items-center justify-between gap-2";

      const left = document.createElement("div");
      left.className = "min-w-0";
      left.innerHTML = `
        <div class="font-semibold truncate">${it.name}</div>
        <div class="text-xs text-gray-500">Atualizado por ${it.updatedBy || "-"} • ${it.updatedAtHuman || "-"}</div>
      `;

      const right = document.createElement("div");
      right.className = "flex items-center gap-2";

      const price = document.createElement("div");
      price.className = "font-bold";
      price.innerText = fmtBRL(it.price);

      const btnEdit = document.createElement("button");
      btnEdit.className = "bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs";
      btnEdit.innerText = "Editar";
      btnEdit.onclick = ()=>{
        $("priceItemName").value = it.name;
        $("priceItemValue").value = String(it.price).replace(".",",");
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      const btnDel = document.createElement("button");
      btnDel.className = "bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs";
      btnDel.innerText = "Excluir";
      btnDel.onclick = async ()=>{
        if (!canManagePrices()) return toast("Sem permissão.");
        if (!confirm(`Excluir "${it.name}"?`)) return;
        try{
          await deleteDoc(doc(db,"stores",STORE_ID,"prices", it.id));
          toast("Preço excluído.");
        }catch(e){
          console.error(e);
          toast("Erro ao excluir.");
        }
      };

      right.appendChild(price);
      right.appendChild(btnEdit);
      right.appendChild(btnDel);

      row.appendChild(left);
      row.appendChild(right);
      wrap.appendChild(row);
    });
  }

  function setupPriceUI(){
    // Collapses
    setupCollapse("btnTogglePriceEmp","priceEmpContent");
    setupCollapse("btnTogglePriceGer","priceGerContent");
    setupCollapse("btnTogglePriceAdmin","priceAdminContent");

    // Search events
    $("priceSearchEmp")?.addEventListener("input", (e)=> renderPriceResults("priceResultsEmp", e.target.value));
    $("priceSearchGer")?.addEventListener("input", (e)=> renderPriceResults("priceResultsGer", e.target.value));

    $("btnClearPriceEmp")?.addEventListener("click", ()=>{
      $("priceSearchEmp").value = "";
      renderPriceResults("priceResultsEmp", "");
    });
    $("btnClearPriceGer")?.addEventListener("click", ()=>{
      $("priceSearchGer").value = "";
      renderPriceResults("priceResultsGer", "");
    });

    // Admin form
    $("btnClearPriceForm")?.addEventListener("click", ()=>{
      $("priceItemName").value = "";
      $("priceItemValue").value = "";
    });

    $("btnSavePriceItem")?.addEventListener("click", async ()=>{
      if (!canManagePrices()) return toast("Sem permissão.");
      const name = normalizeName($("priceItemName").value);
      const price = parseBRL($("priceItemValue").value);
      if (!name) return toast("Digite o nome do item.");
      if (price == null) return toast("Digite um preço válido (ex: 9,99).");

      // evita lixo: usa docId determinístico por nome normalizado
      const id = "p_" + normalizeItemKey(name).replace(/[^a-z0-9]+/g,"_").slice(0,80);
      try{
        await setDoc(doc(db,"stores",STORE_ID,"prices", id), {
          name,
          price,
          updatedAt: serverTimestamp(),
          updatedAtHuman: nowHuman(),
          updatedBy: currentUser
        }, { merge:true });

        toast("Preço salvo.");
        $("priceItemName").value = "";
        $("priceItemValue").value = "";
      }catch(e){
        console.error(e);
        toast("Erro ao salvar preço.");
      }
    });

    $("btnDeleteAllPrices")?.addEventListener("click", async ()=>{
      if (!canManagePrices()) return toast("Sem permissão.");
      if (!confirm("Excluir TODOS os preços cadastrados?")) return;

      try{
        const snap = await getDocs(query(pricesCol(), limit(450)));
        if (snap.empty) return toast("Não há preços.");
        let batch = writeBatch(db);
        let c = 0;
        for (const d of snap.docs){
          batch.delete(d.ref);
          c++;
          if (c % 450 === 0){
            await batch.commit();
            batch = writeBatch(db);
          }
        }
        await batch.commit();
        toast("Todos os preços foram excluídos.");
      }catch(e){
        console.error(e);
        toast("Erro ao excluir todos.");
      }
    });

    // Lock visibility admin
    const lock = $("priceAdminLock");
    const form = $("priceAdminForm");
    if (lock && form){
      if (canManagePrices()){
        lock.classList.add("hidden");
        form.classList.remove("hidden");
      } else {
        lock.classList.remove("hidden");
        form.classList.add("hidden");
      }
    }
  }

  // ============================
  // (o restante do seu código original continua aqui)
  // ============================

  // ... (mantenha TODO o resto do seu JS original abaixo)

  // ===== util collapse (já existia) =====
  function setupCollapse(btnId, contentId){
    const btn = $(btnId);
    const content = $(contentId);
    if (!btn || !content) return;

    btn.addEventListener("click", ()=>{
      const hidden = content.classList.toggle("hidden");
      btn.innerText = hidden ? "Expandir" : "Minimizar";
    });
  }

  // ⚠️ IMPORTANTE:
  // Aqui você cola o RESTO do seu JS original (do seu código atual) a partir de:
  //  - setupCollapse("btnToggleEscalaEmp"...)
  //  - e tudo o resto (global, escala, ranking, tasks, missing, login, cloudInit etc.)
  //
  // Eu já deixei as funções e UI de preços prontas.
  //
  // ✅ Só faltou 1 coisa: ligar o snapshot da collection "prices" dentro do cloudInit.
  //
  // Então, dentro do seu cloudInit(), ADICIONE este bloco:

  async function __pricesSnapshotInit(){
    const qPrices = query(pricesCol(), orderBy("name","asc"), limit(2500));
    onSnapshot(qPrices, (qs)=>{
      priceItems = qs.docs.map(d => ({ id:d.id, ...d.data() }));

      // atualiza resultados se já estiver digitando
      if ($("priceSearchEmp")) renderPriceResults("priceResultsEmp", $("priceSearchEmp").value);
      if ($("priceSearchGer")) renderPriceResults("priceResultsGer", $("priceSearchGer").value);

      // admin list
      renderPriceAdminList();
    }, (err)=>{
      console.error("Erro snapshot prices:", err);
    });
  }

  // ✅ E no final do cloudInit(), depois dos outros onSnapshot, chame:
  // await __pricesSnapshotInit();
  //
  // ✅ E no final do seu script, depois de carregar a tela, chame:
  // setupPriceUI();

</script>

</body>
</html>
