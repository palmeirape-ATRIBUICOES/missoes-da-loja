<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missoes da Loja</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-3xl mx-auto mb-4">
  <h1 class="text-2xl font-bold text-center">Missoes da Loja</h1>
  <p class="text-center text-sm text-gray-600 mt-1">
    Login por PIN (criado pelo usu√°rio) ‚Ä¢ Checklist com quantidades ‚Ä¢ Falta de produto ‚Ä¢ Gerente em tempo real (Firestore)
  </p>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usu√°rio</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Selecione</option>
        <option value="GERENTE">Gerente</option>
        <option value="Sandra">Sandra</option>
        <option value="Thauane">Thauane</option>
        <option value="Ingrid">Ingrid</option>
        <option value="Claudia">Claudia</option>
        <option value="DADA">DADA</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">
        Primeiro acesso: digite um PIN e clique em <b>Entrar</b> para criar.
      </p>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 d√≠gitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234"
             class="w-full border p-2 rounded" />
      <p class="text-xs text-gray-500 mt-1">
        O PIN √© salvo com hash no Firestore.
      </p>
    </div>

    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Entrar
      </button>
    </div>
  </div>

  <div class="mt-4 border-t pt-4">
    <h3 class="font-semibold mb-2">Fotos (Arm√°rios)</h3>
    <p class="text-sm text-gray-700">
      As fotos de Arm√°rios agora v√£o para o <b>Firebase Storage</b> (n√£o precisa Google Drive).
    </p>
  </div>
</section>

<!-- FUNCION√ÅRIA -->
<section id="funcionario" class="hidden max-w-3xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Usu√°rio: <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontua√ß√£o: <span id="score">0</span></p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnMissing" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Cliente pediu e n√£o tem
        </button>
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>

    <div id="missingBox" class="hidden mt-4 border-t pt-4">
      <label class="text-sm text-gray-700">O que o cliente pediu e n√£o temos?</label>
      <div class="flex gap-2 mt-2">
        <input id="missingInput" class="flex-1 border rounded p-2" placeholder="Digite o item em falta" />
        <button id="missingSave" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Painel do Gerente</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelGer">-</span></p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="btnResetWeek" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Zerar semana (tudo)
        </button>
        <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">
          Exportar CSV
        </button>
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      ‚ÄúZerar semana‚Äù apaga tarefas e faltas da semana atual e zera pontua√ß√µes.
    </p>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Tarefas conclu√≠das (semana)</h3>
      <div id="gerTasks" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Itens em falta</h3>
      <div id="gerMissing" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Gerenciar categorias</h3>
    <div class="grid md:grid-cols-4 gap-2">
      <select id="addUser" class="border p-2 rounded">
        <option>Sandra</option>
        <option>Thauane</option>
        <option>Ingrid</option>
        <option>Claudia</option>
        <option>DADA</option>
      </select>
      <input id="categoriaNome" placeholder="Nome da categoria" class="border p-2 rounded" />
      <input id="itensCategoria" placeholder="Itens separados por v√≠rgula" class="border p-2 rounded md:col-span-2" />
    </div>
    <button id="btnAddCategory" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full">
      Adicionar / Atualizar categoria
    </button>
    <p class="text-xs text-gray-500 mt-2">
      Para categoria ARM√ÅRIOS, deixe itens vazio para liberar upload de fotos.
    </p>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">PINs</h3>
    <p class="text-sm text-gray-700">
      Se o usu√°rio nunca criou PIN, ele cria no primeiro login. O gerente pode resetar PIN (define um novo).
    </p>

    <div class="grid md:grid-cols-3 gap-2 mt-2">
      <select id="pinUser" class="border p-2 rounded">
        <option>GERENTE</option>
        <option>Sandra</option>
        <option>Thauane</option>
        <option>Ingrid</option>
        <option>Claudia</option>
        <option>DADA</option>
      </select>
      <input id="pinNew" class="border p-2 rounded" inputmode="numeric" maxlength="4" placeholder="Novo PIN (4 d√≠gitos)" />
      <button id="btnSetPin" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Definir / Resetar PIN
      </button>
    </div>

    <p class="text-xs text-gray-500 mt-2">
      PIN do gerente: existe um PIN mestre inicial <b>1234</b> apenas se o gerente ainda n√£o tiver PIN criado.
    </p>
  </div>
</section>

<script type="module">
  // Firebase config (seu)
  const firebaseConfig = {
    apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
    authDomain: "missoes-drive.firebaseapp.com",
    projectId: "missoes-drive",
    storageBucket: "missoes-drive.firebasestorage.app",
    messagingSenderId: "198254465545",
    appId: "1:198254465545:web:dce028792e2c2c57161ed8"
  };

  const STORE_ID = "loja_principal";
  const SESSION_KEY = "mdl_session_v1";
  const MASTER_MANAGER_PIN = "1234"; // s√≥ vale se gerente ainda n√£o tiver PIN criado no Firestore

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    onSnapshot, query, orderBy, limit, serverTimestamp, increment,
    deleteDoc, getDocs, writeBatch, where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage, ref as sref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Clone simples
  function clone(obj) { return JSON.parse(JSON.stringify(obj)); }

  // Missoes padr√£o
  const defaultData = {
    Sandra: {
      "Pedido Itaipava (Segunda)": ["IT Guarana","Ita Laranja","IT Limao","IT Lemon Ice","IT Cola","Latao Lokal"]
    },
    Thauane: {
      "Ambev (Segunda)": [
        "Cracudinha (cascos vazios completos)",
        "Guarana Antarctica fora da geladeira",
        "Sukita fora da geladeira",
        "Guaraviton",
        "Gatorade",
        "Suco Tang - Laranja",
        "Suco Tang - Morango",
        "Suco Tang - Guarana",
        "Suco Tang - Uva",
        "Suco Tang - Limao",
        "Suco Tang - Maracuja",
        "Guaravita",
        "Agua com gas 500ml",
        "Agua com gas 1,5L",
        "Agua sem gas 500ml",
        "Agua sem gas 1,5L",
        "Corona long",
        "Stella long"
      ],
      "Coca-Cola (Retornaveis e Packs)": [
        "Retornavel vazia completa",
        "KS vazia completa",
        "Packs completos de Coca-Cola 2L",
        "Pack completo de Fanta Uva",
        "Pack completo de Fanta Laranja",
        "Guarana latinha (Coca)",
        "Garrafinha de Coca 200ml",
        "Garrafinha de Fanta 200ml"
      ]
    },
    Ingrid: {
      "Jardim America": ["Antarctica latao","Brahma latao","Imperio latao","Heineken latao","Heineken long"],
      "Fotos (Check)": [
        "Foto de todas as estantes arrumadas e abastecidas",
        "Foto dos biscoitos",
        "Foto das reservas",
        "Foto dos doces",
        "Foto do freezer com barras de chocolate"
      ],
      "Armarios (Fotos obrigatorias)": []
    },
    Claudia: {
      "Sadia (Segunda)": ["Mortadela comum","Mortadela defumada","Presunto","Calabresa","Salsicha","Hamburguer"],
      "Queijos": ["Queijo prato","Queijo mussarela","Queijo minas","Minas padrao"]
    },
    DADA: {
      "Mineirinho (Terca)": ["Mineirinho 2L","Mineirinho 350ml"]
    }
  };

  // Estado
  let data = clone(defaultData);
  let scores = {};
  let tasksDone = [];     // semana
  let missingReports = []; // semana
  let currentUser = "";
  let currentWeekKey = "";

  // Helpers UI
  const $ = (id) => document.getElementById(id);
  function toast(msg){ alert(msg); }
  function show(section){
    ["login","funcionario","gerente"].forEach(s => $(s).classList.add("hidden"));
    $(section).classList.remove("hidden");
  }
  function isValidPin(p){ return /^[0-9]{4}$/.test(String(p || "")); }
  function nowHuman(){ return new Date().toLocaleString(); }

  // SHA-256 (PIN hash)
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }

  // Semana ISO (reset segunda)
  function weekKey(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return d.getUTCFullYear() + "-W" + String(weekNo).padStart(2,"0");
  }

  async function ensureWeekKey(){
    const metaRef = doc(db,"stores",STORE_ID,"meta","app");
    const snap = await getDoc(metaRef);
    const today = new Date();
    const wk = weekKey(today);

    if (!snap.exists()){
      await setDoc(metaRef,{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    const saved = snap.data().currentWeekKey || wk;
    if (today.getDay() === 1 && saved !== wk){
      await setDoc(metaRef,{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    currentWeekKey = saved;
  }

  // Sess√£o persistente
  function saveSession(user){
    localStorage.setItem(SESSION_KEY, JSON.stringify({ user, at: Date.now() }));
  }
  function clearSession(){
    localStorage.removeItem(SESSION_KEY);
  }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj && obj.user ? obj : null;
    } catch(e){ return null; }
  }

  // Firestore init
  async function cloudInit(){
    await ensureWeekKey();
    $("weekKeyLabel").innerText = currentWeekKey;
    $("weekKeyLabelGer").innerText = currentWeekKey;

    // categorias
    const cfgRef = doc(db,"stores",STORE_ID,"config","categories");
    const cfgSnap = await getDoc(cfgRef);
    if (!cfgSnap.exists()){
      await setDoc(cfgRef,{ data: defaultData, updatedAt: serverTimestamp() },{ merge:true });
      data = clone(defaultData);
    } else {
      const remote = cfgSnap.data().data;
      data = (remote && typeof remote === "object") ? remote : clone(defaultData);
    }

    onSnapshot(cfgRef,(snap)=>{
      const remote = snap.data().data;
      if (remote && typeof remote === "object"){
        data = remote;
        if (currentUser && currentUser !== "GERENTE") renderEmployee();
      }
    });

    // scores
    const scoresRef = doc(db,"stores",STORE_ID,"state","scores");
    const sSnap = await getDoc(scoresRef);
    if (!sSnap.exists()) await setDoc(scoresRef,{ scores: {}, updatedAt: serverTimestamp() },{ merge:true });

    onSnapshot(scoresRef,(snap)=>{
      scores = snap.data().scores || {};
      if (currentUser && currentUser !== "GERENTE"){
        $("score").innerText = scores[currentUser] || 0;
      }
    });

    // tasks (tempo real)
    const tasksQ = query(collection(db,"stores",STORE_ID,"tasks"), orderBy("createdAt","desc"), limit(500));
    onSnapshot(tasksQ,(qs)=>{
      const all = qs.docs.map(d => ({ id: d.id, ...d.data() }));
      tasksDone = all.filter(x => x.weekKey === currentWeekKey);
      if (currentUser === "GERENTE") renderManager();
      if (currentUser && currentUser !== "GERENTE") renderEmployee(); // para refletir bloqueios
    });

    // missing (tempo real)
    const missQ = query(collection(db,"stores",STORE_ID,"missing"), orderBy("createdAt","desc"), limit(500));
    onSnapshot(missQ,(qs)=>{
      const all = qs.docs.map(d => ({ id: d.id, ...d.data() }));
      missingReports = all.filter(x => x.weekKey === currentWeekKey);
      if (currentUser === "GERENTE") renderManager();
    });
  }

  async function bumpScore(user, delta){
    const scoresRef = doc(db,"stores",STORE_ID,"state","scores");
    await updateDoc(scoresRef, { ["scores."+user]: increment(delta), updatedAt: serverTimestamp() });
  }

  // PIN doc ref
  function userRef(user){
    return doc(db, "stores", STORE_ID, "users", user);
  }

  async function ensureUserPin(user, pin){
    // cria PIN no primeiro login
    const ref = userRef(user);
    const snap = await getDoc(ref);
    if (snap.exists()) return { created: false };

    const hash = await sha256(pin);
    await setDoc(ref, {
      user,
      pinHash: hash,
      role: (user === "GERENTE") ? "manager" : "employee",
      createdAt: serverTimestamp()
    }, { merge: true });

    return { created: true };
  }

  async function verifyUserPin(user, pin){
    const ref = userRef(user);
    const snap = await getDoc(ref);

    // gerente sem PIN ainda pode entrar pelo master pin
    if (!snap.exists()){
      if (user === "GERENTE" && pin === MASTER_MANAGER_PIN){
        // cria registro do gerente com master como base (e ele pode trocar depois)
        await ensureUserPin(user, pin);
        return { ok: true, usedMaster: true };
      }
      // n√£o existe: vai criar no login
      return { ok: false, noUser: true };
    }

    const data = snap.data();
    const pinHash = data.pinHash || "";
    const hash = await sha256(pin);
    return { ok: hash === pinHash, noUser: false };
  }

  // LOGIN
  $("btnLogin").addEventListener("click", async ()=>{
    const u = $("userSelect").value;
    const p = $("pin").value;

    if (!u) return toast("Selecione o usu√°rio.");
    if (!isValidPin(p)) return toast("PIN precisa ter 4 d√≠gitos.");

    // se n√£o existe, cria e entra
    const check = await verifyUserPin(u, p);
    if (check.noUser){
      await ensureUserPin(u, p);
      toast("PIN criado! Voc√™ j√° est√° logado.");
      doLogin(u);
      return;
    }

    if (!check.ok) return toast("PIN incorreto.");

    doLogin(u);
  });

  function doLogin(u){
    currentUser = u;
    $("pin").value = "";
    saveSession(u);

    if (u === "GERENTE"){
      renderManager();
      show("gerente");
    } else {
      renderEmployee();
      show("funcionario");
    }
  }

  function doLogout(){
    currentUser = "";
    clearSession();
    show("login");
  }

  $("btnLogout1").addEventListener("click", doLogout);
  $("btnLogout2").addEventListener("click", doLogout);

  // FALTA
  $("btnMissing").addEventListener("click", ()=>{
    $("missingBox").classList.toggle("hidden");
  });

  $("missingSave").addEventListener("click", async ()=>{
    const raw = $("missingInput").value.trim();
    if (!raw) return toast("Digite o item em falta.");

    await addDoc(collection(db,"stores",STORE_ID,"missing"), {
      user: currentUser,
      item: raw,
      when: nowHuman(),
      weekKey: currentWeekKey,
      createdAt: serverTimestamp()
    });

    $("missingInput").value = "";
    $("missingBox").classList.add("hidden");
    toast("Registrado!");
  });

  // BLOQUEIO: categoria j√° conclu√≠da na semana?
  function isCategoryDoneThisWeek(user, cat){
    return tasksDone.some(t => t.user === user && t.categoria === cat && t.weekKey === currentWeekKey);
  }

  // Upload de fotos (Arm√°rios) -> Storage
  async function uploadArmariosPhotos(files, user, cat){
    const urls = [];
    const ts = Date.now();
    let idx = 0;

    for (const f of files){
      idx++;
      const safeName = String(f.name || ("foto_"+idx)).replace(/[^\w.\-]+/g, "_");
      const path = `stores/${STORE_ID}/weeks/${currentWeekKey}/${user}/${cat.replace(/[^\w.\-]+/g,"_")}/${ts}_${idx}_${safeName}`;
      const r = sref(storage, path);
      await uploadBytes(r, f);
      const url = await getDownloadURL(r);
      urls.push(url);
    }
    return urls;
  }

  // RENDER FUNCION√ÅRIA
  function renderEmployee(){
    $("userName").innerText = currentUser;
    $("score").innerText = scores[currentUser] || 0;
    $("weekKeyLabel").innerText = currentWeekKey;

    $("missingBox").classList.add("hidden");
    $("missingInput").value = "";

    const container = $("tasks");
    container.innerHTML = "";

    const cats = data[currentUser] || {};
    const catNames = Object.keys(cats);

    if (!catNames.length){
      container.innerHTML = "<div class='bg-white p-4 rounded-xl shadow text-gray-600'>Sem categorias para este usu√°rio.</div>";
      return;
    }

    catNames.forEach((cat, catIndex)=>{
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-xl shadow";

      const isArmarios = cat.toLowerCase().indexOf("armarios") >= 0;
      const done = isCategoryDoneThisWeek(currentUser, cat);

      const title = document.createElement("div");
      title.className = "flex items-center justify-between gap-2";
      title.innerHTML = "<h3 class='font-semibold'>" + cat + "</h3><span class='text-xs text-gray-500'>+10</span>";
      card.appendChild(title);

      const body = document.createElement("div");
      body.className = "mt-3 space-y-2";

      const itens = cats[cat] || [];

      let fileInput = null;

      if (isArmarios){
        const inputId = `arm_files_${catIndex}`;
        body.innerHTML =
          "<p class='text-sm text-gray-700'>Envie fotos dos arm√°rios (arm√°rio inteiro, em cima e em baixo).</p>" +
          `<input id="${inputId}" type="file" accept="image/*" capture="environment" multiple class="w-full border rounded p-2 bg-white">` +
          "<p class='text-xs text-gray-500'>As fotos ser√£o salvas no Firebase Storage.</p>";
        fileInput = () => document.getElementById(inputId);
      } else {
        itens.forEach((item)=>{
          const row = document.createElement("div");
          row.className = "flex items-center justify-between gap-2";
          row.innerHTML =
            "<span class='text-sm text-gray-800'>" + item + "</span>" +
            "<input data-item='" + encodeURIComponent(item) + "' type='number' min='0' class='w-24 border rounded px-2 py-1 text-right' placeholder='Qtd'>";
          body.appendChild(row);
        });

        const warn = document.createElement("p");
        warn.className = "text-xs text-gray-500 mt-2";
        warn.innerText = "Aten√ß√£o: para concluir, nenhum campo pode ficar vazio (digite 0 se for zero).";
        body.appendChild(warn);
      }

      const btn = document.createElement("button");
      btn.className = "mt-4 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded";
      btn.innerText = done ? "Conclu√≠do (semana)" : "Concluir";
      btn.disabled = done;
      if (done) btn.classList.add("opacity-50");

      btn.addEventListener("click", async ()=>{
        if (btn.disabled) return;

        // valida√ß√£o: n√£o permitir vazio
        const itensQtd = {};
        if (!isArmarios){
          const inputs = Array.from(body.querySelectorAll("input[type=number]"));
          for (const inp of inputs){
            const name = decodeURIComponent(inp.getAttribute("data-item"));
            const raw = inp.value;
            if (raw === ""){
              toast("Preencha todos os itens. Se for zero, digite 0.");
              inp.focus();
              return;
            }
            const val = Number(raw);
            itensQtd[name] = Number.isFinite(val) ? val : 0;
          }
        } else {
          const fi = fileInput ? fileInput() : null;
          if (!fi || !fi.files || fi.files.length === 0){
            toast("Envie pelo menos 1 foto para concluir Arm√°rios.");
            return;
          }
        }

        // bloqueio extra: se j√° foi conclu√≠da (race condition)
        if (isCategoryDoneThisWeek(currentUser, cat)){
          toast("Essa categoria j√° foi conclu√≠da nesta semana.");
          renderEmployee();
          return;
        }

        btn.disabled = true;
        btn.classList.add("opacity-50");
        btn.innerText = "Salvando...";

        try{
          let photos = [];
          if (isArmarios){
            const fi = fileInput();
            const files = Array.from(fi.files || []);
            photos = await uploadArmariosPhotos(files, currentUser, cat);
          }

          await addDoc(collection(db,"stores",STORE_ID,"tasks"), {
            user: currentUser,
            categoria: cat,
            itens: itensQtd,
            photos: photos,
            when: nowHuman(),
            weekKey: currentWeekKey,
            createdAt: serverTimestamp()
          });

          await bumpScore(currentUser, 10);

          btn.innerText = "Conclu√≠do";
          toast("Conclu√≠do!");
        } catch(e){
          console.error(e);
          toast("Erro ao salvar. Verifique a internet e tente novamente.");
          btn.disabled = false;
          btn.classList.remove("opacity-50");
          btn.innerText = "Concluir";
        }
      });

      card.appendChild(body);
      card.appendChild(btn);
      container.appendChild(card);
    });
  }

  // RENDER GERENTE
  function renderManager(){
    $("weekKeyLabelGer").innerText = currentWeekKey;

    // tarefas
    const t = $("gerTasks");
    t.innerHTML = "";
    const ordered = tasksDone.slice(0, 300);

    if (!ordered.length){
      t.innerHTML = "<p class='text-gray-500'>Nenhuma tarefa nesta semana.</p>";
    } else {
      ordered.forEach((r)=>{
        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-gray-50";

        const photosCount = (r.photos && Array.isArray(r.photos)) ? r.photos.length : 0;

        div.innerHTML =
          "<div class='flex items-start justify-between gap-2'>" +
            "<div>" +
              "<div class='font-semibold'>" + r.user + " - " + r.categoria + "</div>" +
              "<div class='text-xs text-gray-600'>" + (r.when || "") + "</div>" +
              (photosCount ? ("<div class='text-xs text-gray-700 mt-1'>üì∑ Fotos: " + photosCount + "</div>") : "") +
            "</div>" +
            "<button class='btnDelTask bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded' data-id='"+ r.id +"' data-user='"+ r.user +"' data-week='"+ r.weekKey +"'>" +
              "Excluir" +
            "</button>" +
          "</div>";

        // fotos (links)
        if (photosCount){
          const wrap = document.createElement("div");
          wrap.className = "mt-2 flex flex-wrap gap-2";
          r.photos.slice(0, 6).forEach((url, i)=>{
            const a = document.createElement("a");
            a.href = url;
            a.target = "_blank";
            a.rel = "noreferrer";
            a.className = "text-xs underline text-blue-700";
            a.innerText = "Foto " + (i+1);
            wrap.appendChild(a);
          });
          div.appendChild(wrap);
        }

        t.appendChild(div);
      });

      // bind delete
      t.querySelectorAll(".btnDelTask").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          const user = btn.getAttribute("data-user");
          const wk = btn.getAttribute("data-week");
          if (!id) return;

          const ok = confirm("Excluir esta tarefa? Isso descontar√° 10 pontos do usu√°rio.");
          if (!ok) return;

          try{
            await deleteDoc(doc(db,"stores",STORE_ID,"tasks", id));
            if (wk === currentWeekKey && user){
              await bumpScore(user, -10);
            }
            toast("Tarefa exclu√≠da.");
          } catch(e){
            console.error(e);
            toast("Erro ao excluir tarefa.");
          }
        });
      });
    }

    // faltas
    const m = $("gerMissing");
    m.innerHTML = "";
    const mo = missingReports.slice(0, 300);
    if (!mo.length){
      m.innerHTML = "<p class='text-gray-500'>Nenhuma falta nesta semana.</p>";
    } else {
      mo.forEach((r)=>{
        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-gray-50";
        div.innerHTML =
          "<div class='font-semibold'>" + r.user + "</div>" +
          "<div class='text-xs text-gray-600'>" + (r.when || "") + "</div>" +
          "<div class='text-sm mt-1'>" + r.item + "</div>";
        m.appendChild(div);
      });
    }
  }

  // GERENTE: adicionar categoria
  $("btnAddCategory").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("addUser").value;
    const cat = $("categoriaNome").value.trim();
    const items = $("itensCategoria").value.trim();
    if (!cat) return toast("Informe o nome da categoria");

    const newData = clone(data);
    if (!newData[u]) newData[u] = {};
    newData[u][cat] = items ? items.split(",").map(s => s.trim()).filter(Boolean) : [];

    const cfgRef = doc(db,"stores",STORE_ID,"config","categories");
    await setDoc(cfgRef, { data: newData, updatedAt: serverTimestamp() }, { merge:true });

    $("categoriaNome").value = "";
    $("itensCategoria").value = "";
    toast("Categoria atualizada.");
  });

  // CSV
  $("btnExport").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente exporta.");
    const header = ["tipo","usuario","categoria","quando","detalhes","fotos"];
    let csv = header.join(",") + "\n";

    tasksDone.forEach((r)=>{
      csv += ["tarefa", r.user, r.categoria, r.when, JSON.stringify(r.itens || {}), JSON.stringify(r.photos || [])].map(csvCell).join(",") + "\n";
    });
    missingReports.forEach((r)=>{
      csv += ["falta", r.user, "", r.when, JSON.stringify({ item: r.item }), ""].map(csvCell).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "relatorio_" + currentWeekKey + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  function csvCell(v){
    const s = String(v == null ? "" : v);
    if (/[\n\r,"]/g.test(s)) return '"' + s.replaceAll('"', '""') + '"';
    return s;
  }

  // GERENTE: reset semana
  $("btnResetWeek").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const ok = confirm("ATEN√á√ÉO: Isso vai apagar tarefas e faltas da semana atual e zerar pontua√ß√µes. Confirmar?");
    if (!ok) return;

    try{
      // apagar tasks da semana
      await deleteByWeek("tasks", currentWeekKey);
      await deleteByWeek("missing", currentWeekKey);

      // zerar scores
      const scoresRef = doc(db,"stores",STORE_ID,"state","scores");
      await setDoc(scoresRef, { scores: {}, updatedAt: serverTimestamp() }, { merge:true });

      toast("Semana zerada com sucesso.");
    } catch(e){
      console.error(e);
      toast("Erro ao zerar semana.");
    }
  });

  async function deleteByWeek(colName, wk){
    // Firestore n√£o apaga em massa sozinho: fazemos em batches
    const colRef = collection(db, "stores", STORE_ID, colName);
    const q = query(colRef, where("weekKey", "==", wk), limit(450));
    const snap = await getDocs(q);

    if (snap.empty) return;

    const docs = snap.docs;
    let batch = writeBatch(db);
    let count = 0;

    for (const d of docs){
      batch.delete(d.ref);
      count++;
      if (count % 450 === 0){
        await batch.commit();
        batch = writeBatch(db);
      }
    }
    await batch.commit();

    // se ainda tiver mais (acima do limit), roda novamente
    if (docs.length === 450){
      await deleteByWeek(colName, wk);
    }
  }

  // GERENTE: definir/resetar PIN
  $("btnSetPin").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("pinUser").value;
    const p = $("pinNew").value.trim();
    if (!isValidPin(p)) return toast("Novo PIN precisa ter 4 d√≠gitos.");

    try{
      const hash = await sha256(p);
      await setDoc(userRef(u), {
        user: u,
        pinHash: hash,
        role: (u === "GERENTE") ? "manager" : "employee",
        updatedAt: serverTimestamp()
      }, { merge: true });

      $("pinNew").value = "";
      toast("PIN definido com sucesso.");
    } catch(e){
      console.error(e);
      toast("Erro ao definir PIN.");
    }
  });

  // Auto login ap√≥s F5
  await cloudInit();
  const ses = getSession();
  if (ses && ses.user){
    currentUser = ses.user;
    if (currentUser === "GERENTE"){
      renderManager();
      show("gerente");
    } else {
      renderEmployee();
      show("funcionario");
    }
  } else {
    show("login");
  }

  console.log("BUILD OK");
  window.__BUILD_OK__ = true;
</script>

</body>
</html>
