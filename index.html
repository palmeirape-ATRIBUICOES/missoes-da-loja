<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miss√µes da Loja</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Identity Services (OAuth no navegador, sem Client Secret) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-3xl mx-auto mb-4">
  <h1 class="text-2xl font-bold text-center">üéØ Miss√µes da Loja</h1>
  <p class="text-center text-sm text-gray-600 mt-1">
    Login por PIN ‚Ä¢ Checklist com quantidades ‚Ä¢ ‚ÄúCliente pediu e n√£o tem‚Äù ‚Ä¢ Gerente v√™ tudo (Firestore)
  </p>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>
  <div class="grid md:grid-cols-3 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usu√°rio</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Selecione</option>
        <option value="GERENTE">Gerente</option>
        <option value="Sandra">Sandra</option>
        <option value="Thauane">Thauane</option>
        <option value="Ingrid">Ingrid</option>
        <option value="Claudia">Claudia</option>
        <option value="DADA">DADA</option>
      </select>
    </div>
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 d√≠gitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full border p-2 rounded" />
    </div>
    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">Entrar</button>
    </div>
  </div>

  <div class="mt-4 border-t pt-4">
    <h3 class="font-semibold mb-2">üì∏ Fotos dos Arm√°rios (Google Drive ‚Äì opcional)</h3>
    <p class="text-sm text-gray-700 mb-3">
      Se quiser salvar fotos na nuvem (Drive), conecte o Drive. Caso n√£o conecte, o app continua funcionando com Firestore,
      s√≥ que as fotos n√£o ser√£o enviadas.
    </p>
    <div class="flex flex-col md:flex-row gap-2">
      <button id="btnDriveConnect" class="bg-gray-900 hover:bg-black text-white p-2 rounded">Conectar Google Drive</button>
      <button id="btnDriveStatus" class="bg-gray-200 text-gray-900 p-2 rounded" disabled>Drive: desconectado</button>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Importante: este app n√£o usa Client Secret. S√≥ o Client ID no navegador.
    </p>
  </div>
</section>

<!-- FUNCION√ÅRIA -->
<section id="funcionario" class="hidden max-w-3xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">üë§ <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontua√ß√£o: <span id="score">0</span> ‚≠ê</p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnMissing" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">‚ùå Cliente pediu e n√£o tem</button>
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">Sair</button>
      </div>
    </div>

    <div id="missingBox" class="hidden mt-4 border-t pt-4">
      <label class="text-sm text-gray-700">O que o cliente pediu e n√£o temos?</label>
      <div class="flex gap-2 mt-2">
        <input id="missingInput" class="flex-1 border rounded p-2" placeholder="Ex: produto X" />
        <button id="missingSave" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">Salvar</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">Isso aparece no painel do gerente em tempo real.</p>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">üìä Painel do Gerente</h2>
        <p class="text-sm text-gray-700">Voc√™ v√™ tudo de todos os celulares em tempo real (Firestore).</p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelGer">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">Exportar CSV</button>
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">Sair</button>
      </div>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">‚úÖ Tarefas conclu√≠das (semana)</h3>
      <div id="gerTasks" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">‚ùå Faltas (cliente pediu e n√£o tem)</h3>
      <div id="gerMissing" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">‚ûï Gerenciar categorias</h3>
    <div class="grid md:grid-cols-4 gap-2">
      <select id="addUser" class="border p-2 rounded">
        <option>Sandra</option>
        <option>Thauane</option>
        <option>Ingrid</option>
        <option>Claudia</option>
        <option>DADA</option>
      </select>
      <input id="categoriaNome" placeholder="Nome da categoria" class="border p-2 rounded" />
      <input id="itensCategoria" placeholder="Itens (separe por v√≠rgula)" class="border p-2 rounded md:col-span-2" />
    </div>
    <button id="btnAddCategory" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full">Adicionar / Atualizar categoria</button>
    <p class="text-xs text-gray-500 mt-2">Dica: para a categoria <b>Arm√°rios (Fotos obrigat√≥rias)</b>, deixe itens vazio ‚Äî ela libera upload de fotos.</p>
  </div>
</section>

<script type="module">
/**********************
 * FIREBASE / FIRESTORE
 **********************/
const firebaseConfig = {
  apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
  authDomain: "missoes-drive.firebaseapp.com",
  projectId: "missoes-drive",
  storageBucket: "missoes-drive.firebasestorage.app",
  messagingSenderId: "198254465545",
  appId: "1:198254465545:web:dce028792e2c2c57161ed8"
};

const STORE_ID = "loja_principal";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  limit,
  serverTimestamp,
  increment
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/**********************
 * DRIVE (OPCIONAL)
 **********************/
const GOOGLE_CLIENT_ID = "198254465545-c7r3noc9vtiiabqltbfrco08f44ci0ls.apps.googleusercontent.com";
const DRIVE_ROOT_FOLDER_NAME = "Missoes da Loja";

/**********************
 * PINs
 **********************/
window.pins = {
  GERENTE: '1234',
  Sandra: '1111',
  Thauane: '2222',
  Ingrid: '3333',
  Claudia: '4444',
  DADA: '5555'
};
const pins = window.pins;

/**********************
 * MISS√ïES PADR√ÉO
 **********************/
const defaultData = {
  Sandra: {
    'Pedido Itaipava (Segunda)': ['IT Guaran√°','Ita Laranja','IT Lim√£o','IT Lemon Ice','IT Cola','Lat√£o Lokal']
  },
  Thauane: {
    'Ambev (Segunda)': [
      'Cracudinha (cascos vazios completos)',
      'Guaran√° Antarctica fora da geladeira',
      'Sukita fora da geladeira',
      'Guaraviton',
      'Gatorade',
      'Suco Tang - Laranja',
      'Suco Tang - Morango',
      'Suco Tang - Guaran√°',
      'Suco Tang - Uva',
      'Suco Tang - Lim√£o',
      'Suco Tang - Maracuj√°',
      'Guaravita',
      '√Ågua com g√°s 500ml',
      '√Ågua com g√°s 1,5L',
      '√Ågua sem g√°s 500ml',
      '√Ågua sem g√°s 1,5L',
      'Corona long',
      'Stella long'
    ],
    'Coca-Cola (Retorn√°veis e Packs)': [
      'Retorn√°vel vazia completa',
      'KS vazia completa',
      'Packs completos de Coca-Cola 2L',
      'Pack completo de Fanta Uva',
      'Pack completo de Fanta Laranja',
      'Guaran√° latinha (Coca)',
      'Garrafinha de Coca 200ml',
      'Garrafinha de Fanta 200ml'
    ]
  },
  Ingrid: {
    'Jardim Am√©rica': ['Antarctica lat√£o','Brahma lat√£o','Imp√©rio lat√£o','Heineken lat√£o','Heineken long'],
    'Fotos (Check)': ['Foto de todas as estantes arrumadas e abastecidas','Foto dos biscoitos','Foto das reservas','Foto dos doces','Foto do freezer com barras de chocolate'],
    'Arm√°rios (Fotos obrigat√≥rias)': []
  },
  Claudia: {
    'Sadia (Segunda)': ['Mortadela comum','Mortadela defumada','Presunto','Calabresa','Salsicha','Hamb√∫rguer'],
    'Queijos': ['Queijo prato','Queijo mussarela','Queijo minas','Minas padr√£o']
  },
  DADA: {
    'Mineirinho (Ter√ßa)': ['Mineirinho 2L','Mineirinho 350ml']
  }
};

/**********************
 * ESTADO
 **********************/
let data = structuredClone(defaultData);
let scores = {};
let tasksDone = [];
let missingReports = [];
let currentUser = '';
let currentWeekKey = '';

/**********************
 * UI HELPERS
 **********************/
const $ = (id) => document.getElementById(id);
function toast(msg){ alert(msg); }
function show(section){ ['login','funcionario','gerente'].forEach(s => $(s).classList.add('hidden')); $(section).classList.remove('hidden'); }

function escapeHtml(str){
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function nowStamp(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  const ss=String(d.getSeconds()).padStart(2,'0');
  return {
    dateFolder: `${yyyy}-${mm}-${dd}`,
    dateBR: `${dd}-${mm}-${yyyy}`,
    timeHMS: `${hh}-${mi}-${ss}`,
    timeCompact: `${hh}${mi}${ss}`,
    human: d.toLocaleString()
  };
}

function safeName(s){
  return String(s).normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').replace(/[^a-zA-Z0-9_-]+/g,'_').slice(0,60);
}

/**********************
 * SEMANA (reset segunda)
 **********************/
function weekKey(date=new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}

async function ensureWeekKey(){
  const metaRef = doc(db,'stores',STORE_ID,'meta','app');
  const snap = await getDoc(metaRef);
  const today = new Date();
  const wk = weekKey(today);

  if (!snap.exists()){
    await setDoc(metaRef,{ currentWeekKey:wk, updatedAt:serverTimestamp() },{ merge:true });
    currentWeekKey = wk;
    return;
  }

  const saved = snap.data().currentWeekKey || wk;
  if (today.getDay() === 1 && saved !== wk){
    await setDoc(metaRef,{ currentWeekKey:wk, updatedAt:serverTimestamp() },{ merge:true });
    currentWeekKey = wk;
    return;
  }

  currentWeekKey = saved;
}

/**********************
 * FIRESTORE INIT + LISTENERS
 **********************/
async function cloudInit(){
  await ensureWeekKey();
  $('weekKeyLabel').innerText = currentWeekKey;
  $('weekKeyLabelGer').innerText = currentWeekKey;

  const cfgRef = doc(db,'stores',STORE_ID,'config','categories');
  const cfgSnap = await getDoc(cfgRef);
  if (!cfgSnap.exists()){
    await setDoc(cfgRef,{ data: defaultData, updatedAt: serverTimestamp() },{ merge:true });
    data = structuredClone(defaultData);
  } else {
    const remote = cfgSnap.data()?.data;
    data = (remote && typeof remote === 'object') ? remote : structuredClone(defaultData);
  }

  onSnapshot(cfgRef,(snap)=>{
    const remote = snap.data()?.data;
    if (remote && typeof remote === 'object'){
      data = remote;
      if (currentUser && currentUser !== 'GERENTE') renderEmployee();
    }
  });

  const scoresRef = doc(db,'stores',STORE_ID,'state','scores');
  const sSnap = await getDoc(scoresRef);
  if (!sSnap.exists()) await setDoc(scoresRef,{ scores:{}, updatedAt:serverTimestamp() },{ merge:true });

  onSnapshot(scoresRef,(snap)=>{
    scores = snap.data()?.scores || {};
    if (currentUser && currentUser !== 'GERENTE') $('score').innerText = scores[currentUser] || 0;
  });

  const tasksQ = query(collection(db,'stores',STORE_ID,'tasks'), orderBy('createdAt','desc'), limit(400));
  onSnapshot(tasksQ,(qs)=>{
    const all = qs.docs.map(d => d.data());
    tasksDone = all.filter(x => x.weekKey === currentWeekKey);
    if (currentUser === 'GERENTE') renderManager();
  });

  const missQ = query(collection(db,'stores',STORE_ID,'missing'), orderBy('createdAt','desc'), limit(400));
  onSnapshot(missQ,(qs)=>{
    const all = qs.docs.map(d => d.data());
    missingReports = all.filter(x => x.weekKey === currentWeekKey);
    if (currentUser === 'GERENTE') renderManager();
  });
}

async function bumpScore(user, delta){
  const scoresRef = doc(db,'stores',STORE_ID,'state','scores');
  await updateDoc(scoresRef, { [`scores.${user}`]: increment(delta), updatedAt: serverTimestamp() });
}

/**********************
 * LOGIN
 **********************/
function isValidPin(p){ return /^[0-9]{4}$/.test(String(p || '')); }

$('btnLogin').addEventListener('click', ()=>{
  const u = $('userSelect').value;
  const p = $('pin').value;
  if (!u) return toast('Selecione o usu√°rio.');
  if (!isValidPin(p)) return toast('PIN precisa ter 4 d√≠gitos.');

  const expected = (u === 'GERENTE') ? pins.GERENTE : pins[u];
  if (!expected) return toast('Usu√°rio sem PIN configurado.');
  if (p !== expected) return toast('PIN incorreto.');

  currentUser = u;
  $('pin').value = '';

  if (u === 'GERENTE'){
    renderManager();
    show('gerente');
  } else {
    renderEmployee();
    show('funcionario');
  }
});

$('btnLogout1').addEventListener('click', ()=>{ currentUser=''; show('login'); });
$('btnLogout2').addEventListener('click', ()=>{ currentUser=''; show('login'); });

/**********************
 * FALTA (cliente pediu e n√£o tem)
 **********************/
$('btnMissing').addEventListener('click', ()=>{
  const box = $('missingBox');
  box.classList.toggle('hidden');
  if (!box.classList.contains('hidden')) $('missingInput').focus();
});

$('missingSave').addEventListener('click', async ()=>{
  const raw = $('missingInput').value.trim();
  if (!raw) return toast('Digite o item em falta.');

  const when = nowStamp();
  await addDoc(collection(db,'stores',STORE_ID,'missing'), {
    user: currentUser,
    item: raw,
    when: when.human,
    weekKey: currentWeekKey,
    createdAt: serverTimestamp()
  });

  $('missingInput').value = '';
  $('missingBox').classList.add('hidden');
  toast('Registrado!');
});

/**********************
 * RENDER FUNCION√ÅRIA
 **********************/
function renderEmployee(){
  $('userName').innerText = currentUser;
  $('score').innerText = scores[currentUser] || 0;
  $('weekKeyLabel').innerText = currentWeekKey;

  $('missingBox').classList.add('hidden');
  $('missingInput').value = '';

  const container = $('tasks');
  container.innerHTML = '';

  const cats = data[currentUser] || {};
  const catNames = Object.keys(cats);
  if (!catNames.length){
    container.innerHTML = "<div class='bg-white p-4 rounded-xl shadow text-gray-600'>Nenhuma categoria cadastrada para este usu√°rio.</div>";
    return;
  }

  catNames.forEach(cat => {
    const card = document.createElement('div');
    card.className = 'bg-white p-4 rounded-xl shadow';

    const isArmarios = cat.toLowerCase().includes('arm√°rios') || cat.toLowerCase().includes('armarios');

    card.innerHTML = `<div class='flex items-center justify-between gap-2'>
      <h3 class='font-semibold'>${escapeHtml(cat)}</h3>
      <span class='text-xs text-gray-500'>+10 ‚≠ê</span>
    </div>`;

    const body = document.createElement('div');
    body.className = 'mt-3 space-y-2';

    const itens = cats[cat] || [];

    if (isArmarios){
      body.innerHTML = `
        <p class='text-sm text-gray-700'>üì∏ Envie as fotos dos arm√°rios (precisa aparecer o arm√°rio inteiro: em cima e em baixo).</p>
        <input type='file' accept='image/*' capture='environment' multiple class='w-full border rounded p-2 bg-white'>
        <p class='text-xs text-gray-500'>As fotos ser√£o enviadas para seu Google Drive (se conectado).</p>
      `;
    } else {
      itens.forEach(item => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-2';
        row.innerHTML = `
          <span class='text-sm text-gray-800'>${escapeHtml(item)}</span>
          <input data-item="${encodeURIComponent(item)}" type='number' min='0' class='w-24 border rounded px-2 py-1 text-right' placeholder='Qtd'>
        `;
        body.appendChild(row);
      });
    }

    const btn = document.createElement('button');
    btn.className = 'mt-4 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded';
    btn.innerText = 'Concluir';

    btn.addEventListener('click', async ()=>{
      const when = nowStamp();

      if (isArmarios){
        const input = body.querySelector("input[type=file]");
        const files = input?.files || [];
        if (!files.length) return toast('Envie pelo menos 1 foto dos arm√°rios antes de concluir.');

        for (const f of files){
          await driveUploadPhoto(f, currentUser, cat, when.dateFolder);
        }
      }

      const itensQtd = {};
      if (!isArmarios){
        body.querySelectorAll("input[type=number]").forEach(inp => {
          const name = decodeURIComponent(inp.getAttribute('data-item'));
          const val = inp.value === '' ? 0 : Number(inp.value);
          itensQtd[name] = Number.isFinite(val) ? val : 0;
        });
      }

      await addDoc(collection(db,'stores',STORE_ID,'tasks'), {
        user: currentUser,
        categoria: cat,
        itens: itensQtd,
        when: when.human,
        weekKey: currentWeekKey,
        createdAt: serverTimestamp()
      });

      await bumpScore(currentUser, 10);

      btn.disabled = true;
      btn.classList.add('opacity-50');
      btn.innerText = '‚úî Conclu√≠do';
    });

    card.appendChild(body);
    card.appendChild(btn);
    container.appendChild(card);
  });
}

/**********************
 * RENDER GERENTE
 **********************/
function renderManager(){
  $('weekKeyLabelGer').innerText = currentWeekKey;

  const t = $('gerTasks');
  t.innerHTML = '';
  const ordered = [...tasksDone].slice(0,250);
  if (!ordered.length){
    t.innerHTML = "<p class='text-gray-500'>Nenhuma tarefa registrada nesta semana.</p>";
  } else {
    ordered.forEach(r => {
      const div = document.createElement('div');
      div.className = 'border rounded p-2 bg-gray-50';
      const itens = r.itens && Object.keys(r.itens).length
        ? Object.entries(r.itens).map(([k,v]) => `${k}: ${v}`).join(' ‚Ä¢ ')
        : '(sem quantidades / ou fotos)';
      div.innerHTML = `<div class='font-semibold'>${escapeHtml(r.user)} ‚Äî ${escapeHtml(r.categoria)}</div>
        <div class='text-xs text-gray-600'>${escapeHtml(r.when)}</div>
        <div class='text-xs mt-1'>${escapeHtml(itens)}</div>`;
      t.appendChild(div);
    });
  }

  const m = $('gerMissing');
  m.innerHTML = '';
  const mo = [...missingReports].slice(0,250);
  if (!mo.length){
    m.innerHTML = "<p class='text-gray-500'>Nenhuma falta registrada nesta semana.</p>";
  } else {
    mo.forEach(r => {
      const div = document.createElement('div');
      div.className = 'border rounded p-2 bg-gray-50';
      div.innerHTML = `<div class='font-semibold'>${escapeHtml(r.user)}</div>
        <div class='text-xs text-gray-600'>${escapeHtml(r.when)}</div>
        <div class='text-sm mt-1'>${escapeHtml(r.item)}</div>`;
      m.appendChild(div);
    });
  }
}

/**********************
 * GERENTE: adicionar categoria
 **********************/
$('btnAddCategory').addEventListener('click', async ()=>{
  if (currentUser !== 'GERENTE') return toast('Apenas o gerente.');
  const u = $('addUser').value;
  const cat = $('categoriaNome').value.trim();
  const items = $('itensCategoria').value.trim();
  if (!cat) return toast('Informe o nome da categoria');

  const newData = structuredClone(data);
  if (!newData[u]) newData[u] = {};
  newData[u][cat] = items ? items.split(',').map(s => s.trim()).filter(Boolean) : [];

  const cfgRef = doc(db,'stores',STORE_ID,'config','categories');
  await setDoc(cfgRef,{ data: newData, updatedAt: serverTimestamp() },{ merge:true });

  $('categoriaNome').value = '';
  $('itensCategoria').value = '';
  toast('Categoria atualizada.');
});

/**********************
 * EXPORT CSV
 **********************/
$('btnExport').addEventListener('click', ()=>{
  if (currentUser !== 'GERENTE') return toast('Apenas o gerente exporta.');
  const header = ['tipo','usuario','categoria','quando','detalhes'];
  let csv = header.join(',') + "
";

  for (const r of tasksDone){
    csv += ['tarefa', r.user, r.categoria, r.when, JSON.stringify(r.itens || {})].map(csvCell).join(',') + "
";
  }
  for (const r of missingReports){
    csv += ['falta', r.user, '', r.when, JSON.stringify({ item:r.item })].map(csvCell).join(',') + "
";
  }

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `relatorio_missoes_${currentWeekKey}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

function csvCell(v){
  const s = String(v ?? '');
  if (/[

,"]/g.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}

/**********************
 * GOOGLE DRIVE (FOTOS)
 **********************/
let driveToken = null;
let tokenClient = null;
let driveRootId = null;

function setDriveStatus(ok){
  $('btnDriveStatus').disabled = false;
  $('btnDriveStatus').innerText = ok ? 'Drive: conectado' : 'Drive: desconectado';
  $('btnDriveStatus').className = ok ? 'bg-emerald-100 text-emerald-900 p-2 rounded' : 'bg-gray-200 text-gray-900 p-2 rounded';
}

$('btnDriveConnect').addEventListener('click', async ()=>{
  if (!GOOGLE_CLIENT_ID) return toast('Client ID n√£o configurado.');
  if (!window.google || !google.accounts || !google.accounts.oauth2){
    return toast('OAuth do Google ainda n√£o carregou. Tente novamente em 2 segundos.');
  }

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.file',
    callback: async (resp)=>{
      if (resp.error){
        console.error(resp);
        setDriveStatus(false);
        return toast('Falha ao conectar no Google Drive.');
      }
      driveToken = resp.access_token;
      setDriveStatus(true);
      driveRootId = await ensureFolder(DRIVE_ROOT_FOLDER_NAME, null);
      toast('Google Drive conectado!');
    }
  });

  tokenClient.requestAccessToken({ prompt: 'consent' });
});

async function driveFetch(url, options={}){
  if (!driveToken) return null;
  const headers = options.headers || {};
  headers['Authorization'] = `Bearer ${driveToken}`;
  options.headers = headers;
  const res = await fetch(url, options);
  if (!res.ok){
    const t = await res.text().catch(()=> '');
    console.warn('Drive error', res.status, t);
    return null;
  }
  return res;
}

async function ensureFolder(name, parentId){
  if (!driveToken) return null;
  const safe = String(name).replaceAll("'","\'");
  const qParts = [
    `mimeType='application/vnd.google-apps.folder'`,
    `name='${safe}'`,
    'trashed=false'
  ];
  if (parentId) qParts.push(`'${parentId}' in parents`);
  const q = qParts.join(' and ');

  const listUrl = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)`;
  const listRes = await driveFetch(listUrl);
  if (listRes){
    const js = await listRes.json();
    if (js.files && js.files.length) return js.files[0].id;
  }

  const meta = { name, mimeType:'application/vnd.google-apps.folder' };
  if (parentId) meta.parents = [parentId];

  const createRes = await driveFetch('https://www.googleapis.com/drive/v3/files', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(meta)
  });
  if (!createRes) return null;
  const created = await createRes.json();
  return created.id;
}

async function driveUploadPhoto(file, user, categoria, dateFolder){
  if (!driveToken){
    toast('Drive desconectado. Conecte o Google Drive para enviar fotos.');
    return;
  }
  if (!driveRootId) driveRootId = await ensureFolder(DRIVE_ROOT_FOLDER_NAME, null);
  const dayId = await ensureFolder(dateFolder, driveRootId);

  const stamp = nowStamp();
  const filename = `${safeName(categoria)}_${safeName(user)}_${stamp.dateBR}_${stamp.timeHMS}.jpg`;
  const metadata = { name: filename, parents:[dayId] };

  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type:'application/json' }));
  form.append('file', file);

  const res = await driveFetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', {
    method:'POST',
    body: form
  });

  if (!res) toast('Falha ao enviar foto para o Drive.');
}

/**********************
 * TESTES (sanidade)
 **********************/
console.assert(document.querySelector('head') && document.querySelector('body'), 'HTML deve ter head e body');
console.assert(typeof pins === 'object', 'pins deve existir');
console.assert(pins.Sandra === '1111', 'PIN Sandra deve estar fixo');

/**********************
 * BOOT
 **********************/
setDriveStatus(false);
await cloudInit();
console.log('BUILD OK - App pronto (Firestore + Login)');
window.__BUILD_OK__ = true;
</script>

</body>
</html>
