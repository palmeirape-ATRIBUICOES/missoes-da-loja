<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missoes da Loja</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-3xl mx-auto mb-4">
  <h1 class="text-2xl font-bold text-center">Missoes da Loja</h1>
  <p class="text-center text-sm text-gray-600 mt-1">
    PIN (criado pelo usuário) • Checklist • Falta • Gerente em tempo real • Global • Escala
  </p>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usuário</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Carregando...</option>
      </select>
      <p class="text-xs text-gray-500 mt-1">
        Primeiro acesso: digite um PIN e clique em <b>Entrar</b> para criar.
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Usuários bloqueados não aparecem aqui.
      </p>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 dígitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234"
             class="w-full border p-2 rounded" />
      <p class="text-xs text-gray-500 mt-1">
        O PIN é salvo com hash no Firestore.
      </p>
    </div>

    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Entrar
      </button>
    </div>
  </div>

  <div class="mt-4 border-t pt-4">
    <h3 class="font-semibold mb-2">Fotos (Armários)</h3>
    <p class="text-sm text-gray-700">
      Armários envia fotos para o <b>Firebase Storage</b>.
    </p>
  </div>
</section>

<!-- FUNCIONÁRIO -->
<section id="funcionario" class="hidden max-w-3xl mx-auto">

  <!-- Escala (visível para todos; editor só Claudia) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between gap-2">
      <div>
        <h2 class="text-lg font-semibold">Escala da Semana</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelEscala">-</span></p>
      </div>
      <div class="text-xs text-gray-500">
        <span id="escalaPermLabel">Somente leitura</span>
      </div>
    </div>

    <!-- Viewer -->
    <div id="escalaViewer" class="mt-3 text-sm space-y-2"></div>

    <!-- Editor (só Claudia e Gerente) -->
    <div id="escalaEditorWrap" class="hidden mt-4 border-t pt-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-sm">Editar escala</div>
        <button id="btnSaveEscala" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
          Salvar escala
        </button>
      </div>
      <p class="text-xs text-gray-500 mt-2">
        Regras: Manhã e Tarde sempre 2 funcionários • Ninguém dobra (mesmo dia) • Folga 1 funcionário.
      </p>
      <div id="escalaEditor" class="mt-3 space-y-3"></div>
    </div>
  </div>

  <!-- topo usuário -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Usuário: <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontuação: <span id="score">0</span></p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnMissing" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Cliente pediu e não tem
        </button>
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>

    <div id="missingBox" class="hidden mt-4 border-t pt-4">
      <label class="text-sm text-gray-700">O que o cliente pediu e não temos?</label>
      <div class="flex gap-2 mt-2">
        <input id="missingInput" class="flex-1 border rounded p-2" placeholder="Digite o item em falta" />
        <button id="missingSave" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- Tarefas (inclui GLOBAL + pessoais) -->
  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Painel do Gerente</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelGer">-</span></p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="btnResetWeek" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Zerar semana (tudo)
        </button>
        <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">
          Exportar CSV
        </button>
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Agora você também pode apagar tarefas por funcionário (abaixo).
    </p>
  </div>

  <!-- GLOBAL (criar tarefa para todos) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <h3 class="font-semibold mb-2">Criar categoria GLOBAL (para todos)</h3>
    <p class="text-xs text-gray-500 mb-3">
      Ela aparece para todos os usuários ativos. Quem concluir primeiro, “trava” e some dos demais.
    </p>

    <div class="grid md:grid-cols-4 gap-2">
      <input id="globalCatName" class="border p-2 rounded md:col-span-2" placeholder="Nome (ex: Conferir geladeira)" />
      <input id="globalCatItems" class="border p-2 rounded md:col-span-2" placeholder="Itens separados por vírgula (ex: Coca, Guaraná...)" />
    </div>
    <button id="btnCreateGlobal" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full">
      Criar GLOBAL
    </button>

    <div class="mt-3 border-t pt-3">
      <div class="text-sm font-semibold mb-2">GLOBAL pendente nesta semana</div>
      <div id="globalStatus" class="text-sm text-gray-700">Carregando...</div>
    </div>
  </div>

  <!-- Escala (gerente pode editar também) -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="font-semibold">Escala da Semana</h3>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelEscalaGer">-</span></p>
      </div>
      <button id="btnSaveEscalaGer" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-sm">
        Salvar escala
      </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Regras: Manhã e Tarde sempre 2 funcionários • Ninguém dobra (mesmo dia) • Folga 1 funcionário.
    </p>
    <div id="escalaEditorGer" class="mt-3 space-y-3"></div>
  </div>

  <!-- tarefas e faltas -->
  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Tarefas concluídas (semana)</h3>
      <div id="gerTasks" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Itens em falta</h3>
      <div id="gerMissing" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- apagar tarefas por funcionário -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Apagar tarefas por funcionário (semana)</h3>
    <div class="grid md:grid-cols-3 gap-2">
      <select id="delTasksUser" class="border p-2 rounded"></select>
      <button id="btnLoadUserTasks" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Carregar tarefas
      </button>
      <button id="btnDeleteSelectedTasks" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded">
        Apagar selecionadas
      </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Marque as tarefas e apague. Isso não mexe na pontuação automaticamente (se quiser, eu adiciono depois).
    </p>
    <div id="userTasksList" class="mt-3 space-y-2"></div>
  </div>

  <!-- FUNCIONÁRIOS -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Funcionários (Ativar / Bloquear)</h3>
    <p class="text-xs text-gray-500 mb-3">
      Bloqueado não aparece no login. Você ainda consegue editar categorias e PINs dele.
    </p>

    <div class="grid md:grid-cols-3 gap-2">
      <input id="newEmployeeName" class="border p-2 rounded" placeholder="Nome do funcionário (ex: Ingrid)" />
      <button id="btnAddEmployee" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Adicionar (Ativo)
      </button>
      <button id="btnRefreshEmployees" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Recarregar lista
      </button>
    </div>

    <div id="employeeTable" class="mt-3 space-y-2"></div>
  </div>

  <!-- CATEGORIAS: ADD/UPDATE -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Adicionar / Atualizar categoria (individual)</h3>
    <div class="grid md:grid-cols-4 gap-2">
      <select id="addUser" class="border p-2 rounded"></select>
      <input id="categoriaNome" placeholder="Nome da categoria" class="border p-2 rounded" />
      <input id="itensCategoria" placeholder="Itens separados por vírgula" class="border p-2 rounded md:col-span-2" />
    </div>
    <button id="btnAddCategory" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full">
      Adicionar / Atualizar categoria
    </button>
    <p class="text-xs text-gray-500 mt-2">
      Para categoria ARMÁRIOS, deixe itens vazio para liberar upload de fotos.
    </p>
  </div>

  <!-- CATEGORIAS: EDITAR / EXCLUIR -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Editar / Renomear / Excluir categoria (individual)</h3>

    <div class="grid md:grid-cols-4 gap-2">
      <select id="editUser" class="border p-2 rounded"></select>
      <select id="editCatSelect" class="border p-2 rounded md:col-span-2">
        <option value="">Selecione uma categoria...</option>
      </select>
      <button id="btnLoadCategory" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Carregar
      </button>
    </div>

    <div class="grid md:grid-cols-4 gap-2 mt-2">
      <input id="editCatName" placeholder="Nome da categoria (para renomear opcional)" class="border p-2 rounded md:col-span-2" />
      <button id="btnRenameCategory" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded">
        Renomear
      </button>
      <button id="btnDeleteCategory" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded">
        Excluir
      </button>
    </div>

    <textarea id="editItemsArea" rows="4" class="w-full border p-2 rounded mt-2"
      placeholder="Edite os itens separados por vírgula. Para ARMÁRIOS deixe vazio."></textarea>

    <button id="btnSaveCategory" class="mt-2 bg-emerald-600 hover:bg-emerald-700 text-white p-2 rounded w-full">
      Salvar alterações nos itens
    </button>
  </div>

  <!-- PINS -->
  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">PINs</h3>
    <div class="grid md:grid-cols-3 gap-2 mt-2">
      <select id="pinUser" class="border p-2 rounded"></select>
      <input id="pinNew" class="border p-2 rounded" inputmode="numeric" maxlength="4" placeholder="Novo PIN (4 dígitos)" />
      <button id="btnSetPin" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Definir / Resetar PIN
      </button>
    </div>

    <p class="text-xs text-gray-500 mt-2">
      PIN mestre inicial do gerente: <b>1234</b> só se o gerente ainda não tiver PIN criado.
    </p>
  </div>
</section>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
    authDomain: "missoes-drive.firebaseapp.com",
    projectId: "missoes-drive",
    storageBucket: "missoes-drive.firebasestorage.app",
    messagingSenderId: "198254465545",
    appId: "1:198254465545:web:dce028792e2c2c57161ed8"
  };

  const STORE_ID = "loja_principal";
  const SESSION_KEY = "mdl_session_v1";
  const MASTER_MANAGER_PIN = "1234";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    onSnapshot, query, orderBy, limit, serverTimestamp, increment,
    deleteDoc, getDocs, writeBatch, where, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage, ref as sref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const $ = (id) => document.getElementById(id);
  function toast(msg){ alert(msg); }
  function show(section){
    ["login","funcionario","gerente"].forEach(s => $(s).classList.add("hidden"));
    $(section).classList.remove("hidden");
  }
  function isValidPin(p){ return /^[0-9]{4}$/.test(String(p || "")); }
  function nowHuman(){ return new Date().toLocaleString(); }
  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
  function normalizeName(name){ return String(name||"").trim().replace(/\s+/g," "); }
  function normalizeCat(name){ return String(name||"").trim().replace(/\s+/g," "); }

  // Estado
  let data = {};
  let scores = {};
  let tasksDone = [];
  let missingReports = [];
  let currentUser = "";
  let currentWeekKey = "";
  let employees = []; // [{name, active}]
  let globalTask = null; // {id, ...}
  let escala = null; // {weekKey, days:{...}}

  // Refs
  const cfgCatsRef = () => doc(db,"stores",STORE_ID,"config","categories");
  const cfgAppRef  = () => doc(db,"stores",STORE_ID,"config","app");
  const scoresRef  = () => doc(db,"stores",STORE_ID,"state","scores");
  const metaRef    = () => doc(db,"stores",STORE_ID,"meta","app");
  const userRef    = (user) => doc(db,"stores",STORE_ID,"users",user);
  const escalaRef  = (wk) => doc(db,"stores",STORE_ID,"state","escala_"+wk);
  const globalRef  = (wk) => doc(db,"stores",STORE_ID,"state","global_"+wk);

  // SHA-256
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // Semana ISO (reset segunda)
  function weekKey(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return d.getUTCFullYear() + "-W" + String(weekNo).padStart(2,"0");
  }

  async function ensureWeekKey(){
    const snap = await getDoc(metaRef());
    const today = new Date();
    const wk = weekKey(today);

    if (!snap.exists()){
      await setDoc(metaRef(),{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    const saved = snap.data().currentWeekKey || wk;
    if (today.getDay() === 1 && saved !== wk){
      await setDoc(metaRef(),{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    currentWeekKey = saved;
  }

  // Sessão
  function saveSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify({ user, at: Date.now() })); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj && obj.user ? obj : null;
    } catch(e){ return null; }
  }

  // ===== Funcionários =====
  const defaultEmployeesLegacy = ["Sandra","Thauane","Ingrid","Claudia","DADA"];
  const defaultEmployees = defaultEmployeesLegacy.map(n => ({ name: n, active: true }));

  function isEmployeeActive(name){
    const n = normalizeName(name);
    const e = employees.find(x => x.name === n);
    return !!(e && e.active);
  }
  function activeNames(){
    return employees.filter(e=>e.active).map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }
  function allNames(){
    return employees.map(e=>e.name).sort((a,b)=>a.localeCompare(b));
  }

  async function ensureEmployeesConfig(){
    const snap = await getDoc(cfgAppRef());

    if (!snap.exists()){
      await setDoc(cfgAppRef(), { employees: defaultEmployees, updatedAt: serverTimestamp() }, { merge:true });
      employees = clone(defaultEmployees);
      return;
    }

    const raw = snap.data().employees;

    if (Array.isArray(raw) && raw.length > 0 && typeof raw[0] === "string"){
      const migrated = raw.map(n => ({ name: normalizeName(n), active: true })).filter(x=>x.name);
      await setDoc(cfgAppRef(), { employees: migrated, updatedAt: serverTimestamp() }, { merge:true });
      employees = migrated;
      return;
    }

    if (!Array.isArray(raw) || raw.length === 0){
      await setDoc(cfgAppRef(), { employees: defaultEmployees, updatedAt: serverTimestamp() }, { merge:true });
      employees = clone(defaultEmployees);
      return;
    }

    employees = raw
      .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
      .filter(x => x.name);

    const seen = new Set();
    employees = employees.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
  }

  async function setEmployees(next){
    const cleaned = next
      .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
      .filter(x => x.name && x.name.toUpperCase() !== "GERENTE");

    const seen = new Set();
    const unique = cleaned.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
    unique.sort((a,b)=>a.name.localeCompare(b.name));
    await setDoc(cfgAppRef(), { employees: unique, updatedAt: serverTimestamp() }, { merge:true });
  }

  async function addEmployee(name){
    name = normalizeName(name);
    if (!name) return toast("Digite um nome.");
    if (name.toUpperCase() === "GERENTE") return toast("Nome inválido.");
    if (employees.some(e => e.name === name)) return toast("Esse funcionário já existe.");

    const next = employees.concat([{ name, active: true }]);
    await setEmployees(next);

    const newCats = clone(data || {});
    if (!newCats[name]) newCats[name] = {};
    await setDoc(cfgCatsRef(), { data: newCats, updatedAt: serverTimestamp() }, { merge:false });
    toast("Funcionário adicionado (ativo).");
  }

  async function toggleEmployee(name, active){
    name = normalizeName(name);
    const next = employees.map(e => e.name === name ? ({ ...e, active: !!active }) : e);
    await setEmployees(next);
  }

  function fillSelect(selectEl, values, includeManager=false, placeholder=null){
    if (!selectEl) return;
    const prev = selectEl.value;
    selectEl.innerHTML = "";
    if (placeholder !== null){
      selectEl.appendChild(new Option(placeholder, ""));
    }
    if (includeManager){
      selectEl.appendChild(new Option("GERENTE", "GERENTE"));
    }
    values.forEach(v => selectEl.appendChild(new Option(v, v)));
    if (prev && Array.from(selectEl.options).some(o=>o.value===prev)) selectEl.value = prev;
  }

  function renderEmployeesUI(){
    const loginSel = $("userSelect");
    loginSel.innerHTML = "";
    loginSel.appendChild(new Option("Selecione", ""));
    loginSel.appendChild(new Option("Gerente", "GERENTE"));
    activeNames().forEach(n => loginSel.appendChild(new Option(n, n)));

    const namesAll = allNames();
    fillSelect($("addUser"), namesAll, false, null);
    fillSelect($("editUser"), namesAll, false, null);
    fillSelect($("pinUser"), namesAll, true, null);

    // apagar tarefas: só funcionários (não gerente)
    fillSelect($("delTasksUser"), namesAll.filter(n=>n.toUpperCase()!=="GERENTE"), false, "Selecione um funcionário...");

    // tabela
    const wrap = $("employeeTable");
    if (!wrap) return;
    wrap.innerHTML = "";
    employees.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach((e)=>{
      const row = document.createElement("div");
      row.className = "flex items-center justify-between gap-2 border rounded p-2 bg-gray-50";
      const badge = e.active
        ? "<span class='text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-800'>ATIVO</span>"
        : "<span class='text-xs px-2 py-1 rounded bg-red-100 text-red-800'>BLOQUEADO</span>";
      row.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="font-semibold text-sm">${e.name}</div>
          ${badge}
        </div>
        <div class="flex gap-2">
          <button class="btnToggle px-3 py-1 rounded text-xs ${e.active ? "bg-red-600 hover:bg-red-700 text-white" : "bg-emerald-600 hover:bg-emerald-700 text-white"}"
            data-name="${encodeURIComponent(e.name)}" data-active="${e.active ? "1" : "0"}">
            ${e.active ? "Bloquear" : "Ativar"}
          </button>
        </div>
      `;
      wrap.appendChild(row);
    });

    wrap.querySelectorAll(".btnToggle").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const name = decodeURIComponent(btn.getAttribute("data-name") || "");
        const isActive = btn.getAttribute("data-active") === "1";
        const action = isActive ? "bloquear" : "ativar";
        if (!confirm(`Deseja ${action} "${name}"?`)) return;
        await toggleEmployee(name, !isActive);
        toast(`Funcionário ${action}do.`);
      });
    });
  }

  // ===== Categorias base =====
  const defaultData = {
    Sandra: { "Pedido Itaipava (Segunda)": ["IT Guarana","Ita Laranja","IT Limao","IT Lemon Ice","IT Cola","Latao Lokal"] },
    Thauane: {
      "Ambev (Segunda)": [
        "Cracudinha (cascos vazios completos)","Guarana Antarctica fora da geladeira","Sukita fora da geladeira",
        "Guaraviton","Gatorade","Suco Tang - Laranja","Suco Tang - Morango","Suco Tang - Guarana","Suco Tang - Uva",
        "Suco Tang - Limao","Suco Tang - Maracuja","Guaravita","Agua com gas 500ml","Agua com gas 1,5L",
        "Agua sem gas 500ml","Agua sem gas 1,5L","Corona long","Stella long"
      ],
      "Coca-Cola (Retornaveis e Packs)": [
        "Retornavel vazia completa","KS vazia completa","Packs completos de Coca-Cola 2L","Pack completo de Fanta Uva",
        "Pack completo de Fanta Laranja","Guarana latinha (Coca)","Garrafinha de Coca 200ml","Garrafinha de Fanta 200ml"
      ]
    },
    Ingrid: {
      "Jardim America": ["Antarctica latao","Brahma latao","Imperio latao","Heineken latao","Heineken long"],
      "Fotos (Check)": [
        "Foto de todas as estantes arrumadas e abastecidas","Foto dos biscoitos","Foto das reservas",
        "Foto dos doces","Foto do freezer com barras de chocolate"
      ],
      "Armarios (Fotos obrigatorias)": []
    },
    Claudia: {
      "Sadia (Segunda)": ["Mortadela comum","Mortadela defumada","Presunto","Calabresa","Salsicha","Hamburguer"],
      "Queijos": ["Queijo prato","Queijo mussarela","Queijo minas","Minas padrao"]
    },
    DADA: { "Mineirinho (Terca)": ["Mineirinho 2L","Mineirinho 350ml"] }
  };

  // ===== PIN =====
  async function ensureUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (snap.exists()) return { created:false };
    await setDoc(userRef(user), {
      user,
      role: (user === "GERENTE") ? "manager" : "employee",
      pinHash: await sha256(pin),
      createdAt: serverTimestamp()
    }, { merge:true });
    return { created:true };
  }

  async function verifyUserPin(user, pin){
    const snap = await getDoc(userRef(user));
    if (!snap.exists()){
      if (user === "GERENTE" && pin === MASTER_MANAGER_PIN){
        await ensureUserPin(user, pin);
        return { ok:true, usedMaster:true };
      }
      return { ok:false, noUser:true };
    }
    const pinHash = snap.data().pinHash || "";
    return { ok: (await sha256(pin)) === pinHash, noUser:false };
  }

  // ===== Storage (Armários) =====
  async function uploadArmariosPhotos(files, user, cat){
    const urls = [];
    const ts = Date.now();
    let idx = 0;
    for (const f of files){
      idx++;
      const safeName = String(f.name || ("foto_"+idx)).replace(/[^\w.\-]+/g, "_");
      const path = `stores/${STORE_ID}/weeks/${currentWeekKey}/${user}/${cat.replace(/[^\w.\-]+/g,"_")}/${ts}_${idx}_${safeName}`;
      const r = sref(storage, path);
      await uploadBytes(r, f);
      urls.push(await getDownloadURL(r));
    }
    return urls;
  }

  function isCategoryDoneThisWeek(user, cat){
    return tasksDone.some(t => t.user === user && t.categoria === cat && t.weekKey === currentWeekKey);
  }

  // ===== GLOBAL (para todos) =====
  function getGlobalStatusText(){
    if (!globalTask || !globalTask.exists) return "Nenhuma GLOBAL criada nesta semana.";
    if (globalTask.status === "completed") return `GLOBAL concluída por ${globalTask.completedBy} em ${globalTask.completedAtHuman || ""}`;
    if (globalTask.status === "open") return `GLOBAL pendente: ${globalTask.name || "(sem nome)"} (aguardando conclusão)`;
    return "GLOBAL: estado desconhecido.";
  }

  async function createGlobalTask(name, itemsArr){
    const ref = globalRef(currentWeekKey);
    // sobrescreve a global da semana (se quiser impedir, me fala)
    await setDoc(ref, {
      exists: true,
      weekKey: currentWeekKey,
      status: "open",
      name,
      items: itemsArr,
      createdAt: serverTimestamp(),
      createdAtHuman: nowHuman()
    }, { merge:false });
  }

  async function completeGlobalTaskAsFirst(user, itensQtd, photos){
    const ref = globalRef(currentWeekKey);

    // trava: só o primeiro consegue mudar de open -> completed
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if (!snap.exists()) throw new Error("GLOBAL não existe.");
      const g = snap.data();
      if (!g.exists || g.status !== "open") throw new Error("GLOBAL já foi concluída.");
      tx.update(ref, {
        status: "completed",
        completedBy: user,
        completedAt: serverTimestamp(),
        completedAtHuman: nowHuman()
      });
    });

    // registra como tarefa comum (para o gerente ver detalhes)
    await addDoc(collection(db,"stores",STORE_ID,"tasks"), {
      user,
      categoria: "[GLOBAL] " + (globalTask?.name || "GLOBAL"),
      itens: itensQtd || {},
      photos: photos || [],
      when: nowHuman(),
      weekKey: currentWeekKey,
      createdAt: serverTimestamp()
    });

    await bumpScore(user, 10);
  }

  // ===== ESCALA =====
  const DAYS = ["Segunda","Terça","Quarta","Quinta","Sexta","Sábado","Domingo"];

  function emptyEscala(){
    const days = {};
    for (const d of DAYS){
      days[d] = {
        manha: ["",""],
        tarde: ["",""],
        folga: [""]
      };
    }
    return { weekKey: currentWeekKey, days };
  }

  function canEditEscala(){
    return currentUser === "GERENTE" || currentUser === "Claudia";
  }

  function validateEscala(obj){
    // Regras:
    // - manhã e tarde: 2 pessoas e não podem ser iguais
    // - folga: 1 pessoa
    // - ninguém dobra: não pode aparecer em manhã e tarde no mesmo dia
    // - folga não pode estar em manhã/tarde no mesmo dia
    for (const d of DAYS){
      const day = obj?.days?.[d];
      if (!day) return `Dia inválido: ${d}`;

      const m1 = normalizeName(day.manha?.[0] || "");
      const m2 = normalizeName(day.manha?.[1] || "");
      const t1 = normalizeName(day.tarde?.[0] || "");
      const t2 = normalizeName(day.tarde?.[1] || "");
      const f  = normalizeName(day.folga?.[0] || "");

      if (!m1 || !m2) return `${d}: Manhã precisa ter 2 funcionários.`;
      if (m1 === m2) return `${d}: Manhã não pode repetir o mesmo funcionário.`;

      if (!t1 || !t2) return `${d}: Tarde precisa ter 2 funcionários.`;
      if (t1 === t2) return `${d}: Tarde não pode repetir o mesmo funcionário.`;

      if (!f) return `${d}: Folga precisa ter 1 funcionário.`;

      const setWork = new Set([m1,m2,t1,t2].filter(Boolean));
      if (setWork.has(f)) return `${d}: Folga não pode ser alguém que trabalha no mesmo dia.`;

      // dobrar
      const setManha = new Set([m1,m2]);
      if (setManha.has(t1) || setManha.has(t2)) return `${d}: Não é permitido dobrar (mesma pessoa manhã+tarde).`;
    }
    return null;
  }

  async function saveEscala(obj){
    const err = validateEscala(obj);
    if (err) return toast(err);

    await setDoc(escalaRef(currentWeekKey), {
      exists: true,
      weekKey: currentWeekKey,
      days: obj.days,
      updatedAt: serverTimestamp(),
      updatedAtHuman: nowHuman(),
      updatedBy: currentUser
    }, { merge:false });

    toast("Escala salva.");
  }

  function renderEscalaViewer(){
    $("weekKeyLabelEscala").innerText = currentWeekKey;
    const view = $("escalaViewer");
    view.innerHTML = "";

    const s = escala && escala.exists ? escala : null;
    if (!s){
      view.innerHTML = `<div class="text-gray-500">Sem escala cadastrada ainda.</div>`;
      return;
    }

    const box = document.createElement("div");
    box.className = "border rounded p-2 bg-gray-50";

    let html = `<div class="text-xs text-gray-600">Atualizada por <b>${s.updatedBy || "-"}</b> em ${s.updatedAtHuman || "-"}</div>`;
    html += `<div class="mt-2 space-y-2">`;

    for (const d of DAYS){
      const day = s.days?.[d] || {};
      const manha = (day.manha||[]).filter(Boolean).join(" + ") || "-";
      const tarde = (day.tarde||[]).filter(Boolean).join(" + ") || "-";
      const folga = (day.folga||[]).filter(Boolean).join(" + ") || "-";
      html += `
        <div class="border rounded bg-white p-2">
          <div class="font-semibold">${d}</div>
          <div class="text-sm mt-1"><b>Manhã:</b> ${manha}</div>
          <div class="text-sm"><b>Tarde:</b> ${tarde}</div>
          <div class="text-sm"><b>Folga:</b> ${folga}</div>
        </div>
      `;
    }

    html += `</div>`;
    box.innerHTML = html;
    view.appendChild(box);
  }

  function buildSelect(options, value){
    const sel = document.createElement("select");
    sel.className = "border p-2 rounded w-full";
    sel.appendChild(new Option("Selecione...", ""));
    options.forEach(n => sel.appendChild(new Option(n, n)));
    sel.value = value || "";
    return sel;
  }

  function renderEscalaEditor(containerId, onSaveBtnId=null){
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = "";
    const names = activeNames(); // só ativos para escalar

    const base = (escala && escala.exists) ? escala : emptyEscala();
    const local = clone(base);

    for (const d of DAYS){
      const day = local.days[d];

      const row = document.createElement("div");
      row.className = "border rounded p-3 bg-gray-50";

      const title = document.createElement("div");
      title.className = "font-semibold mb-2";
      title.innerText = d;

      const grid = document.createElement("div");
      grid.className = "grid md:grid-cols-3 gap-2";

      // manhã (2)
      const mWrap = document.createElement("div");
      mWrap.innerHTML = `<div class="text-xs text-gray-600 mb-1">Manhã (2)</div>`;
      const m1 = buildSelect(names, day.manha[0]);
      const m2 = buildSelect(names, day.manha[1]);
      mWrap.appendChild(m1);
      mWrap.appendChild(document.createElement("div")).className = "h-2";
      mWrap.appendChild(m2);

      // tarde (2)
      const tWrap = document.createElement("div");
      tWrap.innerHTML = `<div class="text-xs text-gray-600 mb-1">Tarde (2)</div>`;
      const t1 = buildSelect(names, day.tarde[0]);
      const t2 = buildSelect(names, day.tarde[1]);
      tWrap.appendChild(t1);
      tWrap.appendChild(document.createElement("div")).className = "h-2";
      tWrap.appendChild(t2);

      // folga (1)
      const fWrap = document.createElement("div");
      fWrap.innerHTML = `<div class="text-xs text-gray-600 mb-1">Folga (1)</div>`;
      const f1 = buildSelect(names, day.folga[0]);
      fWrap.appendChild(f1);

      grid.appendChild(mWrap);
      grid.appendChild(tWrap);
      grid.appendChild(fWrap);

      row.appendChild(title);
      row.appendChild(grid);
      container.appendChild(row);

      // bind
      const bind = ()=>{
        day.manha[0] = normalizeName(m1.value);
        day.manha[1] = normalizeName(m2.value);
        day.tarde[0] = normalizeName(t1.value);
        day.tarde[1] = normalizeName(t2.value);
        day.folga[0] = normalizeName(f1.value);
      };
      [m1,m2,t1,t2,f1].forEach(x => x.addEventListener("change", bind));
      bind();
    }

    // bind save button if provided
    if (onSaveBtnId){
      const btn = $(onSaveBtnId);
      if (btn){
        btn.onclick = async ()=> {
          await saveEscala(local);
        };
      }
    }

    return local;
  }

  // ===== Helpers pontuação =====
  async function bumpScore(user, delta){
    await updateDoc(scoresRef(), { ["scores."+user]: increment(delta), updatedAt: serverTimestamp() });
  }

  // ===== Cloud init =====
  async function cloudInit(){
    await ensureWeekKey();
    $("weekKeyLabel").innerText = currentWeekKey;
    $("weekKeyLabelGer").innerText = currentWeekKey;
    $("weekKeyLabelEscala").innerText = currentWeekKey;
    $("weekKeyLabelEscalaGer").innerText = currentWeekKey;

    await ensureEmployeesConfig();
    renderEmployeesUI();

    onSnapshot(cfgAppRef(), async (snap)=>{
      if (!snap.exists()) return;
      const raw = snap.data().employees;
      if (Array.isArray(raw) && raw.length > 0 && typeof raw[0] === "string"){
        const migrated = raw.map(n => ({ name: normalizeName(n), active: true })).filter(x=>x.name);
        await setDoc(cfgAppRef(), { employees: migrated, updatedAt: serverTimestamp() }, { merge:true });
        employees = migrated;
      } else {
        employees = (Array.isArray(raw) ? raw : [])
          .map(x => ({ name: normalizeName(x?.name), active: !!x?.active }))
          .filter(x => x.name);
        const seen = new Set();
        employees = employees.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
      }

      renderEmployeesUI();

      // re-render escala editors (listas podem mudar)
      if (currentUser === "GERENTE"){
        renderEscalaEditor("escalaEditorGer", "btnSaveEscalaGer");
      } else if (currentUser){
        maybeSetupEscalaUI();
      }

      // derruba se bloquear
      if (currentUser && currentUser !== "GERENTE"){
        if (!isEmployeeActive(currentUser)){
          clearSession();
          currentUser = "";
          toast("Usuário bloqueado. Faça login novamente.");
          show("login");
        }
      }
    });

    // categories
    const catsSnap = await getDoc(cfgCatsRef());
    if (!catsSnap.exists()){
      await setDoc(cfgCatsRef(), { data: defaultData, updatedAt: serverTimestamp() }, { merge:false });
      data = clone(defaultData);
    } else {
      const remote = catsSnap.data().data;
      data = (remote && typeof remote === "object") ? remote : clone(defaultData);
    }

    onSnapshot(cfgCatsRef(), (snap)=>{
      const remote = snap.data().data;
      if (remote && typeof remote === "object"){
        data = remote;
        if (currentUser && currentUser !== "GERENTE") renderEmployee();
        if (currentUser === "GERENTE") { renderManager(); refreshCategoryEditorLists(); }
      }
    });

    // scores
    const sSnap = await getDoc(scoresRef());
    if (!sSnap.exists()) await setDoc(scoresRef(), { scores: {}, updatedAt: serverTimestamp() }, { merge:true });

    onSnapshot(scoresRef(), (snap)=>{
      scores = snap.data().scores || {};
      if (currentUser && currentUser !== "GERENTE"){
        $("score").innerText = scores[currentUser] || 0;
      }
    });

    // tasks
    const tasksQ = query(collection(db,"stores",STORE_ID,"tasks"), orderBy("createdAt","desc"), limit(700));
    onSnapshot(tasksQ, (qs)=>{
      const all = qs.docs.map(d => ({ id:d.id, ...d.data() }));
      tasksDone = all.filter(x=>x.weekKey === currentWeekKey);
      if (currentUser === "GERENTE") renderManager();
      if (currentUser && currentUser !== "GERENTE") renderEmployee();
    });

    // missing
    const missQ = query(collection(db,"stores",STORE_ID,"missing"), orderBy("createdAt","desc"), limit(700));
    onSnapshot(missQ, (qs)=>{
      const all = qs.docs.map(d => ({ id:d.id, ...d.data() }));
      missingReports = all.filter(x=>x.weekKey === currentWeekKey);
      if (currentUser === "GERENTE") renderManager();
    });

    // global doc (semana)
    onSnapshot(globalRef(currentWeekKey), (snap)=>{
      if (!snap.exists()){
        globalTask = null;
      } else {
        globalTask = { id: snap.id, ...snap.data() };
      }

      // painel gerente
      if ($("globalStatus")){
        $("globalStatus").innerText = getGlobalStatusText();
      }

      // atualiza tarefas do funcionário
      if (currentUser && currentUser !== "GERENTE"){
        renderEmployee();
      }
    });

    // escala doc
    onSnapshot(escalaRef(currentWeekKey), (snap)=>{
      if (!snap.exists()){
        escala = null;
      } else {
        escala = { id: snap.id, ...snap.data() };
      }
      if (currentUser === "GERENTE"){
        // reconstruir editor no gerente (com os valores atuais)
        renderEscalaEditor("escalaEditorGer", "btnSaveEscalaGer");
      }
      if (currentUser && currentUser !== "GERENTE"){
        renderEscalaViewer();
        maybeSetupEscalaUI();
      }
    });

    // inicializa viewer escala mesmo sem doc
    renderEscalaViewer();
  }

  // ===== Login =====
  $("btnLogin").addEventListener("click", async ()=>{
    const u = $("userSelect").value;
    const p = $("pin").value;
    if (!u) return toast("Selecione o usuário.");
    if (!isValidPin(p)) return toast("PIN precisa ter 4 dígitos.");

    if (u !== "GERENTE" && !isEmployeeActive(u)){
      return toast("Usuário bloqueado. Fale com o gerente.");
    }

    const check = await verifyUserPin(u, p);
    if (check.noUser){
      await ensureUserPin(u, p);
      toast("PIN criado! Você já está logado.");
      doLogin(u);
      return;
    }
    if (!check.ok) return toast("PIN incorreto.");
    doLogin(u);
  });

  function doLogin(u){
    currentUser = u;
    $("pin").value = "";
    saveSession(u);

    if (u === "GERENTE"){
      renderManager();
      refreshCategoryEditorLists();
      // editor escala gerente
      renderEscalaEditor("escalaEditorGer", "btnSaveEscalaGer");
      show("gerente");
    } else {
      renderEmployee();
      maybeSetupEscalaUI();
      renderEscalaViewer();
      show("funcionario");
    }
  }

  function doLogout(){
    currentUser = "";
    clearSession();
    show("login");
  }
  $("btnLogout1").addEventListener("click", doLogout);
  $("btnLogout2").addEventListener("click", doLogout);

  // ===== Falta =====
  $("btnMissing").addEventListener("click", ()=> $("missingBox").classList.toggle("hidden"));
  $("missingSave").addEventListener("click", async ()=>{
    const raw = $("missingInput").value.trim();
    if (!raw) return toast("Digite o item em falta.");

    await addDoc(collection(db,"stores",STORE_ID,"missing"), {
      user: currentUser,
      item: raw,
      when: nowHuman(),
      weekKey: currentWeekKey,
      createdAt: serverTimestamp()
    });

    $("missingInput").value = "";
    $("missingBox").classList.add("hidden");
    toast("Registrado!");
  });

  // ===== Escala UI employee =====
  function maybeSetupEscalaUI(){
    $("weekKeyLabelEscala").innerText = currentWeekKey;

    const can = canEditEscala();
    $("escalaPermLabel").innerText = can ? "Você pode editar" : "Somente leitura";

    const editorWrap = $("escalaEditorWrap");
    if (can){
      editorWrap.classList.remove("hidden");
      renderEscalaEditor("escalaEditor", null);
      $("btnSaveEscala").onclick = async ()=>{
        // pega o estado atual recriando um local a partir do DOM? (mais simples: rebuild e salva)
        // Para não complicar: reconstruímos e salvamos pegando um clone da escala atual (recomendo editar e clicar salvar rápido).
        // Melhor: vamos pegar do editor de novo:
        const built = renderEscalaEditor("escalaEditor", null);
        await saveEscala(built);
      };
    } else {
      editorWrap.classList.add("hidden");
    }
  }

  // ===== Render Funcionário (GLOBAL + pessoais) =====
  function renderEmployee(){
    if (!isEmployeeActive(currentUser)){
      clearSession();
      currentUser = "";
      show("login");
      return;
    }

    $("userName").innerText = currentUser;
    $("score").innerText = scores[currentUser] || 0;
    $("weekKeyLabel").innerText = currentWeekKey;

    const container = $("tasks");
    container.innerHTML = "";

    // 1) GLOBAL aparece antes, se estiver open
    if (globalTask && globalTask.exists && globalTask.status === "open"){
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-xl shadow border-2 border-blue-200";

      const title = document.createElement("div");
      title.className = "flex items-center justify-between gap-2";
      title.innerHTML = `<h3 class="font-semibold">[GLOBAL] ${globalTask.name || "Tarefa Global"}</h3><span class="text-xs text-gray-500">+10 (primeiro que concluir)</span>`;
      card.appendChild(title);

      const body = document.createElement("div");
      body.className = "mt-3 space-y-2";

      const itens = Array.isArray(globalTask.items) ? globalTask.items : [];
      itens.forEach((item)=>{
        const row = document.createElement("div");
        row.className = "flex items-center justify-between gap-2";
        row.innerHTML =
          "<span class='text-sm text-gray-800'>" + item + "</span>" +
          "<input data-item='" + encodeURIComponent(item) + "' type='number' min='0' class='w-24 border rounded px-2 py-1 text-right' placeholder='Qtd'>";
        body.appendChild(row);
      });

      const warn = document.createElement("p");
      warn.className = "text-xs text-gray-500 mt-2";
      warn.innerText = "Para concluir, nenhum campo pode ficar vazio (se for zero, digite 0).";
      body.appendChild(warn);

      const btn = document.createElement("button");
      btn.className = "mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded";
      btn.innerText = "Concluir GLOBAL";

      btn.addEventListener("click", async ()=>{
        const itensQtd = {};
        const inputs = Array.from(body.querySelectorAll("input[type=number]"));
        for (const inp of inputs){
          const name = decodeURIComponent(inp.getAttribute("data-item"));
          if (inp.value === ""){
            toast("Preencha todos os itens. Se for zero, digite 0.");
            inp.focus();
            return;
          }
          const val = Number(inp.value);
          itensQtd[name] = Number.isFinite(val) ? val : 0;
        }

        btn.disabled = true;
        btn.classList.add("opacity-50");
        btn.innerText = "Tentando concluir...";

        try{
          await completeGlobalTaskAsFirst(currentUser, itensQtd, []);
          toast("Você concluiu a GLOBAL primeiro!");
        } catch(e){
          console.error(e);
          toast("GLOBAL já foi concluída por outra pessoa.");
        } finally {
          btn.disabled = true;
          btn.innerText = "Encerrada";
        }
      });

      card.appendChild(body);
      card.appendChild(btn);
      container.appendChild(card);
    }

    // 2) Categorias pessoais (ordenadas)
    const cats = data[currentUser] || {};
    const catNames = Object.keys(cats).sort((a,b)=>a.localeCompare(b));
    if (!catNames.length){
      const box = document.createElement("div");
      box.className = "bg-white p-4 rounded-xl shadow text-gray-600";
      box.innerText = "Sem categorias para este usuário.";
      container.appendChild(box);
      return;
    }

    catNames.forEach((cat, catIndex)=>{
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-xl shadow";

      const isArmarios = cat.toLowerCase().includes("armarios");
      const done = isCategoryDoneThisWeek(currentUser, cat);

      const title = document.createElement("div");
      title.className = "flex items-center justify-between gap-2";
      title.innerHTML = "<h3 class='font-semibold'>" + cat + "</h3><span class='text-xs text-gray-500'>+10</span>";
      card.appendChild(title);

      const body = document.createElement("div");
      body.className = "mt-3 space-y-2";
      const itens = cats[cat] || [];
      let fileInput = null;

      if (isArmarios){
        const inputId = `arm_files_${catIndex}`;
        body.innerHTML =
          "<p class='text-sm text-gray-700'>Envie fotos dos armários (armário inteiro, em cima e em baixo).</p>" +
          `<input id="${inputId}" type="file" accept="image/*" capture="environment" multiple class="w-full border rounded p-2 bg-white">` +
          "<p class='text-xs text-gray-500'>As fotos serão salvas no Firebase Storage.</p>";
        fileInput = () => document.getElementById(inputId);
      } else {
        itens.forEach((item)=>{
          const row = document.createElement("div");
          row.className = "flex items-center justify-between gap-2";
          row.innerHTML =
            "<span class='text-sm text-gray-800'>" + item + "</span>" +
            "<input data-item='" + encodeURIComponent(item) + "' type='number' min='0' class='w-24 border rounded px-2 py-1 text-right' placeholder='Qtd'>";
          body.appendChild(row);
        });
        const warn = document.createElement("p");
        warn.className = "text-xs text-gray-500 mt-2";
        warn.innerText = "Para concluir, nenhum campo pode ficar vazio (se for zero, digite 0).";
        body.appendChild(warn);
      }

      const btn = document.createElement("button");
      btn.className = "mt-4 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded";
      btn.innerText = done ? "Concluído (semana)" : "Concluir";
      btn.disabled = done;
      if (done) btn.classList.add("opacity-50");

      btn.addEventListener("click", async ()=>{
        if (btn.disabled) return;

        const itensQtd = {};
        if (!isArmarios){
          const inputs = Array.from(body.querySelectorAll("input[type=number]"));
          for (const inp of inputs){
            const name = decodeURIComponent(inp.getAttribute("data-item"));
            if (inp.value === ""){
              toast("Preencha todos os itens. Se for zero, digite 0.");
              inp.focus();
              return;
            }
            const val = Number(inp.value);
            itensQtd[name] = Number.isFinite(val) ? val : 0;
          }
        } else {
          const fi = fileInput ? fileInput() : null;
          if (!fi || !fi.files || fi.files.length === 0){
            toast("Envie pelo menos 1 foto para concluir Armários.");
            return;
          }
        }

        if (isCategoryDoneThisWeek(currentUser, cat)){
          toast("Essa categoria já foi concluída nesta semana.");
          renderEmployee();
          return;
        }

        btn.disabled = true;
        btn.classList.add("opacity-50");
        btn.innerText = "Salvando...";

        try{
          let photos = [];
          if (isArmarios){
            const files = Array.from(fileInput().files || []);
            photos = await uploadArmariosPhotos(files, currentUser, cat);
          }

          await addDoc(collection(db,"stores",STORE_ID,"tasks"), {
            user: currentUser,
            categoria: cat,
            itens: itensQtd,
            photos,
            when: nowHuman(),
            weekKey: currentWeekKey,
            createdAt: serverTimestamp()
          });

          await bumpScore(currentUser, 10);
          btn.innerText = "Concluído";
          toast("Concluído!");
        } catch(e){
          console.error(e);
          toast("Erro ao salvar. Verifique a internet e tente novamente.");
          btn.disabled = false;
          btn.classList.remove("opacity-50");
          btn.innerText = "Concluir";
        }
      });

      card.appendChild(body);
      card.appendChild(btn);
      container.appendChild(card);
    });
  }

  // ===== Render Gerente =====
  function renderManager(){
    $("weekKeyLabelGer").innerText = currentWeekKey;

    // status global
    if ($("globalStatus")){
      $("globalStatus").innerText = getGlobalStatusText();
    }

    // tarefas com detalhes
    const t = $("gerTasks");
    t.innerHTML = "";
    const ordered = tasksDone.slice(0, 300);

    if (!ordered.length){
      t.innerHTML = "<p class='text-gray-500'>Nenhuma tarefa nesta semana.</p>";
    } else {
      ordered.forEach((r)=>{
        const itensObj = r.itens || {};
        const itensKeys = Object.keys(itensObj).sort((a,b)=>a.localeCompare(b));
        const hasItens = itensKeys.length > 0;

        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-gray-50";

        let html = `
          <div class="font-semibold">${r.user} - ${r.categoria}</div>
          <div class="text-xs text-gray-600">${(r.when || "")}</div>
        `;

        if (hasItens){
          html += `<div class="mt-2 bg-white rounded p-2 border">`;
          itensKeys.forEach((k)=>{
            const q = itensObj[k];
            html += `
              <div class="flex items-center justify-between gap-2 border-b last:border-b-0 py-1">
                <div class="text-sm text-gray-800">${k}</div>
                <div class="text-sm font-semibold">Qtd ${q}</div>
              </div>
            `;
          });
          html += `</div>`;
        }

        if (Array.isArray(r.photos) && r.photos.length){
          html += `
            <div class="mt-2 text-xs text-gray-700">
              Fotos: <span class="font-semibold">${r.photos.length}</span>
              <div class="mt-1 flex flex-wrap gap-2">
                ${r.photos.map((url, i)=>`<a class="text-blue-700 underline" target="_blank" href="${url}">Foto ${i+1}</a>`).join("")}
              </div>
            </div>
          `;
        }

        div.innerHTML = html;
        t.appendChild(div);
      });
    }

    // faltas
    const m = $("gerMissing");
    m.innerHTML = "";
    const mo = missingReports.slice(0, 250);
    if (!mo.length){
      m.innerHTML = "<p class='text-gray-500'>Nenhuma falta nesta semana.</p>";
    } else {
      mo.forEach((r)=>{
        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-gray-50";
        div.innerHTML =
          "<div class='font-semibold'>" + r.user + "</div>" +
          "<div class='text-xs text-gray-600'>" + (r.when || "") + "</div>" +
          "<div class='text-sm mt-1'>" + r.item + "</div>";
        m.appendChild(div);
      });
    }
  }

  // ===== GLOBAL: gerente cria =====
  $("btnCreateGlobal").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const name = normalizeCat($("globalCatName").value);
    const items = $("globalCatItems").value.trim();
    if (!name) return toast("Digite o nome da GLOBAL.");
    const arr = items ? items.split(",").map(s=>s.trim()).filter(Boolean) : [];
    if (!arr.length) return toast("Informe pelo menos 1 item.");
    await createGlobalTask(name, arr);
    $("globalCatName").value = "";
    $("globalCatItems").value = "";
    toast("GLOBAL criada.");
  });

  // ===== Apagar tarefas por funcionário =====
  $("btnLoadUserTasks").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("delTasksUser").value;
    if (!u) return toast("Selecione um funcionário.");
    renderUserTasksForDelete(u);
  });

  function renderUserTasksForDelete(user){
    const box = $("userTasksList");
    box.innerHTML = "";

    const list = tasksDone
      .filter(t=>t.user === user)
      .slice()
      .sort((a,b)=>(String(b.when||"").localeCompare(String(a.when||""))));

    if (!list.length){
      box.innerHTML = `<div class="text-sm text-gray-500">Nenhuma tarefa na semana para ${user}.</div>`;
      return;
    }

    list.forEach((t)=>{
      const row = document.createElement("div");
      row.className = "border rounded p-2 bg-gray-50 flex items-start gap-2";

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "mt-1";
      chk.dataset.id = t.id;

      const info = document.createElement("div");
      info.className = "flex-1";
      info.innerHTML = `
        <div class="font-semibold">${t.categoria}</div>
        <div class="text-xs text-gray-600">${t.when || ""}</div>
      `;

      row.appendChild(chk);
      row.appendChild(info);
      box.appendChild(row);
    });
  }

  $("btnDeleteSelectedTasks").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("delTasksUser").value;
    if (!u) return toast("Selecione um funcionário.");

    const checks = Array.from($("userTasksList").querySelectorAll("input[type=checkbox]:checked"));
    if (!checks.length) return toast("Marque pelo menos 1 tarefa.");

    if (!confirm(`Apagar ${checks.length} tarefa(s) de ${u}?`)) return;

    try{
      // batch delete
      let batch = writeBatch(db);
      let count = 0;
      for (const c of checks){
        const id = c.dataset.id;
        if (!id) continue;
        const ref = doc(db,"stores",STORE_ID,"tasks",id);
        batch.delete(ref);
        count++;
        if (count % 450 === 0){
          await batch.commit();
          batch = writeBatch(db);
        }
      }
      await batch.commit();
      toast("Tarefas apagadas.");
      renderUserTasksForDelete(u);
    } catch(e){
      console.error(e);
      toast("Erro ao apagar tarefas.");
    }
  });

  // ===== Reset semana (tudo) =====
  $("btnResetWeek").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    if (!confirm("ATENÇÃO: Apaga tarefas e faltas da semana atual e zera pontuações. Confirmar?")) return;

    try{
      await deleteByWeek("tasks", currentWeekKey);
      await deleteByWeek("missing", currentWeekKey);
      await setDoc(scoresRef(), { scores: {}, updatedAt: serverTimestamp() }, { merge:true });

      // também apaga GLOBAL e Escala da semana
      try{ await deleteDoc(globalRef(currentWeekKey)); }catch(e){}
      try{ await deleteDoc(escalaRef(currentWeekKey)); }catch(e){}

      toast("Semana zerada.");
    } catch(e){
      console.error(e);
      toast("Erro ao zerar semana.");
    }
  });

  async function deleteByWeek(colName, wk){
    const colRef = collection(db, "stores", STORE_ID, colName);
    const q = query(colRef, where("weekKey","==",wk), limit(450));
    const snap = await getDocs(q);
    if (snap.empty) return;

    let batch = writeBatch(db);
    let count = 0;
    for (const d of snap.docs){
      batch.delete(d.ref);
      count++;
      if (count % 450 === 0){
        await batch.commit();
        batch = writeBatch(db);
      }
    }
    await batch.commit();
    if (snap.docs.length === 450) await deleteByWeek(colName, wk);
  }

  // ===== Export CSV =====
  $("btnExport").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente exporta.");

    const header = ["tipo","usuario","categoria","quando","detalhes","fotos"];
    let csv = header.join(",") + "\n";

    tasksDone.forEach((r)=>{
      csv += ["tarefa", r.user, r.categoria, r.when, JSON.stringify(r.itens || {}), JSON.stringify(r.photos || [])].map(csvCell).join(",") + "\n";
    });
    missingReports.forEach((r)=>{
      csv += ["falta", r.user, "", r.when, JSON.stringify({ item: r.item }), ""].map(csvCell).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "relatorio_" + currentWeekKey + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  function csvCell(v){
    const s = String(v == null ? "" : v);
    if (/[\n\r,"]/g.test(s)) return '"' + s.replaceAll('"', '""') + '"';
    return s;
  }

  // ===== Categorias CRUD (individual) =====
  function refreshCategoryEditorLists(){
    const u = $("editUser")?.value || allNames()[0] || "";
    const sel = $("editCatSelect");
    if (!sel) return;

    sel.innerHTML = `<option value="">Selecione uma categoria...</option>`;
    const cats = (data[u] && typeof data[u] === "object") ? Object.keys(data[u]) : [];
    cats.sort((a,b)=>a.localeCompare(b));
    for (const c of cats){
      sel.appendChild(new Option(c, c));
    }
    $("editCatName").value = "";
    $("editItemsArea").value = "";
  }
  $("editUser").addEventListener("change", refreshCategoryEditorLists);

  $("btnAddCategory").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("addUser").value;
    const cat = normalizeCat($("categoriaNome").value);
    const items = $("itensCategoria").value.trim();
    if (!u) return toast("Selecione o funcionário.");
    if (!cat) return toast("Informe o nome da categoria");

    const newData = clone(data || {});
    if (!newData[u]) newData[u] = {};
    newData[u][cat] = items ? items.split(",").map(s=>s.trim()).filter(Boolean) : [];

    await setDoc(cfgCatsRef(), { data: newData, updatedAt: serverTimestamp() }, { merge:false });
    $("categoriaNome").value = "";
    $("itensCategoria").value = "";
    toast("Categoria atualizada.");
  });

  $("btnLoadCategory").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("editUser").value;
    const c = $("editCatSelect").value;
    if (!u) return toast("Selecione o funcionário.");
    if (!c) return toast("Selecione uma categoria.");

    const items = (data[u] && data[u][c]) ? data[u][c] : [];
    $("editCatName").value = c;
    $("editItemsArea").value = (items || []).join(", ");
    toast("Categoria carregada.");
  });

  $("btnSaveCategory").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("editUser").value;
    const c = $("editCatSelect").value;
    if (!u) return toast("Selecione o funcionário.");
    if (!c) return toast("Selecione uma categoria.");

    const raw = $("editItemsArea").value.trim();
    const newItems = raw ? raw.split(",").map(s=>s.trim()).filter(Boolean) : [];

    const newData = clone(data || {});
    if (!newData[u]) newData[u] = {};
    if (!newData[u][c]) return toast("Categoria não existe mais.");

    newData[u][c] = newItems;
    await setDoc(cfgCatsRef(), { data: newData, updatedAt: serverTimestamp() }, { merge:false });
    toast("Itens atualizados.");
  });

  $("btnRenameCategory").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("editUser").value;
    const oldName = $("editCatSelect").value;
    const newName = normalizeCat($("editCatName").value);
    if (!u) return toast("Selecione o funcionário.");
    if (!oldName) return toast("Selecione uma categoria.");
    if (!newName) return toast("Digite o novo nome.");
    if (newName === oldName) return toast("O novo nome é igual.");

    if (!confirm(`Renomear "${oldName}" para "${newName}"?`)) return;

    const newData = clone(data || {});
    if (!newData[u] || !newData[u][oldName]) return toast("Categoria não existe.");
    if (newData[u][newName]) return toast("Já existe categoria com esse nome.");

    newData[u][newName] = newData[u][oldName];
    delete newData[u][oldName];

    await setDoc(cfgCatsRef(), { data: newData, updatedAt: serverTimestamp() }, { merge:false });

    toast("Categoria renomeada.");
    refreshCategoryEditorLists();
    $("editCatSelect").value = newName;
    $("editCatName").value = newName;
    $("editItemsArea").value = (newData[u][newName] || []).join(", ");
  });

  $("btnDeleteCategory").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("editUser").value;
    const c = $("editCatSelect").value;
    if (!u) return toast("Selecione o funcionário.");
    if (!c) return toast("Selecione uma categoria.");
    if (!confirm(`Excluir a categoria "${c}" do usuário ${u}?`)) return;

    const newData = clone(data || {});
    if (!newData[u] || !newData[u][c]) return toast("Categoria não existe.");
    delete newData[u][c];

    await setDoc(cfgCatsRef(), { data: newData, updatedAt: serverTimestamp() }, { merge:false });

    toast("Categoria excluída.");
    refreshCategoryEditorLists();
  });

  // ===== PIN reset =====
  $("btnSetPin").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("pinUser").value;
    const p = $("pinNew").value.trim();
    if (!u) return toast("Selecione o usuário.");
    if (!isValidPin(p)) return toast("Novo PIN precisa ter 4 dígitos.");

    await setDoc(userRef(u), {
      user: u,
      role: (u === "GERENTE") ? "manager" : "employee",
      pinHash: await sha256(p),
      updatedAt: serverTimestamp()
    }, { merge:true });

    $("pinNew").value = "";
    toast("PIN definido.");
  });

  // ===== Funcionários UI actions =====
  $("btnAddEmployee").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const name = $("newEmployeeName").value;
    $("newEmployeeName").value = "";
    try{ await addEmployee(name); }catch(e){ console.error(e); toast("Erro ao adicionar funcionário."); }
  });

  $("btnRefreshEmployees").addEventListener("click", ()=>{
    renderEmployeesUI();
    refreshCategoryEditorLists();
    toast("Lista recarregada.");
  });

  // ===== Start =====
  await cloudInit();

  // Status global inicial no gerente
  if ($("globalStatus")) $("globalStatus").innerText = getGlobalStatusText();

  const ses = getSession();
  if (ses && ses.user){
    currentUser = ses.user;

    if (currentUser === "GERENTE"){
      renderManager();
      refreshCategoryEditorLists();
      renderEscalaEditor("escalaEditorGer", "btnSaveEscalaGer");
      show("gerente");
    } else {
      if (!isEmployeeActive(currentUser)){
        clearSession();
        currentUser = "";
        show("login");
      } else {
        renderEmployee();
        maybeSetupEscalaUI();
        renderEscalaViewer();
        show("funcionario");
      }
    }
  } else {
    show("login");
  }

  console.log("BUILD OK");
  window.__BUILD_OK__ = true;
</script>

</body>
</html>
