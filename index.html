<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missoes da Loja</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<header class="max-w-3xl mx-auto mb-4">
  <h1 class="text-2xl font-bold text-center">Missoes da Loja</h1>
  <p class="text-center text-sm text-gray-600 mt-1">
    Login por PIN - Checklist com quantidades - Falta de produto - Gerente em tempo real (Firestore)
  </p>
</header>

<!-- LOGIN -->
<section id="login" class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow">
  <h2 class="text-lg font-semibold mb-3">Entrar</h2>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">Usuario</label>
      <select id="userSelect" class="w-full border p-2 rounded">
        <option value="">Selecione</option>
        <option value="GERENTE">Gerente</option>
        <option value="Sandra">Sandra</option>
        <option value="Thauane">Thauane</option>
        <option value="Ingrid">Ingrid</option>
        <option value="Claudia">Claudia</option>
        <option value="DADA">DADA</option>
      </select>
    </div>

    <div class="md:col-span-1">
      <label class="text-sm text-gray-700">PIN (4 digitos)</label>
      <input id="pin" inputmode="numeric" maxlength="4" placeholder="1234"
             class="w-full border p-2 rounded" />
    </div>

    <div class="md:col-span-1 flex items-end">
      <button id="btnLogin"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">
        Entrar
      </button>
    </div>
  </div>

  <div class="mt-4 border-t pt-4">
    <h3 class="font-semibold mb-2">Fotos (Armarios) - Google Drive (opcional)</h3>
    <p class="text-sm text-gray-700 mb-3">
      Se quiser salvar fotos no Drive, conecte. Se nao conectar, o app continua no Firestore, so nao envia fotos.
    </p>

    <div class="flex flex-col md:flex-row gap-2">
      <button id="btnDriveConnect" class="bg-gray-900 hover:bg-black text-white p-2 rounded">
        Conectar Google Drive
      </button>
      <button id="btnDriveStatus" class="bg-gray-200 text-gray-900 p-2 rounded" disabled>
        Drive: desconectado
      </button>
    </div>
  </div>
</section>

<!-- FUNCIONARIA -->
<section id="funcionario" class="hidden max-w-3xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Usuario: <span id="userName"></span></h2>
        <p class="text-sm text-gray-700">Pontuacao: <span id="score">0</span></p>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabel">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnMissing" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Cliente pediu e nao tem
        </button>
        <button id="btnLogout1" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>

    <div id="missingBox" class="hidden mt-4 border-t pt-4">
      <label class="text-sm text-gray-700">O que o cliente pediu e nao temos?</label>
      <div class="flex gap-2 mt-2">
        <input id="missingInput" class="flex-1 border rounded p-2" placeholder="Digite o item em falta" />
        <button id="missingSave" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <div id="tasks" class="space-y-4"></div>
</section>

<!-- GERENTE -->
<section id="gerente" class="hidden max-w-4xl mx-auto">
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold">Painel do Gerente</h2>
        <p class="text-xs text-gray-500">Semana: <span id="weekKeyLabelGer">-</span></p>
      </div>
      <div class="flex gap-2">
        <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded">
          Exportar CSV
        </button>
        <button id="btnLogout2" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-3 py-2 rounded">
          Sair
        </button>
      </div>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Tarefas concluidas (semana)</h3>
      <div id="gerTasks" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="font-semibold mb-2">Itens em falta</h3>
      <div id="gerMissing" class="text-sm space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow mt-4">
    <h3 class="font-semibold mb-2">Gerenciar categorias</h3>
    <div class="grid md:grid-cols-4 gap-2">
      <select id="addUser" class="border p-2 rounded">
        <option>Sandra</option>
        <option>Thauane</option>
        <option>Ingrid</option>
        <option>Claudia</option>
        <option>DADA</option>
      </select>
      <input id="categoriaNome" placeholder="Nome da categoria" class="border p-2 rounded" />
      <input id="itensCategoria" placeholder="Itens separados por virgula" class="border p-2 rounded md:col-span-2" />
    </div>
    <button id="btnAddCategory" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded w-full">
      Adicionar / Atualizar categoria
    </button>
    <p class="text-xs text-gray-500 mt-2">
      Para categoria ARMARIOS, deixe itens vazio para liberar upload de fotos.
    </p>
  </div>
</section>

<script type="module">
  // Firebase config (seu)
  const firebaseConfig = {
    apiKey: "AIzaSyDsWJ9VVMSIsQNtifkLVnRNnbzU7favF7s",
    authDomain: "missoes-drive.firebaseapp.com",
    projectId: "missoes-drive",
    storageBucket: "missoes-drive.firebasestorage.app",
    messagingSenderId: "198254465545",
    appId: "1:198254465545:web:dce028792e2c2c57161ed8"
  };

  const STORE_ID = "loja_principal";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    onSnapshot, query, orderBy, limit, serverTimestamp, increment
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Drive (opcional)
  const GOOGLE_CLIENT_ID = "198254465545-c7r3noc9vtiiabqltbfrco08f44ci0ls.apps.googleusercontent.com";
  const DRIVE_ROOT_FOLDER_NAME = "Missoes da Loja";

  // PINS
  window.pins = {
    GERENTE: "1234",
    Sandra: "1111",
    Thauane: "2222",
    Ingrid: "3333",
    Claudia: "4444",
    DADA: "5555"
  };
  const pins = window.pins;

  // Clone simples (evita structuredClone em aparelhos antigos)
  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  // Missoes padrao
  const defaultData = {
    Sandra: {
      "Pedido Itaipava (Segunda)": ["IT Guarana","Ita Laranja","IT Limao","IT Lemon Ice","IT Cola","Latao Lokal"]
    },
    Thauane: {
      "Ambev (Segunda)": [
        "Cracudinha (cascos vazios completos)",
        "Guarana Antarctica fora da geladeira",
        "Sukita fora da geladeira",
        "Guaraviton",
        "Gatorade",
        "Suco Tang - Laranja",
        "Suco Tang - Morango",
        "Suco Tang - Guarana",
        "Suco Tang - Uva",
        "Suco Tang - Limao",
        "Suco Tang - Maracuja",
        "Guaravita",
        "Agua com gas 500ml",
        "Agua com gas 1,5L",
        "Agua sem gas 500ml",
        "Agua sem gas 1,5L",
        "Corona long",
        "Stella long"
      ],
      "Coca-Cola (Retornaveis e Packs)": [
        "Retornavel vazia completa",
        "KS vazia completa",
        "Packs completos de Coca-Cola 2L",
        "Pack completo de Fanta Uva",
        "Pack completo de Fanta Laranja",
        "Guarana latinha (Coca)",
        "Garrafinha de Coca 200ml",
        "Garrafinha de Fanta 200ml"
      ]
    },
    Ingrid: {
      "Jardim America": ["Antarctica latao","Brahma latao","Imperio latao","Heineken latao","Heineken long"],
      "Fotos (Check)": [
        "Foto de todas as estantes arrumadas e abastecidas",
        "Foto dos biscoitos",
        "Foto das reservas",
        "Foto dos doces",
        "Foto do freezer com barras de chocolate"
      ],
      "Armarios (Fotos obrigatorias)": []
    },
    Claudia: {
      "Sadia (Segunda)": ["Mortadela comum","Mortadela defumada","Presunto","Calabresa","Salsicha","Hamburguer"],
      "Queijos": ["Queijo prato","Queijo mussarela","Queijo minas","Minas padrao"]
    },
    DADA: {
      "Mineirinho (Terca)": ["Mineirinho 2L","Mineirinho 350ml"]
    }
  };

  // Estado
  let data = clone(defaultData);
  let scores = {};
  let tasksDone = [];
  let missingReports = [];
  let currentUser = "";
  let currentWeekKey = "";

  // Helpers UI
  const $ = (id) => document.getElementById(id);
  function toast(msg){ alert(msg); }
  function show(section){
    ["login","funcionario","gerente"].forEach(s => $(s).classList.add("hidden"));
    $(section).classList.remove("hidden");
  }

  function isValidPin(p){ return /^[0-9]{4}$/.test(String(p || "")); }

  function nowHuman(){ return new Date().toLocaleString(); }

  // Semana ISO (reset segunda)
  function weekKey(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return d.getUTCFullYear() + "-W" + String(weekNo).padStart(2,"0");
  }

  async function ensureWeekKey(){
    const metaRef = doc(db,"stores",STORE_ID,"meta","app");
    const snap = await getDoc(metaRef);
    const today = new Date();
    const wk = weekKey(today);

    if (!snap.exists()){
      await setDoc(metaRef,{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    const saved = snap.data().currentWeekKey || wk;
    if (today.getDay() === 1 && saved !== wk){
      await setDoc(metaRef,{ currentWeekKey: wk, updatedAt: serverTimestamp() },{ merge:true });
      currentWeekKey = wk;
      return;
    }

    currentWeekKey = saved;
  }

  async function cloudInit(){
    await ensureWeekKey();
    $("weekKeyLabel").innerText = currentWeekKey;
    $("weekKeyLabelGer").innerText = currentWeekKey;

    const cfgRef = doc(db,"stores",STORE_ID,"config","categories");
    const cfgSnap = await getDoc(cfgRef);
    if (!cfgSnap.exists()){
      await setDoc(cfgRef,{ data: defaultData, updatedAt: serverTimestamp() },{ merge:true });
      data = clone(defaultData);
    } else {
      const remote = cfgSnap.data().data;
      data = (remote && typeof remote === "object") ? remote : clone(defaultData);
    }

    onSnapshot(cfgRef,(snap)=>{
      const remote = snap.data().data;
      if (remote && typeof remote === "object"){
        data = remote;
        if (currentUser && currentUser !== "GERENTE") renderEmployee();
      }
    });

    const scoresRef = doc(db,"stores",STORE_ID,"state","scores");
    const sSnap = await getDoc(scoresRef);
    if (!sSnap.exists()) await setDoc(scoresRef,{ scores: {}, updatedAt: serverTimestamp() },{ merge:true });

    onSnapshot(scoresRef,(snap)=>{
      scores = snap.data().scores || {};
      if (currentUser && currentUser !== "GERENTE"){
        $("score").innerText = scores[currentUser] || 0;
      }
    });

    const tasksQ = query(collection(db,"stores",STORE_ID,"tasks"), orderBy("createdAt","desc"), limit(400));
    onSnapshot(tasksQ,(qs)=>{
      const all = qs.docs.map(d => d.data());
      tasksDone = all.filter(x => x.weekKey === currentWeekKey);
      if (currentUser === "GERENTE") renderManager();
    });

    const missQ = query(collection(db,"stores",STORE_ID,"missing"), orderBy("createdAt","desc"), limit(400));
    onSnapshot(missQ,(qs)=>{
      const all = qs.docs.map(d => d.data());
      missingReports = all.filter(x => x.weekKey === currentWeekKey);
      if (currentUser === "GERENTE") renderManager();
    });
  }

  async function bumpScore(user, delta){
    const scoresRef = doc(db,"stores",STORE_ID,"state","scores");
    await updateDoc(scoresRef, { ["scores."+user]: increment(delta), updatedAt: serverTimestamp() });
  }

  // LOGIN
  $("btnLogin").addEventListener("click", ()=>{
    const u = $("userSelect").value;
    const p = $("pin").value;
    if (!u) return toast("Selecione o usuario.");
    if (!isValidPin(p)) return toast("PIN precisa ter 4 digitos.");

    const expected = (u === "GERENTE") ? pins.GERENTE : pins[u];
    if (!expected) return toast("Usuario sem PIN.");
    if (p !== expected) return toast("PIN incorreto.");

    currentUser = u;
    $("pin").value = "";

    if (u === "GERENTE"){
      renderManager();
      show("gerente");
    } else {
      renderEmployee();
      show("funcionario");
    }
  });

  $("btnLogout1").addEventListener("click", ()=>{ currentUser=""; show("login"); });
  $("btnLogout2").addEventListener("click", ()=>{ currentUser=""; show("login"); });

  // FALTA
  $("btnMissing").addEventListener("click", ()=>{
    $("missingBox").classList.toggle("hidden");
  });

  $("missingSave").addEventListener("click", async ()=>{
    const raw = $("missingInput").value.trim();
    if (!raw) return toast("Digite o item em falta.");

    await addDoc(collection(db,"stores",STORE_ID,"missing"), {
      user: currentUser,
      item: raw,
      when: nowHuman(),
      weekKey: currentWeekKey,
      createdAt: serverTimestamp()
    });

    $("missingInput").value = "";
    $("missingBox").classList.add("hidden");
    toast("Registrado!");
  });

  // RENDER FUNCIONARIA
  function renderEmployee(){
    $("userName").innerText = currentUser;
    $("score").innerText = scores[currentUser] || 0;
    $("weekKeyLabel").innerText = currentWeekKey;

    $("missingBox").classList.add("hidden");
    $("missingInput").value = "";

    const container = $("tasks");
    container.innerHTML = "";

    const cats = data[currentUser] || {};
    const catNames = Object.keys(cats);

    if (!catNames.length){
      container.innerHTML = "<div class='bg-white p-4 rounded-xl shadow text-gray-600'>Sem categorias para este usuario.</div>";
      return;
    }

    catNames.forEach((cat)=>{
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-xl shadow";

      const isArmarios = cat.toLowerCase().indexOf("armarios") >= 0;

      const title = document.createElement("div");
      title.className = "flex items-center justify-between gap-2";
      title.innerHTML = "<h3 class='font-semibold'>" + cat + "</h3><span class='text-xs text-gray-500'>+10</span>";
      card.appendChild(title);

      const body = document.createElement("div");
      body.className = "mt-3 space-y-2";

      const itens = cats[cat] || [];

      if (isArmarios){
        body.innerHTML =
          "<p class='text-sm text-gray-700'>Envie fotos dos armarios (armario inteiro, em cima e em baixo).</p>" +
          "<input type='file' accept='image/*' capture='environment' multiple class='w-full border rounded p-2 bg-white'>" +
          "<p class='text-xs text-gray-500'>Fotos vao para o Drive (se conectado).</p>";
      } else {
        itens.forEach((item)=>{
          const row = document.createElement("div");
          row.className = "flex items-center justify-between gap-2";
          row.innerHTML =
            "<span class='text-sm text-gray-800'>" + item + "</span>" +
            "<input data-item='" + encodeURIComponent(item) + "' type='number' min='0' class='w-24 border rounded px-2 py-1 text-right' placeholder='Qtd'>";
          body.appendChild(row);
        });
      }

      const btn = document.createElement("button");
      btn.className = "mt-4 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded";
      btn.innerText = "Concluir";

      btn.addEventListener("click", async ()=>{
        const itensQtd = {};
        if (!isArmarios){
          body.querySelectorAll("input[type=number]").forEach((inp)=>{
            const name = decodeURIComponent(inp.getAttribute("data-item"));
            const val = inp.value === "" ? 0 : Number(inp.value);
            itensQtd[name] = Number.isFinite(val) ? val : 0;
          });
        }

        await addDoc(collection(db,"stores",STORE_ID,"tasks"), {
          user: currentUser,
          categoria: cat,
          itens: itensQtd,
          when: nowHuman(),
          weekKey: currentWeekKey,
          createdAt: serverTimestamp()
        });

        await bumpScore(currentUser, 10);

        btn.disabled = true;
        btn.classList.add("opacity-50");
        btn.innerText = "Concluido";
      });

      card.appendChild(body);
      card.appendChild(btn);
      container.appendChild(card);
    });
  }

  // RENDER GERENTE
  function renderManager(){
    $("weekKeyLabelGer").innerText = currentWeekKey;

    const t = $("gerTasks");
    t.innerHTML = "";
    const ordered = tasksDone.slice(0, 250);
    if (!ordered.length){
      t.innerHTML = "<p class='text-gray-500'>Nenhuma tarefa nesta semana.</p>";
    } else {
      ordered.forEach((r)=>{
        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-gray-50";
        div.innerHTML =
          "<div class='font-semibold'>" + r.user + " - " + r.categoria + "</div>" +
          "<div class='text-xs text-gray-600'>" + (r.when || "") + "</div>";
        t.appendChild(div);
      });
    }

    const m = $("gerMissing");
    m.innerHTML = "";
    const mo = missingReports.slice(0, 250);
    if (!mo.length){
      m.innerHTML = "<p class='text-gray-500'>Nenhuma falta nesta semana.</p>";
    } else {
      mo.forEach((r)=>{
        const div = document.createElement("div");
        div.className = "border rounded p-2 bg-gray-50";
        div.innerHTML =
          "<div class='font-semibold'>" + r.user + "</div>" +
          "<div class='text-xs text-gray-600'>" + (r.when || "") + "</div>" +
          "<div class='text-sm mt-1'>" + r.item + "</div>";
        m.appendChild(div);
      });
    }
  }

  // GERENTE: adicionar categoria
  $("btnAddCategory").addEventListener("click", async ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente.");
    const u = $("addUser").value;
    const cat = $("categoriaNome").value.trim();
    const items = $("itensCategoria").value.trim();
    if (!cat) return toast("Informe o nome da categoria");

    const newData = clone(data);
    if (!newData[u]) newData[u] = {};
    newData[u][cat] = items ? items.split(",").map(s => s.trim()).filter(Boolean) : [];

    const cfgRef = doc(db,"stores",STORE_ID,"config","categories");
    await setDoc(cfgRef, { data: newData, updatedAt: serverTimestamp() }, { merge:true });

    $("categoriaNome").value = "";
    $("itensCategoria").value = "";
    toast("Categoria atualizada.");
  });

  // CSV
  $("btnExport").addEventListener("click", ()=>{
    if (currentUser !== "GERENTE") return toast("Apenas o gerente exporta.");
    const header = ["tipo","usuario","categoria","quando","detalhes"];
    let csv = header.join(",") + "\n";

    tasksDone.forEach((r)=>{
      csv += ["tarefa", r.user, r.categoria, r.when, JSON.stringify(r.itens || {})].map(csvCell).join(",") + "\n";
    });
    missingReports.forEach((r)=>{
      csv += ["falta", r.user, "", r.when, JSON.stringify({ item: r.item })].map(csvCell).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "relatorio_" + currentWeekKey + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  function csvCell(v){
    const s = String(v == null ? "" : v);
    if (/[\n\r,"]/g.test(s)) return '"' + s.replaceAll('"', '""') + '"';
    return s;
  }

  // Drive - deixei desligado por enquanto (nao interfere no Firestore)
  let driveToken = null;
  function setDriveStatus(ok){
    $("btnDriveStatus").disabled = false;
    $("btnDriveStatus").innerText = ok ? "Drive: conectado" : "Drive: desconectado";
  }
  setDriveStatus(false);

  $("btnDriveConnect").addEventListener("click", ()=>{
    toast("Drive opcional ainda nao ativado nesta versao. O Firestore ja funciona normalmente.");
  });

  await cloudInit();
  console.log("BUILD OK");
  window.__BUILD_OK__ = true;
</script>

</body>
</html>
